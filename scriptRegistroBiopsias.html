<script>
  // ================== INICIALIZACI√ìN Y CONFIGURACI√ìN ==================
  document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ Inicializando formulario de registro de biopsias...');

    // Establecer la fecha actual por defecto
    establecerFechaActual();

    // Configurar validaciones en tiempo real
    configurarValidacionesEnTiempoReal();

    // Configurar contador de caracteres
    configurarContadorCaracteres();

    // Configurar c√°lculo autom√°tico de frascos
    configurarCalculoFrascos();

    // Cargar lista de m√©dicos
    cargarListaMedicos();

    mostrarMensaje("‚úÖ Formulario listo para registrar biopsias", "success");
  });

  // ================== CONFIGURACI√ìN INICIAL ==================
  function establecerFechaActual() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');

    document.getElementById('fecha_toma').value = `${yyyy}-${mm}-${dd}`;
    console.log('üìÖ Fecha actual establecida:', `${yyyy}-${mm}-${dd}`);
  }

  function cargarListaMedicos() {
    console.log('üë®‚Äç‚öïÔ∏è Cargando lista de m√©dicos...');

    google.script.run
      .withSuccessHandler(function (medicosList) {
        console.log('Lista de m√©dicos recibida:', medicosList);
        const select = document.getElementById('medico');

        select.innerHTML = '<option disabled selected value="">Seleccione m√©dico...</option>';

        if (medicosList && medicosList.length > 0) {
          medicosList.forEach(nombre => {
            const option = document.createElement('option');
            option.value = nombre;
            option.textContent = nombre;
            select.appendChild(option);
          });
          mostrarMensaje(`‚úÖ ${medicosList.length} m√©dicos cargados correctamente`, "success");
        } else {
          select.innerHTML += '<option disabled>No hay m√©dicos disponibles</option>';
          mostrarMensaje("‚ö†Ô∏è No se encontraron m√©dicos en el sistema", "warning");
        }
      })
      .withFailureHandler(function (error) {
        console.error('Error cargando m√©dicos:', error);
        const select = document.getElementById('medico');
        select.innerHTML = '<option disabled selected>Error al cargar m√©dicos</option>';
        mostrarMensaje("‚ùå Error al cargar lista de m√©dicos: " + error.message, "error");
      })
      .obtenerPersonalFiltrado([0]); // Columna A (√≠ndice 0) para Gastroenter√≥logos
  }

  // ================== VALIDACIONES EN TIEMPO REAL ==================
  function configurarValidacionesEnTiempoReal() {
    // Validaci√≥n de c√©dula
    const cedulaInput = document.getElementById('cedula');
    cedulaInput.addEventListener('input', function () {
      validarCedula(this.value);
    });
    cedulaInput.addEventListener('blur', function () {
      formatearCedula(this);
    });

    // Validaci√≥n de tel√©fono
    const telefonoInput = document.getElementById('telefono');
    telefonoInput.addEventListener('input', function () {
      validarTelefono(this.value);
    });
    telefonoInput.addEventListener('blur', function () {
      formatearTelefono(this);
    });

    // Validaci√≥n de nombre
    const nombreInput = document.getElementById('nombre_cliente');
    nombreInput.addEventListener('input', function () {
      validarNombre(this.value);
    });

    // Validaci√≥n de m√©dico
    const medicoSelect = document.getElementById('medico');
    medicoSelect.addEventListener('change', function () {
      validarMedico(this.value);
    });
  }

  function validarCedula(cedula) {
    console.log('üîç [TEST] Validando c√©dula:', cedula);
    const errorDiv = document.getElementById('cedula_error');

    if (cedula.length === 0) {
      console.log('‚úÖ [TEST] C√©dula vac√≠a - v√°lida');
      errorDiv.textContent = '';
      return true;
    }

    // Remover espacios y guiones para validaci√≥n
    const cedulaLimpia = cedula.replace(/[-\s]/g, '');
    console.log('üîç [TEST] C√©dula limpia:', cedulaLimpia);

    // Validaci√≥n m√°s flexible para c√©dula, pasaporte o DIMEX
    // C√©dula costarricense: 9 d√≠gitos
    // Pasaporte: puede tener letras y n√∫meros (6-12 caracteres)
    // DIMEX: 11-12 d√≠gitos

    if (cedulaLimpia.length === 0) {
      console.log('‚ùå [TEST] C√©dula limpia vac√≠a');
      errorDiv.textContent = '‚ùå La identificaci√≥n no puede estar vac√≠a';
      return false;
    }

    // Permitir letras y n√∫meros para mayor flexibilidad
    const identificacionPattern = /^[A-Za-z0-9]{6,12}$/;
    console.log('üîç [TEST] Probando patr√≥n:', identificacionPattern, 'contra:', cedulaLimpia);

    if (!identificacionPattern.test(cedulaLimpia)) {
      console.log('‚ùå [TEST] C√©dula no cumple patr√≥n');
      errorDiv.textContent = '‚ùå Formato de identificaci√≥n inv√°lido (6-12 caracteres alfanum√©ricos)';
      return false;
    }

    console.log('‚úÖ [TEST] C√©dula v√°lida');
    errorDiv.textContent = '';
    return true;
  }

  function formatearCedula(input) {
    let valor = input.value.replace(/[^A-Za-z0-9]/g, ''); // Solo letras y n√∫meros

    // Para c√©dulas costarricenses (solo n√∫meros), aplicar formato seg√∫n la longitud
    if (/^\d+$/.test(valor)) {
      if (valor.length >= 12) {
        // DIMEX: 12 d√≠gitos - Formato: 123456789012 -> 1234-5678-9012
        valor = valor.substring(0, 4) + '-' + valor.substring(4, 8) + '-' + valor.substring(8, 12);
      } else if (valor.length >= 11) {
        // DIMEX: 11 d√≠gitos - Formato: 12345678901 -> 123-4567-8901
        valor = valor.substring(0, 3) + '-' + valor.substring(3, 7) + '-' + valor.substring(7, 11);
      } else if (valor.length >= 9) {
        // C√©dula tradicional: 9 d√≠gitos - Formato: 123456789 -> 1-2345-6789
        valor = valor.substring(0, 1) + '-' + valor.substring(1, 5) + '-' + valor.substring(5, 9);
      } else if (valor.length >= 5) {
        // Formato parcial para entrada en progreso
        valor = valor.substring(0, 1) + '-' + valor.substring(1, 5) + (valor.length > 5 ? '-' + valor.substring(5) : '');
      } else if (valor.length >= 1) {
        // Formato parcial para entrada en progreso
        valor = valor.substring(0, 1) + (valor.length > 1 ? '-' + valor.substring(1) : '');
      }
    }
    // Para pasaportes y DIMEX (con letras), no aplicar formato especial

    input.value = valor;
  }

  function validarTelefono(telefono) {
    console.log('üîç [TEST] Validando tel√©fono:', telefono);
    const errorDiv = document.getElementById('telefono_error');

    if (telefono.length === 0) {
      console.log('‚úÖ [TEST] Tel√©fono vac√≠o - v√°lido');
      errorDiv.textContent = '';
      return true;
    }

    // Patr√≥n para tel√©fono costarricense: 8888-8888
    const telefonoPattern = /^\d{4}-?\d{4}$/;
    const telefonoSinGuion = telefono.replace(/-/g, '');
    console.log('üîç [TEST] Tel√©fono sin gui√≥n:', telefonoSinGuion);
    console.log('üîç [TEST] Probando patr√≥n:', telefonoPattern, 'contra:', telefonoSinGuion);

    if (!telefonoPattern.test(telefonoSinGuion)) {
      console.log('‚ùå [TEST] Tel√©fono no cumple patr√≥n');
      errorDiv.textContent = '‚ùå Formato de tel√©fono inv√°lido (8888-8888)';
      return false;
    }

    console.log('‚úÖ [TEST] Tel√©fono v√°lido');
    errorDiv.textContent = '';
    return true;
  }

  function formatearTelefono(input) {
    let valor = input.value.replace(/\D/g, ''); // Solo n√∫meros

    if (valor.length >= 4) {
      valor = valor.substring(0, 4) + '-' + valor.substring(4, 8);
    }

    input.value = valor;
  }

  function validarNombre(nombre) {
    console.log('üîç [TEST] Validando nombre:', nombre);
    const errorDiv = document.getElementById('nombre_error');

    if (nombre.length === 0) {
      console.log('‚ùå [TEST] Nombre vac√≠o');
      errorDiv.textContent = '‚ùå El nombre del paciente es obligatorio';
      return false;
    }

    if (nombre.length < 3) {
      console.log('‚ùå [TEST] Nombre muy corto');
      errorDiv.textContent = '‚ùå El nombre debe tener al menos 3 caracteres';
      return false;
    }

    console.log('‚úÖ [TEST] Nombre v√°lido');
    errorDiv.textContent = '';
    return true;
  }

  function validarMedico(medico) {
    console.log('üîç [TEST] Validando m√©dico:', medico);
    const errorDiv = document.getElementById('medico_error');

    if (!medico) {
      console.log('‚ùå [TEST] M√©dico no seleccionado');
      errorDiv.textContent = '‚ùå Debe seleccionar un m√©dico';
      return false;
    }

    console.log('‚úÖ [TEST] M√©dico v√°lido');
    errorDiv.textContent = '';
    return true;
  }

  // ================== CONFIGURACIONES ADICIONALES ==================
  function configurarContadorCaracteres() {
    const comentarioTextarea = document.getElementById('comentario');
    const contadorSpan = document.getElementById('comentario_count');

    comentarioTextarea.addEventListener('input', function () {
      const length = this.value.length;
      contadorSpan.textContent = length;

      if (length > 450) {
        contadorSpan.style.color = '#d32f2f';
      } else if (length > 350) {
        contadorSpan.style.color = '#f57c00';
      } else {
        contadorSpan.style.color = '#4caf50';
      }
    });
  }

  function configurarCalculoFrascos() {
    const frascoGastro = document.getElementById('frascos_gastro');
    const frascoColon = document.getElementById('frascos_colon');
    const totalSpan = document.getElementById('total_frascos');

    function calcularTotal() {
      const gastro = parseInt(frascoGastro.value) || 0;
      const colon = parseInt(frascoColon.value) || 0;
      const total = gastro + colon;

      totalSpan.textContent = total;

      if (total === 0) {
        totalSpan.style.color = '#f57c00';
      } else {
        totalSpan.style.color = '#4caf50';
      }
    }

    frascoGastro.addEventListener('input', calcularTotal);
    frascoColon.addEventListener('input', calcularTotal);

    // C√°lculo inicial
    calcularTotal();
  }

  // ================== FUNCIONES PRINCIPALES ==================
  function guardarBiopsia() {
    console.log('üíæ [TEST] Iniciando proceso de guardado con funci√≥n de prueba...');

    // Validar formulario antes de enviar
    console.log('üîç [TEST] Iniciando validaci√≥n del formulario...');
    const esValido = validarFormularioCompleto();
    console.log('‚úÖ [TEST] Resultado de validaci√≥n:', esValido);

    if (!esValido) {
      console.log('‚ùå [TEST] Formulario inv√°lido, deteniendo proceso');
      mostrarMensaje("‚ùå Por favor, corrija los errores antes de continuar", "error");
      return;
    }

    console.log('‚úÖ [TEST] Formulario v√°lido, continuando...');

    // Recolectar datos directamente (como en el archivo de prueba exitoso)
    const data = {
      fecha_toma: document.getElementById('fecha_toma').value,
      cedula: document.getElementById('cedula').value.replace(/[-\s]/g, ''), // Limpiar guiones
      telefono: document.getElementById('telefono').value,
      nombre_cliente: document.getElementById('nombre_cliente').value,
      frascos_gastro: parseInt(document.getElementById('frascos_gastro').value) || 0,
      frascos_colon: parseInt(document.getElementById('frascos_colon').value) || 0,
      medico: document.getElementById('medico').value,
      comentario: document.getElementById('comentario').value
    };

    console.log('üìã Datos a enviar:', data);
    console.log('üìã Serializaci√≥n JSON:', JSON.stringify(data));

    // Validar que los datos obligatorios est√°n presentes
    if (!data.fecha_toma || !data.nombre_cliente || !data.medico) {
      mostrarMensaje("‚ùå Faltan datos obligatorios", "error");
      return;
    }

    mostrarMensaje("üíæ Guardando biopsia...", "info");

    // Deshabilitar bot√≥n para evitar doble env√≠o
    const submitButton = document.querySelector('button[type="submit"]');
    if (!submitButton) {
      console.error('‚ùå Error: No se encontr√≥ el bot√≥n de env√≠o');
      mostrarMensaje("‚ùå Error interno del formulario", "error");
      return;
    }

    const originalText = submitButton.innerHTML;
    submitButton.disabled = true;
    submitButton.innerHTML = '‚è≥ Guardando...';

    console.log('üöÄ [TEST] Ejecutando google.script.run con funci√≥n de prueba...');
    console.log('üìä [TEST] Datos completos a enviar:');
    console.log('   data:', data);

    google.script.run
      .withSuccessHandler(function (resultado) {
        console.log('‚úÖ [TEST] Respuesta exitosa del backend:', resultado);
        console.log('‚úÖ [TEST] Biopsia guardada exitosamente');
        mostrarMensaje("‚úÖ Biopsia guardada correctamente", "success");

        // Rehabilitar bot√≥n
        submitButton.disabled = false;
        submitButton.innerHTML = originalText;

        // Limpiar formulario despu√©s del √©xito
        setTimeout(() => {
          limpiarFormulario();
        }, 1500);
      })
      .withFailureHandler(function (error) {
        console.error('‚ùå [TEST] Error completo:', error);
        console.error('‚ùå [TEST] Mensaje de error:', error.message);
        console.error('‚ùå [TEST] Stack trace:', error.stack);
        mostrarMensaje("‚ùå Error al guardar la biopsia: " + error.message, "error");

        // Rehabilitar bot√≥n
        submitButton.disabled = false;
        submitButton.innerHTML = originalText;
      })
      .guardarBiopsia(data);
  }

  function validarFormularioCompleto() {
    console.log('üîç [TEST] Entrando a validarFormularioCompleto...');
    let esValido = true;

    // Validar campos obligatorios
    const nombre = document.getElementById('nombre_cliente').value;
    const medico = document.getElementById('medico').value;
    const fechaToma = document.getElementById('fecha_toma').value;

    console.log('üìã [TEST] Valores extra√≠dos:');
    console.log('   - Nombre:', nombre);
    console.log('   - M√©dico:', medico);
    console.log('   - Fecha:', fechaToma);

    if (!fechaToma) {
      console.log('‚ùå [TEST] Fecha de toma faltante');
      mostrarMensaje("‚ùå La fecha de toma es obligatoria", "error");
      esValido = false;
    }

    console.log('üîç [TEST] Validando nombre...');
    if (!validarNombre(nombre)) {
      console.log('‚ùå [TEST] Validaci√≥n de nombre fall√≥');
      esValido = false;
    }

    console.log('üîç [TEST] Validando m√©dico...');
    if (!validarMedico(medico)) {
      console.log('‚ùå [TEST] Validaci√≥n de m√©dico fall√≥');
      esValido = false;
    }

    // Validar formatos si hay datos
    const cedula = document.getElementById('cedula').value;
    const telefono = document.getElementById('telefono').value;

    console.log('üîç [TEST] Validando formatos opcionales...');
    console.log('   - C√©dula:', cedula);
    console.log('   - Tel√©fono:', telefono);

    if (cedula && !validarCedula(cedula)) {
      console.log('‚ùå [TEST] Validaci√≥n de c√©dula fall√≥');
      esValido = false;
    }

    if (telefono && !validarTelefono(telefono)) {
      console.log('‚ùå [TEST] Validaci√≥n de tel√©fono fall√≥');
      esValido = false;
    }

    console.log('‚úÖ [TEST] Validaci√≥n completada. Resultado final:', esValido);
    return esValido;
  }

  function recolectarDatosFormulario() {
    console.log('üîç Iniciando recolecci√≥n de datos...');

    // Verificar que los elementos existen
    const elementos = {
      fecha_toma: document.getElementById('fecha_toma'),
      cedula: document.getElementById('cedula'),
      telefono: document.getElementById('telefono'),
      nombre_cliente: document.getElementById('nombre_cliente'),
      frascos_gastro: document.getElementById('frascos_gastro'),
      frascos_colon: document.getElementById('frascos_colon'),
      medico: document.getElementById('medico'),
      comentario: document.getElementById('comentario')
    };

    console.log('üîç Elementos encontrados:', elementos);

    // Verificar que todos los elementos existen
    for (const [key, element] of Object.entries(elementos)) {
      if (!element) {
        console.error(`‚ùå Elemento no encontrado: ${key}`);
        return null;
      }
    }

    // Obtener la c√©dula y limpiarla de guiones para almacenamiento
    const cedulaRaw = elementos.cedula.value.trim();
    const cedulaLimpia = cedulaRaw.replace(/[-\s]/g, ''); // Remover guiones y espacios

    const datos = {
      fecha_toma: elementos.fecha_toma.value,
      cedula: cedulaLimpia, // Enviar sin guiones
      telefono: elementos.telefono.value.trim(),
      nombre_cliente: elementos.nombre_cliente.value.trim(),
      frascos_gastro: parseInt(elementos.frascos_gastro.value) || 0,
      frascos_colon: parseInt(elementos.frascos_colon.value) || 0,
      medico: elementos.medico.value,
      comentario: elementos.comentario.value.trim()
    };

    console.log('üìä Datos recolectados:', datos);
    return datos;
  }

  function limpiarFormulario() {
    console.log('üóëÔ∏è Limpiando formulario...');

    // Resetear formulario
    document.getElementById('registroBiopsiaForm').reset();

    // Restablecer valores por defecto
    establecerFechaActual();
    document.getElementById('frascos_gastro').value = "0";
    document.getElementById('frascos_colon').value = "0";

    // Limpiar mensajes de error
    document.querySelectorAll('.field-error').forEach(div => {
      div.textContent = '';
    });

    // Recalcular total de frascos
    const totalSpan = document.getElementById('total_frascos');
    totalSpan.textContent = '0';
    totalSpan.style.color = '#f57c00';

    // Resetear contador de caracteres
    const contadorSpan = document.getElementById('comentario_count');
    contadorSpan.textContent = '0';
    contadorSpan.style.color = '#4caf50';

    mostrarMensaje("üóëÔ∏è Formulario limpiado", "info");
  }

  function mostrarMensaje(mensaje, tipo) {
    const mensajeDiv = document.getElementById('formMessage');
    mensajeDiv.textContent = mensaje;
    mensajeDiv.className = 'message-container ' + tipo;

    // Auto-ocultar mensajes exitosos e informativos
    if (tipo === 'success' || tipo === 'info') {
      setTimeout(() => {
        mensajeDiv.textContent = '';
        mensajeDiv.className = 'message-container';
      }, 5000);
    }
  }
</script>