<script>
    // Referencias a elementos del DOM
    const form = document.getElementById('comprobanteForm');
    const formArea = document.getElementById('formArea');
    const resultArea = document.getElementById('resultArea');
    const printArea = document.getElementById('printArea');
    const statusMessage = document.getElementById('statusMessage');
    const horaInicioInput = document.getElementById('horaInicio');
    const horaFinInput = document.getElementById('horaFin');
    const fechaInput = document.getElementById('fecha');
    
    // Elementos nuevos para el acompañante
    const generarAcompananteCheckbox = document.getElementById('generarAcompanante');
    const acompanianteFieldsDiv = document.getElementById('acompanianteFields');
    const acompanianteNombreInput = document.getElementById('acompanianteNombre');
    const acompanianteCedulaInput = document.getElementById('acompanianteCedula');

    // Listener para mostrar/ocultar campos de acompañante y manejar 'required'
    generarAcompananteCheckbox.addEventListener('change', function() {
        const isChecked = this.checked;
        // Usa 'flex' ya que el div interno es un row g-3
        acompanianteFieldsDiv.style.display = isChecked ? 'flex' : 'none'; 

        // Gestionar el atributo 'required'
        acompanianteNombreInput.required = isChecked;
        acompanianteCedulaInput.required = isChecked;
    });

    /**
     * Convierte la hora militar (HH:MM) a formato de 12 horas (h:mm a.m./p.m.).
     * @param {string} militaryTime - Hora en formato militar HH:MM (ej: "13:05").
     * @returns {string} Hora formateada (ej: "1:05 p.m.").
     */
    function formatTime12Hour(militaryTime) {
        if (!militaryTime) return '';
        const [hour, minute] = militaryTime.split(':').map(Number);
        
        let displayHour = (hour % 12) || 12; // Convierte 0 a 12 para PM
        let period = hour < 12 ? 'a.m.' : 'p.m.';
        
        // La hora no lleva cero inicial si es de un dígito (ej: '9:05 a.m.')
        return `${displayHour}:${String(minute).padStart(2, '0')} ${period}`;
    }

    /**
     * Establece el valor de los inputs de hora y fecha.
     */
    function setupInputs() {
        const now = new Date();
        
        // 1. Hora actual para preseleccionar Hora de Llegada
        const hour = String(now.getHours()).padStart(2, '0');
        const minute = String(now.getMinutes()).padStart(2, '0');
        const currentTimeMilitary = `${hour}:${minute}`;
        horaInicioInput.value = currentTimeMilitary;
        horaFinInput.value = ''; // Limpiar Hora de Salida

        // 2. Fecha actual para preseleccionar Fecha (formato YYYY-MM-DD)
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        fechaInput.value = `${year}-${month}-${day}`;
        
        // 3. Limpiar y ocultar campos de acompañante al inicio
        acompanianteNombreInput.value = '';
        acompanianteCedulaInput.value = '';
        generarAcompananteCheckbox.checked = false;
        acompanianteFieldsDiv.style.display = 'none';
        acompanianteNombreInput.required = false;
        acompanianteCedulaInput.required = false;
    }

    // Inicializar inputs de hora y fecha al cargar el script
    setupInputs();


    // Manejo del envío del formulario
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Mostrar mensaje de carga
        showStatus('Generando comprobante...', 'alert-info');
        
        // Recolectar datos del formulario
        const formData = {};
        new FormData(form).forEach((value, key) => formData[key] = value.trim());
        
        // ** MODIFICACIÓN CLAVE: Enviar el estado como string ('true' o 'false') **
        formData.generarAcompanante = generarAcompananteCheckbox.checked ? 'true' : 'false';

        // Convertir la hora militar a formato de 12 horas antes de enviar al backend
        formData.horaInicio = formatTime12Hour(formData.horaInicio);
        formData.horaFin = formatTime12Hour(formData.horaFin);

        // Deshabilitar botón para evitar envíos múltiples
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;

        // Llamar a la función del lado del servidor (Code.gs)
        google.script.run
            .withSuccessHandler(onSuccess)
            .withFailureHandler(onFailure)
            .generarComprobante(formData);
    });

    /**
     * Callback de éxito después de llamar a generarComprobante().
     * @param {string} htmlContent El HTML del comprobante generado.
     */
    function onSuccess(htmlContent) {
        printArea.innerHTML = htmlContent;
        formArea.style.display = 'none';
        resultArea.style.display = 'block';
        showStatus('Comprobante generado con éxito. Listo para imprimir.', 'alert-success');
        document.getElementById('comprobanteForm').querySelector('button[type="submit"]').disabled = false;
    }

    /**
     * Callback de fallo.
     * @param {Error} error El objeto de error.
     */
    function onFailure(error) {
        showStatus(`Error al generar: ${error.message}`, 'alert-danger');
        document.getElementById('comprobanteForm').querySelector('button[type="submit"]').disabled = false;
    }

    /**
     * Muestra un mensaje de estado o error.
     * @param {string} message El texto del mensaje.
     * @param {string} className La clase de Bootstrap para el estilo (ej: 'alert-info').
     */
    function showStatus(message, className) {
        statusMessage.textContent = message;
        // Limpiar clases existentes y añadir las nuevas
        statusMessage.className = `mt-3 alert`;
        statusMessage.classList.add(className);
        statusMessage.classList.remove('d-none');
    }

    /**
     * Restablece la vista para ingresar un nuevo comprobante.
     */
    function resetForm() {
        form.reset();
        // Vuelve a preseleccionar la hora y fecha al resetear
        setupInputs();
        
        resultArea.style.display = 'none';
        formArea.style.display = 'block';
        printArea.innerHTML = '';
        statusMessage.classList.add('d-none');
    }
</script>