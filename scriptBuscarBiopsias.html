<script>
    /*=============== SCRIPT COMPLETO Y CORREGIDO V3 =====================
    ================================================================================
    Correcciones:
    - Se ha mejorado la asignación de eventos para el botón de editar (lápiz).
    - Se ha reforzado la lógica de paginación para que se actualice correctamente.
    - Se ha unificado la lógica de reporte mensual con la búsqueda principal.
    ================================================================================*/
    document.addEventListener('DOMContentLoaded', function () {
        //-----------------------------------------
        //  1. REFERENCIAS A ELEMENTOS DEL DOM
        //-----------------------------------------
        const searchTypeRadios = document.querySelectorAll('input[name="searchType"]');
        const searchInputs = {
            fecha: document.getElementById('search_fecha'),
            cedula: document.getElementById('search_cedula'),
            nombre: document.getElementById('search_nombre'),
            mes: document.getElementById('mes_inputs'),
            estado: document.getElementById('search_estado')
        };
        const btnBuscar = document.getElementById('btnBuscar');
        const searchMessage = document.getElementById('searchMessage');
        const btnReporteMensual = document.getElementById('btnReporteMensual');
        const reportMes = document.getElementById('reportMes');
        const reportAnio = document.getElementById('reportAnio');
        const btnDescargarPDF = document.getElementById('btnDescargarPDF');
        const emailMessage = document.getElementById('emailMessage');

        //-----------------------------------------
        //  2. VARIABLES GLOBALES
        //-----------------------------------------
        let currentPage = 1;
        let itemsPerPage = 10;
        let totalResults = 0;
        let lastSearchParams = null;

        //-----------------------------------------
        //  3. CONFIGURACIÓN INICIAL
        //-----------------------------------------
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        searchInputs.fecha.value = `${yyyy}-${mm}-${dd}`;
        document.getElementById('reportAnio').value = yyyy;

        //-----------------------------------------
        //  4. FUNCIONES AUXILIARES
        //-----------------------------------------
        function showLoadingOverlay() { document.getElementById('loadingOverlay').style.display = 'flex'; }
        function hideLoadingOverlay() { document.getElementById('loadingOverlay').style.display = 'none'; }

        function mostrarMensajeBusqueda(mensaje, tipo) {
            searchMessage.textContent = mensaje;
            searchMessage.className = `message-area ${tipo}`;
            searchMessage.style.display = 'block';
        }

        //-----------------------------------------
        //  5. LÓGICA DE BÚSQUEDA
        //-----------------------------------------
        searchTypeRadios.forEach(radio => {
            radio.addEventListener('change', function () {
                Object.values(searchInputs).forEach(input => input.style.display = 'none');
                const selectedType = this.value;
                if (searchInputs[selectedType]) {
                    searchInputs[selectedType].style.display = '';
                    if (selectedType === 'mes') searchInputs.mes.style.display = 'flex';
                }
                document.getElementById('resultado_busqueda').innerHTML = '';
                document.getElementById('paginationControls').style.display = 'none';
                document.getElementById('action-section').style.display = 'none';
            });
        });

        btnBuscar.addEventListener('click', function () {
            const selectedType = document.querySelector('input[name="searchType"]:checked').value;
            let value = '', value2 = null;

            if (selectedType === 'fecha') value = searchInputs.fecha.value;
            else if (selectedType === 'cedula') value = searchInputs.cedula.value;
            else if (selectedType === 'nombre') value = searchInputs.nombre.value;
            else if (selectedType === 'mes') {
                value = document.getElementById('search_mes').value;
                value2 = document.getElementById('reportAnio').value;
            } else if (selectedType === 'estado') value = searchInputs.estado.value;

            if (!value) {
                mostrarMensajeBusqueda("Por favor, ingrese un valor de búsqueda.", "error");
                return;
            }
            lastSearchParams = { type: selectedType, value, value2 };
            currentPage = 1;
            performSearchWithPagination();
        });

        function performSearchWithPagination() {
            if (!lastSearchParams) return;
            showLoadingOverlay();
            mostrarMensajeBusqueda("Buscando...", "info");

            google.script.run
                .withSuccessHandler(function (response) {
                    hideLoadingOverlay();
                    console.log("Respuesta del servidor:", response); // Log para depuración
                    if (!response || typeof response.total === 'undefined' || !Array.isArray(response.data)) {
                        mostrarMensajeBusqueda("El servidor devolvió un formato de datos incorrecto.", "error");
                        totalResults = 0; // Asegurarse de que el total sea 0
                        updatePaginationControls();
                        return;
                    }
                    totalResults = response.total;
                    console.log("Total de resultados:", totalResults); // Log para depuración
                    mostrarResultadosBiopsias(response.data);
                    updatePaginationControls();
                })
                .withFailureHandler(function (error) {
                    hideLoadingOverlay();
                    mostrarMensajeBusqueda("Error en la búsqueda: " + error.message, "error");
                    totalResults = 0; // Asegurarse de que el total sea 0
                    updatePaginationControls();
                })
                .buscarBiopsiasServidor_v3({ ...lastSearchParams, page: currentPage, pageSize: itemsPerPage });
        }

        function mostrarResultadosBiopsias(resultados) {
            const cont = document.getElementById("resultado_busqueda");
            document.getElementById('action-section').style.display = 'none';

            if (resultados.length === 0) {
                mostrarMensajeBusqueda("No se encontraron resultados.", "info");
                cont.innerHTML = "";
                return;
            }

            let html = `<table class="results-table"><thead><tr>
                <th>Fecha Toma</th><th>Recibida</th><th>Enviada</th><th>Cédula</th><th>Teléfono</th>
                <th>Nombre Cliente</th><th>Gastro</th><th>Colon</th><th>Médico</th><th>Acciones</th>
                </tr></thead><tbody>`;

            resultados.forEach(function (row) {
                const [fechaToma, recibida, enviada, cedula, telefono, nombreCliente, frascosGastro, frascosColon, medico, , rowNumber] = row;
                const rowClass = recibida && enviada ? 'fila-completada' : '';

                html += `<tr class="${rowClass}">
                    <td>${fechaToma}</td>
                    <td><input type="checkbox" data-row="${rowNumber}" data-estado="recibida" ${recibida ? 'checked' : ''} class="toggle-estado"></td>
                    <td><input type="checkbox" data-row="${rowNumber}" data-estado="enviada" ${enviada ? 'checked' : ''} class="toggle-estado"></td>
                    <td>${cedula || ''}</td><td>${telefono || ''}</td><td>${nombreCliente || ''}</td>
                    <td>${frascosGastro || 0}</td><td>${frascosColon || 0}</td><td>${medico || ''}</td>
                    <td><button class="btn-edit" data-row="${rowNumber}">✏️</button></td>
                </tr>`;
            });

            html += '</tbody></table>';
            cont.innerHTML = html;
            mostrarMensajeBusqueda(`Mostrando ${resultados.length} de ${totalResults} resultado(s).`, "success");
            
            if (lastSearchParams && lastSearchParams.type === 'mes') {
                document.getElementById('action-section').style.display = 'flex';
            }
            
            // Asignación de eventos robusta
            cont.querySelectorAll('.btn-edit').forEach(button => {
                button.addEventListener('click', function() {
                    editarRegistro(parseInt(this.dataset.row));
                });
            });
            cont.querySelectorAll('.toggle-estado').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const row = parseInt(this.dataset.row);
                    const isRecibida = document.querySelector(`input[data-row="${row}"][data-estado="recibida"]`).checked;
                    const isEnviada = document.querySelector(`input[data-row="${row}"][data-estado="enviada"]`).checked;
                    toggleEstado(row, isRecibida, isEnviada);
                });
            });
        }

        //-----------------------------------------
        //  6. LÓGICA DE PAGINACIÓN (REFORZADA)
        //-----------------------------------------
        function updatePaginationControls() {
            const totalPages = Math.ceil(totalResults / itemsPerPage) || 1; // Si es 0, que sea 1
            const hasResults = totalResults > 0;
            document.getElementById('paginationControls').style.display = hasResults ? 'flex' : 'none';
            if (!hasResults) return;

            document.getElementById('pageInfo').textContent = `Página ${currentPage} de ${totalPages}`;
            document.getElementById('prevPage').disabled = (currentPage === 1);
            document.getElementById('nextPage').disabled = (currentPage >= totalPages);
        }
        document.getElementById('prevPage').addEventListener('click', () => { if(currentPage > 1) { currentPage--; performSearchWithPagination(); }});
        document.getElementById('nextPage').addEventListener('click', () => { if(currentPage < Math.ceil(totalResults / itemsPerPage)) { currentPage++; performSearchWithPagination(); }});
        document.getElementById('pageSize').addEventListener('change', (e) => {
            itemsPerPage = parseInt(e.target.value);
            currentPage = 1;
            if(lastSearchParams) performSearchWithPagination();
        });

        //-----------------------------------------
        //  7. LÓGICA DE EDICIÓN Y GUARDADO
        //-----------------------------------------
        const modalOverlay = document.createElement('div');
        modalOverlay.className = 'modal-overlay';
        modalOverlay.style.display = 'none';
        document.body.appendChild(modalOverlay);

        function toggleEstado(fila, recibida, enviada) {
            showLoadingOverlay();
            google.script.run
                .withSuccessHandler(() => {
                    hideLoadingOverlay();
                    if (lastSearchParams) performSearchWithPagination();
                })
                .withFailureHandler(error => {
                    hideLoadingOverlay();
                    alert("Error al actualizar estado: " + error.message);
                })
                .actualizarEstadosBiopsia(fila, recibida, enviada);
        }

        function editarRegistro(fila) {
            showLoadingOverlay();
            google.script.run
                .withSuccessHandler(datos => {
                    hideLoadingOverlay();
                    mostrarModalEdicion(datos);
                })
                .withFailureHandler(error => {
                    hideLoadingOverlay();
                    alert("Error al cargar datos para editar: " + error.message);
                })
                .obtenerDatosBiopsia(fila);
        }

        function mostrarModalEdicion(datos) {
            let fechaFormateada = '';
            if (datos.fecha_toma) {
                const fechaObj = new Date(datos.fecha_toma);
                if (!isNaN(fechaObj.getTime())) {
                    fechaObj.setMinutes(fechaObj.getMinutes() + fechaObj.getTimezoneOffset());
                    fechaFormateada = fechaObj.toISOString().split('T')[0];
                }
            }

            modalOverlay.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header"><h3>Editar Registro (Fila: ${datos.fila})</h3><button class="btn-close" onclick="cerrarModal()">✖</button></div>
                    <div class="modal-form">
                        <input type="hidden" id="edit_fila" value="${datos.fila}">
                        <div class="form-row">
                            <div class="form-group"><label>Fecha:</label><input type="date" id="edit_fecha" value="${fechaFormateada}"></div>
                            <div class="form-group"><label>Cédula:</label><input type="text" id="edit_cedula" value="${datos.cedula || ''}"></div>
                        </div>
                        <div class="form-row">
                             <div class="form-group"><label>Teléfono:</label><input type="text" id="edit_telefono" value="${datos.telefono || ''}"></div>
                             <div class="form-group"><label>Nombre:</label><input type="text" id="edit_nombre" value="${datos.nombre_cliente || ''}"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Gastro:</label><input type="number" id="edit_gastro" value="${datos.frascos_gastro || 0}" min="0"></div>
                            <div class="form-group"><label>Colon:</label><input type="number" id="edit_colon" value="${datos.frascos_colon || 0}" min="0"></div>
                        </div>
                        <div class="form-group"><label>Médico:</label><input type="text" id="edit_medico" value="${datos.medico || ''}"></div>
                        <div class="form-group"><label>Comentario:</label><textarea id="edit_comentario" rows="3">${datos.comentario || ''}</textarea></div>
                        <div class="checkbox-group">
                            <label><input type="checkbox" id="edit_recibida" ${datos.recibida ? 'checked' : ''}> Recibida</label>
                            <label><input type="checkbox" id="edit_enviada" ${datos.enviada ? 'checked' : ''}> Enviada</label>
                        </div>
                        <div class="modal-actions">
                            <button class="btn-secondary" onclick="cerrarModal()">Cancelar</button>
                            <button class="btn-primary" id="btnGuardarCambios">Guardar Cambios</button>
                        </div>
                    </div>
                </div>`;
            modalOverlay.style.display = 'flex';
            document.getElementById('btnGuardarCambios').addEventListener('click', guardarCambios);
        }

        window.cerrarModal = function () {
            modalOverlay.style.display = 'none';
            modalOverlay.innerHTML = '';
        };

        function guardarCambios() {
            const datosActualizados = {
                fecha_toma: document.getElementById('edit_fecha').value,
                cedula: document.getElementById('edit_cedula').value,
                telefono: document.getElementById('edit_telefono').value,
                nombre_cliente: document.getElementById('edit_nombre').value,
                frascos_gastro: parseInt(document.getElementById('edit_gastro').value) || 0,
                frascos_colon: parseInt(document.getElementById('edit_colon').value) || 0,
                medico: document.getElementById('edit_medico').value,
                recibida: document.getElementById('edit_recibida').checked,
                enviada: document.getElementById('edit_enviada').checked,
                comentario: document.getElementById('edit_comentario').value
            };
            const fila = parseInt(document.getElementById('edit_fila').value);

            if (!confirm('¿Está seguro de que desea guardar los cambios?')) return;

            showLoadingOverlay();
            google.script.run
                .withSuccessHandler(() => {
                    hideLoadingOverlay();
                    cerrarModal();
                    mostrarMensajeBusqueda("Registro actualizado correctamente.", "success");
                    if (lastSearchParams) performSearchWithPagination();
                })
                .withFailureHandler(error => {
                    hideLoadingOverlay();
                    alert("Error al guardar: " + error.message);
                })
                .actualizarRegistroBiopsia(fila, datosActualizados);
        }

        //-----------------------------------------
        //  8. LÓGICA DE REPORTES
        //-----------------------------------------
        btnReporteMensual.addEventListener('click', function () {
            const mes = parseInt(reportMes.value);
            const anio = parseInt(reportAnio.value);

            if (isNaN(mes) || isNaN(anio) || mes < 1) {
                mostrarMensajeBusqueda("Por favor, seleccione un mes y año válidos.", "error");
                return;
            }
            lastSearchParams = { type: 'mes', value: mes, value2: anio };
            currentPage = 1;
            performSearchWithPagination();
        });

        btnDescargarPDF.addEventListener('click', function () {
            if (!lastSearchParams || lastSearchParams.type !== 'mes') {
                emailMessage.textContent = "Primero debe generar un reporte mensual.";
                emailMessage.className = "message-area error";
                emailMessage.style.display = 'block';
                return;
            }

            const mes = lastSearchParams.value;
            const anio = lastSearchParams.value2;

            emailMessage.textContent = "Generando PDF...";
            emailMessage.className = "message-area info";
            emailMessage.style.display = 'block';
            showLoadingOverlay();

            google.script.run
                .withSuccessHandler(function (url) {
                    hideLoadingOverlay();
                    if (url) {
                        emailMessage.textContent = "PDF generado. Abriendo...";
                        emailMessage.className = "message-area success";
                        window.open(url, '_blank');
                    } else {
                        emailMessage.textContent = "No se pudo generar el PDF.";
                        emailMessage.className = "message-area error";
                    }
                })
                .withFailureHandler(function (error) {
                    hideLoadingOverlay();
                    emailMessage.textContent = "Error al generar el PDF: " + error.message;
                    emailMessage.className = "message-area error";
                })
                .generarReportePDF(mes, anio);
        });
    });
</script>