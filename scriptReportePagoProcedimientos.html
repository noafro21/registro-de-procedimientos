<script>
  // ================== INICIALIZACI√ìN Y CARGA INICIAL MEJORADA ==================
  document.addEventListener('DOMContentLoaded', function () {
    console.log('üöÄ Iniciando aplicaci√≥n de reporte de procedimientos');

    // Inicializar selectores de fecha
    inicializarSelectoresFecha();

    // Event listeners para actualizaci√≥n de descripci√≥n
    ['mes', 'anio', 'quincena'].forEach(function (id) {
      const elemento = document.getElementById(id);
      if (elemento) {
        elemento.addEventListener('change', function () {
          actualizarDescripcionSeleccion();
        });
      }
    });

    // Cargar personal con mejor manejo de errores
    console.log('üìã Cargando lista de personal...');
    google.script.run
      .withSuccessHandler(function (personalList) {
        console.log('=== CARGA DE PERSONAL ===');
        console.log('Lista de personal recibida:', personalList);
        console.log('Cantidad de personal:', personalList.length);

        const selectDoctor = document.getElementById('doctor');
        selectDoctor.innerHTML = '<option disabled selected value="">Seleccione un nombre</option>';

        if (personalList.length === 0) {
          selectDoctor.innerHTML += '<option disabled>No hay personal disponible</option>';
          mostrarMensaje("‚ö†Ô∏è No se pudo cargar la lista de personal", "warning");
        } else {
          personalList.forEach(function (nombre) {
            console.log('Agregando al select:', nombre);
            const option = document.createElement('option');
            option.value = nombre;
            option.textContent = nombre;
            selectDoctor.appendChild(option);
          });
          mostrarMensaje("‚úÖ Personal cargado correctamente (" + personalList.length + " personas)", "success");
        }
      })
      .withFailureHandler(function (error) {
        console.error('=== ERROR CARGA PERSONAL ===');
        console.error('Error completo:', error);
        mostrarMensaje("‚ùå Error al cargar el personal: " + error.message, "error");
      })
      .obtenerPersonalFiltrado([0, 1, 2]);

    // Event listeners para descuentos y extras
    ['montoDescontar', 'motivoDescuento', 'montoExtra'].forEach(function (id) {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', actualizarDescuentoYExtra);
    });
  });

  // ================== FUNCIONES DE INICIALIZACI√ìN DE SELECTORES ==================
  function inicializarSelectoresFecha() {
    inicializarSelectorMes();
    inicializarSelectorAnio();
    inicializarSelectorQuincena();
    seleccionarPeriodoActual();
  }

  function inicializarSelectorMes() {
    const mesInput = document.getElementById('mes');
    if (!mesInput) return;

    const meses = [
      { valor: 1, nombre: "Enero" },
      { valor: 2, nombre: "Febrero" },
      { valor: 3, nombre: "Marzo" },
      { valor: 4, nombre: "Abril" },
      { valor: 5, nombre: "Mayo" },
      { valor: 6, nombre: "Junio" },
      { valor: 7, nombre: "Julio" },
      { valor: 8, nombre: "Agosto" },
      { valor: 9, nombre: "Septiembre" },
      { valor: 10, nombre: "Octubre" },
      { valor: 11, nombre: "Noviembre" },
      { valor: 12, nombre: "Diciembre" }
    ];

    mesInput.innerHTML = '<option disabled value="">Seleccione un mes</option>';
    meses.forEach(mes => {
      const option = document.createElement('option');
      option.value = mes.valor;
      option.textContent = mes.nombre;
      mesInput.appendChild(option);
    });
  }

  function inicializarSelectorAnio() {
    const anioInput = document.getElementById('anio');
    if (!anioInput) return;

    const anioActual = new Date().getFullYear();
    const anioInicio = 2020;
    const anioFin = anioActual + 1;

    anioInput.innerHTML = '<option disabled value="">Seleccione un a√±o</option>';

    for (let anio = anioFin; anio >= anioInicio; anio--) {
      const option = document.createElement('option');
      option.value = anio;
      option.textContent = anio;
      anioInput.appendChild(option);
    }
  }

  function inicializarSelectorQuincena() {
    const quincenaInput = document.getElementById('quincena');
    if (!quincenaInput) return;

    const opciones = [
      { valor: "1-15", nombre: "Primera Quincena (1-15)", descripcion: "Del d√≠a 1 al 15 del mes" },
      { valor: "16-31", nombre: "Segunda Quincena (16-31)", descripcion: "Del d√≠a 16 al √∫ltimo d√≠a del mes" },
      { valor: "completo", nombre: "Mes Completo", descripcion: "Todo el mes seleccionado" }
    ];

    quincenaInput.innerHTML = '<option disabled value="">Seleccione una quincena</option>';
    opciones.forEach(opcion => {
      const option = document.createElement('option');
      option.value = opcion.valor;
      option.textContent = opcion.nombre;
      option.title = opcion.descripcion;
      quincenaInput.appendChild(option);
    });
  }

  function seleccionarPeriodoActual() {
    const fechaActual = new Date();
    const mesActual = fechaActual.getMonth() + 1;
    const anioActual = fechaActual.getFullYear();
    const diaActual = fechaActual.getDate();

    // Seleccionar mes actual
    const mesInput = document.getElementById('mes');
    if (mesInput) mesInput.value = mesActual.toString();

    // Seleccionar a√±o actual
    const anioInput = document.getElementById('anio');
    if (anioInput) anioInput.value = anioActual.toString();

    // Seleccionar quincena actual basada en el d√≠a
    const quincenaInput = document.getElementById('quincena');
    if (quincenaInput) {
      const quincenaActual = diaActual <= 15 ? '1-15' : '16-31';
      quincenaInput.value = quincenaActual;
    }

    // Actualizar descripci√≥n
    actualizarDescripcionSeleccion();
  }

  function actualizarSelectoresFecha() {
    inicializarSelectoresFecha();
    mostrarMensaje("‚úÖ Selectores de fecha actualizados.", "success");
  }

  function mostrarAyudaFechas() {
    const ayuda = `AYUDA PARA SELECCI√ìN DE FECHAS:

üìÖ MES: Seleccione el mes del cual desea generar el reporte.

üìÜ A√ëO: A√±os disponibles desde 2020 hasta ${new Date().getFullYear() + 1}.

üóìÔ∏è QUINCENA:
‚Ä¢ Primera Quincena (1-15): Incluye del d√≠a 1 al 15 del mes
‚Ä¢ Segunda Quincena (16-31): Incluye del d√≠a 16 al √∫ltimo d√≠a del mes  
‚Ä¢ Mes Completo: Incluye todos los d√≠as del mes seleccionado

üí° CONSEJO: 
- El sistema selecciona autom√°ticamente el per√≠odo actual
- Use "üîÑ Actualizar Fechas" si los selectores no cargan correctamente`;

    alert(ayuda);
  }

  // ================== FUNCIONES DE UI Y DESCRIPCI√ìN ==================
  function actualizarDescripcionSeleccion() {
    const descripcionElement = document.getElementById('descripcionSeleccion');
    if (descripcionElement) {
      const descripcion = obtenerDescripcionSeleccionActual();
      descripcionElement.textContent = descripcion;
    }
  }

  function obtenerDescripcionSeleccionActual() {
    const mes = document.getElementById('mes').value;
    const anio = document.getElementById('anio').value;
    const quincena = document.getElementById('quincena').value;

    if (!mes || !anio || !quincena) {
      return "Ninguna - Complete todos los campos";
    }

    const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
      "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    const nombreMes = meses[parseInt(mes) - 1];

    let descripcionQuincena;
    switch (quincena) {
      case "1-15":
        descripcionQuincena = "Primera quincena (1-15)";
        break;
      case "16-31":
        descripcionQuincena = "Segunda quincena (16-31)";
        break;
      case "completo":
        descripcionQuincena = "Mes completo";
        break;
      default:
        descripcionQuincena = quincena;
    }

    return `${nombreMes} ${anio} - ${descripcionQuincena}`;
  }

  function validarSeleccionFecha() {
    const mes = document.getElementById('mes').value;
    const anio = document.getElementById('anio').value;
    const quincena = document.getElementById('quincena').value;

    let mensaje = "VALIDACI√ìN DE SELECCI√ìN DE FECHA:\n\n";
    mensaje += `Mes: ${mes ? '‚úÖ ' + mes : '‚ùå No seleccionado'}\n`;
    mensaje += `A√±o: ${anio ? '‚úÖ ' + anio : '‚ùå No seleccionado'}\n`;
    mensaje += `Quincena: ${quincena ? '‚úÖ ' + quincena : '‚ùå No seleccionado'}\n\n`;

    if (mes && anio && quincena) {
      mensaje += `‚úÖ Selecci√≥n v√°lida: ${obtenerDescripcionSeleccionActual()}`;
      mostrarMensaje("‚úÖ Selecci√≥n de fecha v√°lida.", "success");
    } else {
      mensaje += "‚ùå Selecci√≥n incompleta. Complete todos los campos.";
      mostrarMensaje("‚ö†Ô∏è Complete todos los campos de fecha.", "warning");
    }

    alert(mensaje);
  }

  function mostrarLogConsola() {
    console.log('=== LOGS DEL SISTEMA ===');
    console.log('Estado actual de selectores:');
    console.log('- Doctor:', document.getElementById('doctor').value);
    console.log('- Mes:', document.getElementById('mes').value);
    console.log('- A√±o:', document.getElementById('anio').value);
    console.log('- Quincena:', document.getElementById('quincena').value);
    console.log('- Descripci√≥n:', obtenerDescripcionSeleccionActual());
    mostrarMensaje("üìã Logs mostrados en la consola del navegador (F12).", "info");
  }

  function mostrarIndicadorCarga(mostrar) {
    const indicador = document.getElementById('loadingIndicator');
    if (indicador) {
      indicador.style.display = mostrar ? 'flex' : 'none';
    }
  }

  // ================== CARGA DE EMAIL PERSONAL ==================
  function cargarEmailPersonal() {
    const selectedPersonal = document.getElementById('doctor').value;

    if (!selectedPersonal) {
      mostrarMensaje("Por favor, seleccione un personal primero.", "error");
      return;
    }

    google.script.run
      .withSuccessHandler(function (email) {
        document.getElementById('emailRecipient').value = email;
      })
      .withFailureHandler(function (error) {
        mostrarMensaje("‚ùå Error al cargar el email: " + error.message, "error");
      })
      .obtenerEmailParaPersonal(selectedPersonal);
  }

  // ================== GENERACI√ìN DE TABLAS Y REPORTE ==================
  function generarTablaHtml(titulo, data, totalSubtotalDia, totalIVADia, totalConIVADia) {
    let html = `
      <h3>${titulo}</h3>
      <table>
        <tr>
          <th>Tipo de procedimiento</th>
          <th>Cantidad</th>
          <th>Costo por procedimiento individual</th>
          <th>Ganancia sin IVA</th>
          <th>IVA (4%)</th>
          <th>Ganancia con IVA</th>
        </tr>
    `;

    let hasData = false;
    for (const key in data) {
      const r = data[key];
      if (r.cantidad > 0) {
        hasData = true;
        html += `
          <tr>
            <td class="text-left">${r.nombre}</td>
            <td>${r.cantidad}</td>
            <td>‚Ç°${formatearMoneda(r.costo_unitario)}</td>
            <td>‚Ç°${formatearMoneda(r.subtotal)}</td>
            <td>‚Ç°${formatearMoneda(r.iva)}</td>
            <td>‚Ç°${formatearMoneda(r.total_con_iva)}</td>
          </tr>
        `;
      }
    }

    if (!hasData) {
      html += `<tr><td colspan="6">No hay registros para este per√≠odo.</td></tr>`;
    } else {
      html += `
        <tr class="subtotal-row">
          <td class="text-left">Subtotal ${titulo}</td>
          <td>-</td>
          <td>-</td>
          <td>‚Ç°${formatearMoneda(totalSubtotalDia)}</td>
          <td>‚Ç°${formatearMoneda(totalIVADia)}</td>
          <td>‚Ç°${formatearMoneda(totalConIVADia)}</td>
        </tr>
      `;
    }
    html += '</table>';
    return html;
  }

  // ‚úÖ NUEVA FUNCI√ìN: Generar detalle de registros
  function generarDetalleRegistros(detalleRegistros, nombrePersonal) {
    console.log('=== GENERANDO REPORTE DE PROCEDIMIENTOS ===');
    console.log('detalleRegistros:', detalleRegistros);
    console.log('nombrePersonal:', nombrePersonal);

    if (!detalleRegistros || !Array.isArray(detalleRegistros) || detalleRegistros.length === 0) {
      console.log('‚ö†Ô∏è No hay registros para mostrar');
      return '';
    }

    try {
      let html = `
        <div class="reporte-procedimientos-section">
          <h2>üìã Reporte de Procedimientos - ${nombrePersonal || 'Personal'}</h2>
          <p class="reporte-info">Total de registros procesados: <strong>${detalleRegistros.length}</strong></p>
          
          <div class="registros-container">
      `;

      // Ordenar registros por fecha con validaci√≥n
      let registrosOrdenados;
      try {
        registrosOrdenados = detalleRegistros.sort((a, b) => {
          const fechaA = a.fechaOriginal ? new Date(a.fechaOriginal) : new Date(0);
          const fechaB = b.fechaOriginal ? new Date(b.fechaOriginal) : new Date(0);
          return fechaA - fechaB;
        });
      } catch (error) {
        console.error('Error ordenando registros:', error);
        registrosOrdenados = detalleRegistros; // Usar sin ordenar si hay error
      }

      registrosOrdenados.forEach((registro, index) => {
        const numeroRegistro = index + 1;
        const tipoFondo = registro.esSabado ? 'registro-sabado' : 'registro-lv';

        html += `
        <div class="registro-item ${tipoFondo}">
          <div class="registro-header">
            <span class="registro-numero">#${numeroRegistro}</span>
            <span class="registro-fila">Fila ${registro.fila}</span>
            <span class="registro-fecha">${registro.fecha}</span>
            <span class="registro-tipo">${registro.esSabado ? 'üóìÔ∏è S√°bado' : 'üìÖ L-V'}</span>
          </div>
          
          <div class="procedimientos-lista">
            <h4>Procedimientos realizados:</h4>
            <table class="tabla-procedimientos-detalle">
              <thead>
                <tr>
                  <th>Procedimiento</th>
                  <th>Cant.</th>
                  <th>Costo Unit.</th>
                  <th>Sin IVA</th>
                  <th>IVA (4%)</th>
                  <th>Total con IVA</th>
                </tr>
              </thead>
              <tbody>
      `;

        // ‚úÖ VERIFICAR si hay procedimientos antes de iterar
        if (registro.procedimientos && Array.isArray(registro.procedimientos)) {
          registro.procedimientos.forEach(proc => {
            // ‚úÖ CORREGIDO: Usar los valores correctos del backend
            const sinIVA = proc.subtotal;        // Precio sin IVA (cantidad √ó costo unitario)
            const iva = proc.iva;               // IVA ya calculado en el backend
            const totalConIVA = proc.total;     // Total con IVA ya calculado en el backend

            html += `
            <tr>
              <td class="text-left">${proc.nombre}</td>
              <td>${proc.cantidad}</td>
              <td>‚Ç°${formatearMoneda(proc.costoUnitario)}</td>
              <td>‚Ç°${formatearMoneda(sinIVA)}</td>
              <td>‚Ç°${formatearMoneda(iva)}</td>
              <td>‚Ç°${formatearMoneda(totalConIVA)}</td>
            </tr>
          `;
          });
        } else {
          // Si no hay procedimientos (datos de prueba), mostrar mensaje
          html += `
            <tr>
              <td colspan="6" class="text-center">
                <em>üìù ${registro.procedimientosResumen || 'Datos de prueba - sin procedimientos detallados'}</em>
              </td>
            </tr>
          `;
        }

        // ‚úÖ CORREGIDO: Calcular totales del registro correctamente
        const subtotalRegistroSinIVA = registro.subtotalRegistro || 0; // Ahora es realmente sin IVA
        const ivaRegistro = subtotalRegistroSinIVA * 0.04;
        const totalConIVARegistro = subtotalRegistroSinIVA + ivaRegistro;

        html += `
              </tbody>
              <tfoot>
                <tr class="total-registro">
                  <td colspan="3"><strong>Total del registro:</strong></td>
                  <td><strong>‚Ç°${formatearMoneda(subtotalRegistroSinIVA)}</strong></td>
                  <td><strong>‚Ç°${formatearMoneda(ivaRegistro)}</strong></td>
                  <td><strong>‚Ç°${formatearMoneda(totalConIVARegistro)}</strong></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      `;
      });

      // ‚úÖ CORREGIDO: Calcular estad√≠sticas correctamente
      const totalRegistrosSabado = registrosOrdenados.filter(r => r.esSabado).length;
      const totalRegistrosLV = registrosOrdenados.length - totalRegistrosSabado;

      // Calcular totales reales
      const totalSinIVA = registrosOrdenados.reduce((sum, r) => sum + (r.subtotalRegistro || 0), 0);
      const totalIVA = totalSinIVA * 0.04;
      const totalConIVA = totalSinIVA + totalIVA;

      html += `
        </div>
        
        <div class="estadisticas-registros">
          <h3>üìä Resumen del Per√≠odo</h3>
          <div class="stats-grid">
            <div class="stat-item">
              <span class="stat-label">üìÖ Registros L-V:</span>
              <span class="stat-value">${totalRegistrosLV}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">üóìÔ∏è Registros S√°bado:</span>
              <span class="stat-value">${totalRegistrosSabado}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">üìã Total Registros:</span>
              <span class="stat-value">${registrosOrdenados.length}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">üí∞ Subtotal (Sin IVA):</span>
              <span class="stat-value">‚Ç°${formatearMoneda(totalSinIVA)}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">üìà IVA (4%):</span>
              <span class="stat-value">‚Ç°${formatearMoneda(totalIVA)}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">üèÜ Total con IVA:</span>
              <span class="stat-value">‚Ç°${formatearMoneda(totalConIVA)}</span>
            </div>
          </div>
        </div>
      </div>
    `;

      return html;
    } catch (error) {
      console.error('Error generando reporte de procedimientos:', error);
      return `
        <div class="reporte-procedimientos-section">
          <h2>üìã Reporte de Procedimientos</h2>
          <p class="error-message">Error al mostrar el reporte: ${error.message}</p>
        </div>
      `;
    }
  }

  function calcular() {
    // üîß CAPTURAR PAR√ÅMETROS para evitar problemas de scope
    const parametros = {
      doctor: document.getElementById('doctor').value,
      mes: parseInt(document.getElementById('mes').value),
      anio: parseInt(document.getElementById('anio').value),
      quincena: document.getElementById('quincena').value
    };

    // Log de debugging
    console.log('=== DEBUGGING CALCULAR ===');
    console.log('üîß Par√°metros capturados:', parametros);

    // Usar la funci√≥n de validaci√≥n mejorada
    if (!validarEntradas(parametros.doctor, parametros.mes, parametros.anio, parametros.quincena)) {
      return;
    }

    // Mostrar mensaje de carga
    mostrarMensaje("üîç Buscando registros para " + parametros.doctor + "...", "info");

    // Limpiar resultados anteriores
    const divResultado = document.getElementById('resultado');
    if (divResultado) {
      divResultado.innerHTML = '<p>Cargando datos...</p>';
    }

    // ‚úÖ NUEVA ESTRATEGIA: Usar solo obtenerDetalleRegistrosSimplificado
    console.log('üìã Par√°metros capturados:', parametros);

    // Obtener registros detallados con c√°lculos (√∫nico llamado)
    google.script.run
      .withSuccessHandler(function (detalles) {
        console.log('=== REGISTROS DETALLADOS RECIBIDOS ===');
        console.log('Detalles:', detalles);

        if (!detalles || !detalles.detalleRegistros || detalles.detalleRegistros.length === 0) {
          mostrarMensaje("‚ö†Ô∏è No se encontraron registros para " + parametros.doctor, "warning");
          document.getElementById('resultado').innerHTML = '<p class="no-data">No hay procedimientos registrados en este per√≠odo.</p>';
          return;
        }

        console.log(`‚úÖ ${detalles.detalleRegistros.length} registros detallados obtenidos`);

        // Mostrar resultado basado solo en registros detallados
        mostrarResultadoCompleto(detalles, parametros.doctor);
      })
      .withFailureHandler(function (error) {
        console.error('‚ùå Error obteniendo registros:', error);
        mostrarMensaje("‚ùå Error al obtener datos: " + error.message, "error");
        document.getElementById('resultado').innerHTML = '<p class="error-message">Error: ' + error.message + '</p>';
      })
      .obtenerDetalleRegistrosSimplificado(parametros.doctor, parametros.mes, parametros.anio, parametros.quincena);
  }

  // ‚úÖ NUEVA FUNCI√ìN para mostrar resultado completo basado en DETALLES DE REGISTROS
  function mostrarResultadoCompleto(resumen, doctor) {
    console.log('=== MOSTRANDO RESULTADO COMPLETO ===');
    console.log('Datos finales:', resumen);

    // Verificar si hay registros detallados
    if (!resumen.detalleRegistros || resumen.detalleRegistros.length === 0) {
      mostrarMensaje("‚ö†Ô∏è No se encontraron procedimientos registrados para " + doctor + " en el per√≠odo seleccionado.", "warning");
      document.getElementById('resultado').innerHTML = '<p class="no-data">No hay procedimientos registrados en este per√≠odo.</p>';
      return;
    }

    // ‚úÖ USAR SOLO DETALLE DE REGISTROS CON C√ÅLCULOS
    const divResultado = document.getElementById('resultado');
    let htmlResultado = '';

    // Generar el reporte basado en los registros detallados
    try {
      console.log('Generando reporte basado en detalle de registros...');
      const detalleHtml = generarDetalleRegistros(resumen.detalleRegistros, doctor);
      if (detalleHtml) {
        htmlResultado += detalleHtml;
        console.log('‚úÖ Reporte basado en detalle de registros generado exitosamente');
      }
    } catch (error) {
      console.error('‚ùå Error generando reporte de registros:', error);
      mostrarMensaje("‚ùå Error generando el reporte: " + error.message, "error");
      return;
    }

    divResultado.innerHTML = htmlResultado;

    // Calcular totales desde los registros detallados
    const totalCalculado = resumen.detalleRegistros.reduce((sum, registro) => sum + (registro.subtotalRegistro || 0), 0);
    const totalConIVA = totalCalculado * 1.04; // Aplicar IVA del 4%

    // ACTUALIZAR LOS TOTALES PARA EL DESCUENTO
    mostrarTotalesReporte(totalCalculado, totalConIVA);

    const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    const selectedMonthName = monthNames[parseInt(document.getElementById('mes').value) - 1];
    const quincenaText = document.getElementById('quincena').value === 'completo' ? 'Mes Completo' : `Quincena ${document.getElementById('quincena').value}`;

    document.getElementById('reportTitle').textContent = `Reporte de Procedimientos y Consultas - ${doctor} - ${selectedMonthName} ${document.getElementById('anio').value} (${quincenaText})`;

    document.getElementById('action-section').style.display = 'block';
    document.getElementById('emailMessage').textContent = '';

    // Mensaje de √©xito
    mostrarMensaje("‚úÖ Reporte generado exitosamente.", "success");
  }

  // ================== DESCUENTO, EXTRA Y MOTIVO ==================
  let subtotalGlobal = 0;
  let totalConIVAGlobal = 0;

  function mostrarTotalesReporte(sub, total) {
    subtotalGlobal = sub || 0;  // ‚úÖ Valor por defecto
    totalConIVAGlobal = total || 0;  // ‚úÖ Valor por defecto

    const subtotalOriginal = getElement('subtotalOriginal');
    const granTotal = getElement('granTotal');

    if (subtotalOriginal) subtotalOriginal.textContent = formatearMoneda(subtotalGlobal);
    if (granTotal) granTotal.textContent = formatearMoneda(totalConIVAGlobal);

    actualizarDescuentoYExtra();
  }

  function actualizarDescuentoYExtra() {
    const montoDescontarInput = getElement('montoDescontar');
    const motivoDescuentoInput = getElement('motivoDescuento');
    const montoExtraInput = getElement('montoExtra');

    if (!montoDescontarInput || !motivoDescuentoInput || !montoExtraInput) return;

    const montoDescontar = Number(montoDescontarInput.value) || 0;
    const montoExtra = Number(montoExtraInput.value) || 0;
    const motivo = motivoDescuentoInput.value.trim();

    // Validar que los montos sean v√°lidos
    if (!validarMontos(montoDescontar) || !validarMontos(montoExtra)) {
      mostrarMensaje("Los montos deben ser n√∫meros v√°lidos y positivos.", "error");
      return;
    }

    // Validar que el descuento no sea mayor que el subtotal
    if (montoDescontar > subtotalGlobal) {
      mostrarMensaje("El descuento no puede ser mayor que el subtotal.", "error");
      return;
    }

    // Subtotal con descuento y extra
    const subtotalConDescuento = subtotalGlobal - montoDescontar + montoExtra;
    const subtotalConDescuentoEl = getElement('subtotalConDescuento');
    if (subtotalConDescuentoEl) {
      subtotalConDescuentoEl.textContent = formatearMoneda(subtotalConDescuento);
    }

    // Comentario
    let comentario = '';
    if (montoDescontar > 0 && motivo) {
      comentario += `Descuento aplicado: ‚Ç°${formatearMoneda(montoDescontar)} (${motivo})`;
    } else if (montoDescontar > 0) {
      comentario += `Descuento aplicado: ‚Ç°${formatearMoneda(montoDescontar)}`;
    }
    if (montoExtra > 0 && motivo) {
      comentario += (comentario ? ' | ' : '') + `Extra aplicado: ‚Ç°${formatearMoneda(montoExtra)} (${motivo})`;
    } else if (montoExtra > 0) {
      comentario += (comentario ? ' | ' : '') + `Extra aplicado: ‚Ç°${formatearMoneda(montoExtra)}`;
    }

    const comentarioEl = getElement('comentarioDescuento');
    if (comentarioEl) comentarioEl.textContent = comentario;

    // El gran total tambi√©n refleja el descuento y el extra
    const granTotalEl = getElement('granTotal');
    if (granTotalEl) {
      granTotalEl.textContent = formatearMoneda(totalConIVAGlobal - montoDescontar + montoExtra);
    }

    // Actualiza los spans para PDF
    const montoDescontarTextoEl = getElement('montoDescontarTexto');
    const montoExtraTextoEl = getElement('montoExtraTexto');
    const motivoDescuentoTextoEl = getElement('motivoDescuentoTexto');

    if (montoDescontarTextoEl) {
      montoDescontarTextoEl.textContent = montoDescontar > 0 ? `Descuento aplicado: ‚Ç°${formatearMoneda(montoDescontar)}` : '';
    }
    if (montoExtraTextoEl) {
      montoExtraTextoEl.textContent = montoExtra > 0 ? `Extra aplicado: ‚Ç°${formatearMoneda(montoExtra)}` : '';
    }
    if (motivoDescuentoTextoEl) {
      motivoDescuentoTextoEl.textContent = motivo ? `Motivo: ${motivo}` : '';
    }
  }

  // ================== VALIDACIONES ==================
  function validarEntradas(doctor, mes, anio, quincena) {
    console.log('=== VALIDANDO ENTRADAS ===');
    console.log('Doctor:', doctor, 'Tipo:', typeof doctor);
    console.log('Mes:', mes, 'Tipo:', typeof mes);
    console.log('A√±o:', anio, 'Tipo:', typeof anio);
    console.log('Quincena:', quincena, 'Tipo:', typeof quincena);

    // Validar doctor seleccionado
    if (!doctor || doctor.trim() === '') {
      mostrarMensaje("Por favor, seleccione un personal.", "error");
      return false;
    }

    // Validar a√±o
    const anioNum = parseInt(anio);
    const currentYear = new Date().getFullYear();
    if (isNaN(anioNum) || anioNum < 2020 || anioNum > currentYear + 1) {
      mostrarMensaje("Por favor, ingrese un a√±o v√°lido (2020 - " + (currentYear + 1) + ").", "error");
      return false;
    }

    // Validar mes
    const mesNum = parseInt(mes);
    if (isNaN(mesNum) || mesNum < 1 || mesNum > 12) {
      mostrarMensaje("Por favor, seleccione un mes v√°lido.", "error");
      return false;
    }

    // Validar quincena
    if (!quincena || !['1-15', '16-31', 'completo'].includes(quincena)) {
      mostrarMensaje("Por favor, seleccione una quincena v√°lida.", "error");
      console.log('Quincena inv√°lida. Valores permitidos: 1-15, 16-31, completo');
      return false;
    }

    console.log('‚úÖ Todas las validaciones pasaron');
    return true;
  }

  function validarEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }

  function validarMontos(monto) {
    const montoNum = Number(monto);
    return !isNaN(montoNum) && montoNum >= 0;
  }

  // ================== ENV√çO Y DESCARGA DE PDF ==================
  function enviarReporteCostos() {
    prepararParaPDF();
    const emailRecipient = document.getElementById('emailRecipient').value;
    const doctor = document.getElementById('doctor').value;
    const mes = document.getElementById('mes').value;
    const anio = parseInt(document.getElementById('anio').value);
    const quincena = document.getElementById('quincena').value;

    if (!validarEmail(emailRecipient)) {
      mostrarEmailMensaje("Por favor, ingrese un email v√°lido.", "error");
      return;
    }

    // ‚úÖ MEJORADO: Usar la misma funci√≥n para crear contenido que el PDF
    const reportContent = crearContenidoParaPDF();

    if (!reportContent) {
      mostrarEmailMensaje("‚ùå No hay contenido para enviar. Por favor, genere el reporte primero.", "error");
      return;
    }

    const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    const selectedMonthName = monthNames[parseInt(mes) - 1];
    const quincenaText = quincena === 'completo' ? 'Mes Completo' : `Quincena ${quincena}`;
    const subject = `Reporte de Procedimientos y Consultas - ${doctor} - ${selectedMonthName} ${anio} (${quincenaText})`;
    const fileName = `Reporte_Procedimientos_y_Consultas_${doctor.replace(/\s+/g, '_')}_${selectedMonthName}_${anio}_${quincena.replace('-', '_')}.pdf`;

    mostrarEmailMensaje("Enviando reporte...", "info");

    google.script.run
      .withSuccessHandler(response => {
        if (response.success) {
          mostrarEmailMensaje(response.message, "success");
        } else {
          mostrarEmailMensaje(response.message, "error");
        }
      })
      .withFailureHandler(error => {
        mostrarMensaje("‚ùå Error al enviar el reporte: " + error.message, "error");
      })
      .enviarReporteCostos(reportContent, emailRecipient, subject, fileName);
  }

  function descargarReporteCostosPDF() {
    // Crear contenido responsive para PDF
    const reportContent = crearContenidoParaPDF();

    if (!reportContent) {
      mostrarMensaje("‚ùå No hay contenido para generar el PDF. Por favor, genere el reporte primero.", "error");
      return;
    }

    // Verificar si el contenido es muy grande y optimizar si es necesario
    const contentSize = reportContent.length;
    console.log(`Tama√±o del contenido PDF: ${contentSize} caracteres`);

    if (contentSize > 50000) { // Si es muy grande, usar procesamiento por lotes
      console.log('Contenido grande detectado, procesando en lotes...');
      descargarPDFGrande(reportContent);
      return;
    }

    const doctor = document.getElementById('doctor').value;
    const mes = document.getElementById('mes').value;
    const anio = parseInt(document.getElementById('anio').value);
    const quincena = document.getElementById('quincena').value;
    const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    const selectedMonthName = monthNames[parseInt(mes) - 1];
    const fileName = `Reporte_Procedimientos_${doctor.replace(/\s+/g, '_')}_${selectedMonthName}_${anio}_${quincena.replace('-', '_')}.pdf`;
    const pageTitle = `Reporte de Procedimientos - ${doctor} - ${selectedMonthName} ${anio}`;

    mostrarEmailMensaje("Generando PDF optimizado...", "info");

    google.script.run
      .withSuccessHandler(function (base64Pdf) {
        if (base64Pdf) {
          const blob = b64toBlob(base64Pdf, 'application/pdf');
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          mostrarEmailMensaje("‚úÖ PDF descargado exitosamente con formato responsive.", "success");
        } else {
          mostrarMensaje("‚ùå No se pudo generar el PDF.", "error");
        }
      })
      .withFailureHandler(function (error) {
        console.error('Error generando PDF:', error);
        mostrarMensaje("‚ùå Error al generar el PDF: " + error.message, "error");
      })
      .generarPdfParaDescarga(reportContent, fileName, 'stylesReportePagoProcedimientos', pageTitle);
  }

  // ‚úÖ FUNCI√ìN AUXILIAR: Manejar PDFs grandes dividi√©ndolos en secciones
  function descargarPDFGrande(contenidoCompleto) {
    try {
      // Dividir el contenido en secciones m√°s peque√±as
      const registros = extraerDatosRegistros();
      const totalRegistros = registros.length;
      const registrosPorPagina = 10; // Limitar a 10 registros por p√°gina

      if (totalRegistros <= registrosPorPagina) {
        // Si no es tan grande, procesar normalmente
        procesarPDFNormal(contenidoCompleto);
        return;
      }

      // Dividir en p√°ginas
      const totalPaginas = Math.ceil(totalRegistros / registrosPorPagina);

      mostrarEmailMensaje(`Generando PDF en ${totalPaginas} p√°ginas para ${totalRegistros} registros...`, "info");

      // Generar PDF con paginaci√≥n
      const contenidoPaginado = generarContenidoPaginado(registros, registrosPorPagina);

      const doctor = document.getElementById('doctor').value;
      const mes = document.getElementById('mes').value;
      const anio = parseInt(document.getElementById('anio').value);
      const quincena = document.getElementById('quincena').value;
      const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
      const selectedMonthName = monthNames[parseInt(mes) - 1];
      const fileName = `Reporte_Paginado_${doctor.replace(/\s+/g, '_')}_${selectedMonthName}_${anio}_${quincena.replace('-', '_')}.pdf`;
      const pageTitle = `Reporte Paginado - ${doctor} - ${selectedMonthName} ${anio}`;

      google.script.run
        .withSuccessHandler(function (base64Pdf) {
          if (base64Pdf) {
            const blob = b64toBlob(base64Pdf, 'application/pdf');
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            mostrarEmailMensaje(`‚úÖ PDF paginado descargado exitosamente (${totalPaginas} p√°ginas).`, "success");
          } else {
            mostrarMensaje("‚ùå No se pudo generar el PDF paginado.", "error");
          }
        })
        .withFailureHandler(function (error) {
          console.error('Error generando PDF paginado:', error);
          mostrarMensaje("‚ùå Error al generar el PDF paginado: " + error.message, "error");
        })
        .generarPdfParaDescarga(contenidoPaginado, fileName, 'stylesReportePagoProcedimientos', pageTitle);

    } catch (error) {
      console.error('Error procesando PDF grande:', error);
      mostrarMensaje("‚ùå Error procesando PDF grande: " + error.message, "error");
    }
  }

  // ‚úÖ FUNCI√ìN AUXILIAR: Generar contenido paginado
  function generarContenidoPaginado(registros, registrosPorPagina) {
    const totalPaginas = Math.ceil(registros.length / registrosPorPagina);

    // Obtener datos generales
    const doctor = document.getElementById('doctor').value;
    const mes = document.getElementById('mes').value;
    const anio = document.getElementById('anio').value;
    const quincena = document.getElementById('quincena').value;
    const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    const selectedMonthName = monthNames[parseInt(mes) - 1];
    const quincenaText = quincena === 'completo' ? 'Mes Completo' : `Quincena ${quincena}`;

    // Obtener totales
    const subtotalOriginal = document.getElementById('subtotalOriginal')?.textContent || '0.00';
    const montoDescontar = document.getElementById('montoDescontar')?.value || '0';
    const motivoDescuento = document.getElementById('motivoDescuento')?.value || '';
    const subtotalConDescuento = document.getElementById('subtotalConDescuento')?.textContent || '0.00';
    const granTotal = document.getElementById('granTotal')?.textContent || '0.00';

    let contenidoPaginado = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <title>Reporte Paginado ${doctor} - ${selectedMonthName} ${anio}</title>
        <style>
          * { margin: 0; padding: 0; box-sizing: border-box; }
          body { 
            font-family: Arial, sans-serif; 
            font-size: 10px; 
            line-height: 1.3; 
            color: #333; 
            margin: 8px;
          }
          .pagina { 
            page-break-after: always; 
            margin-bottom: 20px; 
          }
          .pagina:last-child { 
            page-break-after: auto; 
          }
          .header { 
            text-align: center; 
            margin-bottom: 15px; 
            padding-bottom: 8px; 
            border-bottom: 2px solid #333; 
          }
          .header h1 { 
            font-size: 14px; 
            margin-bottom: 3px; 
            color: #000; 
          }
          .header .info { 
            font-size: 9px; 
            color: #666; 
          }
          .registro { 
            margin-bottom: 12px; 
            border: 1px solid #ddd; 
            page-break-inside: avoid; 
          }
          .registro-header { 
            background: #f5f5f5; 
            padding: 4px 6px; 
            border-bottom: 1px solid #ddd; 
            font-weight: bold; 
            font-size: 9px; 
          }
          .tabla { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 8px; 
          }
          .tabla th, .tabla td { 
            border: 1px solid #ddd; 
            padding: 2px 4px; 
            text-align: left; 
          }
          .tabla th { 
            background: #f0f0f0; 
            font-weight: bold; 
            font-size: 7px; 
          }
          .tabla .num { text-align: right; }
          .tabla .total-row { 
            background: #f9f9f9; 
            font-weight: bold; 
          }
          .pie-pagina { 
            position: fixed; 
            bottom: 10px; 
            width: 100%; 
            text-align: center; 
            font-size: 8px; 
            color: #666; 
          }
          .resumen-final { 
            margin-top: 15px; 
            padding: 8px; 
            background: #f9f9f9; 
            border: 1px solid #ddd; 
          }
          .resumen-final h3 { 
            font-size: 11px; 
            margin-bottom: 6px; 
            color: #000; 
          }
          .resumen-final table { 
            width: 100%; 
            border-collapse: collapse; 
          }
          .resumen-final td { 
            padding: 3px 6px; 
            border-bottom: 1px solid #ddd; 
            font-size: 9px; 
          }
          .resumen-final .gran-total { 
            font-weight: bold; 
            background: #e9e9e9; 
            border-top: 2px solid #333; 
          }
        </style>
      </head>
      <body>
    `;

    // Generar p√°ginas
    for (let pagina = 0; pagina < totalPaginas; pagina++) {
      const inicio = pagina * registrosPorPagina;
      const fin = Math.min(inicio + registrosPorPagina, registros.length);
      const registrosPagina = registros.slice(inicio, fin);

      contenidoPaginado += `
        <div class="pagina">
          <div class="header">
            <h1>Reporte de Procedimientos y Consultas</h1>
            <div class="info">
              <p><strong>${doctor}</strong> - ${selectedMonthName} ${anio} (${quincenaText})</p>
              <p>P√°gina ${pagina + 1} de ${totalPaginas} - Registros ${inicio + 1} a ${fin} de ${registros.length}</p>
            </div>
          </div>
      `;

      // Agregar registros de esta p√°gina
      registrosPagina.forEach(registro => {
        contenidoPaginado += `
          <div class="registro">
            <div class="registro-header">
              Registro #${registro.numero} - ${registro.fecha} - ${registro.tipo}
            </div>
            <table class="tabla">
              <thead>
                <tr>
                  <th style="width: 35%;">Procedimiento</th>
                  <th style="width: 8%;">Cant.</th>
                  <th style="width: 15%;">Costo Unit.</th>
                  <th style="width: 15%;">Sin IVA</th>
                  <th style="width: 12%;">IVA (4%)</th>
                  <th style="width: 15%;">Total</th>
                </tr>
              </thead>
              <tbody>
        `;

        // Agregar procedimientos
        registro.procedimientos.forEach(proc => {
          contenidoPaginado += `
            <tr>
              <td>${proc.nombre}</td>
              <td class="num">${proc.cantidad}</td>
              <td class="num">${proc.costoUnit}</td>
              <td class="num">${proc.sinIVA}</td>
              <td class="num">${proc.iva}</td>
              <td class="num">${proc.total}</td>
            </tr>
          `;
        });

        // Funci√≥n auxiliar para formatear moneda en PDF
        const formatearMonedaPDF = (valor) => {
          if (!valor || valor === '0.00' || valor === 0) {
            return '0,00';
          }
          const num = typeof valor === 'string' ? parseFloat(valor) : valor;
          if (isNaN(num)) return '0,00';

          // Formatear con separadores de miles (.) y decimales (,)
          return num.toLocaleString('es-ES', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          });
        };

        // Agregar total del registro
        contenidoPaginado += `
                <tr class="total-row">
                  <td colspan="3"><strong>Total del registro:</strong></td>
                  <td class="num"><strong>‚Ç°${formatearMonedaPDF(registro.totalRegistro.sinIVA)}</strong></td>
                  <td class="num"><strong>‚Ç°${formatearMonedaPDF(registro.totalRegistro.iva)}</strong></td>
                  <td class="num"><strong>‚Ç°${formatearMonedaPDF(registro.totalRegistro.total)}</strong></td>
                </tr>
              </tbody>
            </table>
          </div>
        `;
      });

      contenidoPaginado += `
        </div>
      `;
    }

    // Funci√≥n auxiliar para formatear valores de resumen (paginado)
    const formatearResumenPaginado = (valor) => {
      console.log('formatearResumenPaginado recibi√≥:', valor, 'tipo:', typeof valor);
      if (!valor) return '0,00';

      // Si es un n√∫mero, formatearlo directamente
      if (typeof valor === 'number') {
        const resultado = valor.toLocaleString('es-ES', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
        console.log('formatearResumenPaginado resultado (n√∫mero):', resultado);
        return resultado;
      }

      // Si es string, extraer el n√∫mero correctamente
      const num = parseFloat(valor.toString().replace(/[^\d.-]/g, ''));
      if (isNaN(num)) return '0,00';
      const resultado = num.toLocaleString('es-ES', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
      console.log('formatearResumenPaginado resultado (string):', resultado);
      return resultado;
    };

    // Agregar resumen final en la √∫ltima p√°gina
    contenidoPaginado += `
      <div class="resumen-final">
        <h3>Resumen General de Totales</h3>
        <table>
          <tr>
            <td><strong>Subtotal original:</strong></td>
            <td style="text-align: right;"><strong>‚Ç°${formatearResumenPaginado(subtotalOriginal)}</strong></td>
          </tr>
          ${montoDescontar > 0 ? `
          <tr>
            <td>Descuento aplicado:</td>
            <td style="text-align: right;">-‚Ç°${formatearResumenPaginado(montoDescontar)}</td>
          </tr>
          ` : ''}
          ${montoExtra > 0 ? `
          <tr>
            <td>Extra aplicado:</td>
            <td style="text-align: right;">+‚Ç°${formatearResumenPaginado(montoExtra)}</td>
          </tr>
          ` : ''}
          ${(montoDescontar > 0 || montoExtra > 0) && motivoDescuento ? `
          <tr>
            <td><strong>Motivo:</strong></td>
            <td style="text-align: right; font-style: italic;">${motivoDescuento}</td>
          </tr>
          ` : ''}
          ${(montoDescontar > 0 || montoExtra > 0) ? `
          <tr>
            <td><strong>Subtotal con ajustes:</strong></td>
            <td style="text-align: right;"><strong>‚Ç°${formatearResumenPaginado(subtotalConDescuento)}</strong></td>
          </tr>
          ` : ''}
          <tr class="gran-total">
            <td><strong>GRAN TOTAL:</strong></td>
            <td style="text-align: right;"><strong>‚Ç°${formatearResumenPaginado(granTotal)}</strong></td>
          </tr>
        </table>
      </div>
      
      </body>
      </html>
    `;

    return contenidoPaginado;
  }

  // ‚úÖ FUNCI√ìN AUXILIAR: Procesar PDF normal
  function procesarPDFNormal(contenido) {
    const doctor = document.getElementById('doctor').value;
    const mes = document.getElementById('mes').value;
    const anio = parseInt(document.getElementById('anio').value);
    const quincena = document.getElementById('quincena').value;
    const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    const selectedMonthName = monthNames[parseInt(mes) - 1];
    const fileName = `Reporte_Procedimientos_${doctor.replace(/\s+/g, '_')}_${selectedMonthName}_${anio}_${quincena.replace('-', '_')}.pdf`;
    const pageTitle = `Reporte de Procedimientos - ${doctor} - ${selectedMonthName} ${anio}`;

    google.script.run
      .withSuccessHandler(function (base64Pdf) {
        if (base64Pdf) {
          const blob = b64toBlob(base64Pdf, 'application/pdf');
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          mostrarEmailMensaje("‚úÖ PDF descargado exitosamente.", "success");
        } else {
          mostrarMensaje("‚ùå No se pudo generar el PDF.", "error");
        }
      })
      .withFailureHandler(function (error) {
        console.error('Error generando PDF:', error);
        mostrarMensaje("‚ùå Error al generar el PDF: " + error.message, "error");
      })
      .generarPdfParaDescarga(contenido, fileName, 'stylesReportePagoProcedimientos', pageTitle);
  }  // ‚úÖ NUEVA FUNCI√ìN: Crear contenido espec√≠fico para PDF con formato responsive
  function crearContenidoParaPDF() {
    try {
      // Obtener el contenido del resultado
      const resultadoDiv = document.getElementById('resultado');
      if (!resultadoDiv || !resultadoDiv.innerHTML.trim()) {
        console.log('No hay contenido en el div resultado');
        return null;
      }

      // Obtener par√°metros del reporte
      const doctor = document.getElementById('doctor').value;
      const mes = document.getElementById('mes').value;
      const anio = document.getElementById('anio').value;
      const quincena = document.getElementById('quincena').value;
      const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
      const selectedMonthName = monthNames[parseInt(mes) - 1];
      const quincenaText = quincena === 'completo' ? 'Mes Completo' : `Quincena ${quincena}`;

      // Obtener informaci√≥n de los totales (extraer valores num√©ricos limpios)
      const subtotalOriginalText = document.getElementById('subtotalOriginal')?.textContent || '0.00';
      const subtotalConDescuentoText = document.getElementById('subtotalConDescuento')?.textContent || '0.00';
      const granTotalText = document.getElementById('granTotal')?.textContent || '0.00';

      // Funci√≥n auxiliar para extraer n√∫mero de formato espa√±ol (1.234.567,89)
      const extraerNumeroEspanol = (texto) => {
        if (!texto) return 0;
        // Eliminar s√≠mbolo de moneda y espacios
        let numero = texto.replace(/[‚Ç°\s]/g, '');

        // Si el texto tiene formato espa√±ol (puntos como separadores de miles, coma como decimal)
        if (numero.includes(',')) {
          // Separar parte entera y decimal
          const partes = numero.split(',');
          if (partes.length === 2) {
            // Eliminar puntos de la parte entera (separadores de miles)
            const parteEntera = partes[0].replace(/\./g, '');
            const parteDecimal = partes[1];
            numero = parteEntera + '.' + parteDecimal;
          }
        } else {
          // Si no hay coma, eliminar puntos (podr√≠an ser separadores de miles)
          numero = numero.replace(/\./g, '');
        }

        const resultado = parseFloat(numero) || 0;
        console.log(`extraerNumeroEspanol: "${texto}" -> ${resultado}`);
        return resultado;
      };

      // Limpiar y convertir a n√∫meros los valores del DOM usando formato espa√±ol
      const subtotalOriginal = extraerNumeroEspanol(subtotalOriginalText);
      const montoDescontar = parseFloat(document.getElementById('montoDescontar')?.value || '0') || 0;
      const montoExtra = parseFloat(document.getElementById('montoExtra')?.value || '0') || 0;
      const motivoDescuento = document.getElementById('motivoDescuento')?.value || '';
      const subtotalConDescuento = extraerNumeroEspanol(subtotalConDescuentoText);
      const granTotal = extraerNumeroEspanol(granTotalText);

      // üêõ DEBUG: Verificar valores limpios para PDF
      console.log('=== VALORES PARA PDF (LIMPIOS) ===');
      console.log('subtotalOriginalText:', subtotalOriginalText);
      console.log('subtotalOriginal (limpio):', subtotalOriginal);
      console.log('montoDescontar:', montoDescontar);
      console.log('montoExtra:', montoExtra);
      console.log('motivoDescuento:', motivoDescuento);
      console.log('subtotalConDescuentoText:', subtotalConDescuentoText);
      console.log('subtotalConDescuento (limpio):', subtotalConDescuento);
      console.log('granTotalText:', granTotalText);
      console.log('granTotal (limpio):', granTotal);

      // üîç DEBUG ESPEC√çFICO para condiciones de descuento
      console.log('=== DEBUG CONDICIONES DESCUENTO ===');
      console.log('montoDescontar > 0:', montoDescontar > 0);
      console.log('montoExtra > 0:', montoExtra > 0);
      console.log('Tiene descuento?:', montoDescontar > 0);
      console.log('Tiene extra?:', montoExtra > 0);
      console.log('motivoDescuento existe:', !!motivoDescuento);
      console.log('===============================');

      // üîç DIAGN√ìSTICO ADICIONAL: Verificar si los valores del DOM son los esperados
      const testRegex = /[\d,.]+/g;
      const numbersInOriginal = subtotalOriginalText.match(testRegex);
      const numbersInGranTotal = granTotalText.match(testRegex);
      console.log('N√∫meros encontrados en subtotalOriginalText:', numbersInOriginal);
      console.log('N√∫meros encontrados en granTotalText:', numbersInGranTotal);
      console.log('================================');      // Extraer datos de los registros para procesamiento optimizado
      const registros = extraerDatosRegistros();

      if (!registros || registros.length === 0) {
        console.log('No se encontraron registros para procesar');
        return null;
      }

      // Generar HTML optimizado y responsive
      const htmlParaPDF = generarHTMLResponsive({
        doctor,
        selectedMonthName,
        anio,
        quincenaText,
        registros,
        subtotalOriginal,
        montoDescontar,
        montoExtra,
        motivoDescuento,
        subtotalConDescuento,
        granTotal
      });

      console.log(`Contenido PDF creado: ${registros.length} registros, ${htmlParaPDF.length} caracteres`);
      return htmlParaPDF;

    } catch (error) {
      console.error('Error creando contenido para PDF:', error);
      return null;
    }
  }

  // ‚úÖ FUNCI√ìN AUXILIAR: Extraer datos de registros del DOM
  function extraerDatosRegistros() {
    const registros = [];

    try {
      // Buscar todos los elementos de registro
      const registroElements = document.querySelectorAll('.registro-item');

      registroElements.forEach((registroEl, index) => {
        const numeroRegistro = index + 1;
        const fecha = registroEl.querySelector('.registro-fecha')?.textContent || '';
        const tipo = registroEl.querySelector('.registro-tipo')?.textContent || '';
        const fila = registroEl.querySelector('.registro-fila')?.textContent || '';

        // Extraer procedimientos
        const procedimientos = [];
        const procedimientoRows = registroEl.querySelectorAll('.tabla-procedimientos-detalle tbody tr');

        procedimientoRows.forEach(row => {
          const cells = row.querySelectorAll('td');
          if (cells.length >= 6) {
            const procedimiento = {
              nombre: cells[0]?.textContent?.trim() || '',
              cantidad: cells[1]?.textContent?.trim() || '',
              costoUnit: cells[2]?.textContent?.trim() || '',
              sinIVA: cells[3]?.textContent?.trim() || '',
              iva: cells[4]?.textContent?.trim() || '',
              total: cells[5]?.textContent?.trim() || ''
            };

            // Solo agregar si no es una fila de total
            if (!procedimiento.nombre.includes('Total del registro') && procedimiento.nombre !== '') {
              procedimientos.push(procedimiento);
            }
          }
        });

        // Calcular total del registro SIEMPRE desde los procedimientos (m√°s confiable)
        let totalSinIva = 0;
        let totalIva = 0;
        let totalConIva = 0;

        // Funci√≥n auxiliar para limpiar y convertir valores monetarios
        const limpiarYConvertir = (texto) => {
          if (!texto) return 0;
          // Remover s√≠mbolos y espacios, mantener solo n√∫meros, puntos y comas
          let limpio = texto.replace(/‚Ç°/g, '').replace(/\s/g, '').replace(/[^0-9.,]/g, '');
          // Convertir comas decimales en puntos si es necesario
          if (limpio.includes(',') && !limpio.includes('.')) {
            limpio = limpio.replace(',', '.');
          } else if (limpio.includes(',') && limpio.includes('.')) {
            // Si tiene ambos, asumir que la coma es separador de miles
            limpio = limpio.replace(/,/g, '');
          }
          return parseFloat(limpio) || 0;
        };

        procedimientos.forEach(proc => {
          totalSinIva += limpiarYConvertir(proc.sinIVA);
          totalIva += limpiarYConvertir(proc.iva);
          totalConIva += limpiarYConvertir(proc.total);
        });

        const totalRegistro = {
          sinIVA: totalSinIva.toFixed(2),
          iva: totalIva.toFixed(2),
          total: totalConIva.toFixed(2)
        };

        if (procedimientos.length > 0) {
          registros.push({
            numero: numeroRegistro,
            fecha,
            tipo,
            fila,
            procedimientos,
            totalRegistro
          });
        }
      });

      return registros;

    } catch (error) {
      console.error('Error extrayendo datos de registros:', error);
      return [];
    }
  }

  // ‚úÖ FUNCI√ìN AUXILIAR: Generar HTML responsive optimizado
  function generarHTMLResponsive(datos) {
    const {
      doctor,
      selectedMonthName,
      anio,
      quincenaText,
      registros,
      subtotalOriginal,
      montoDescontar,
      montoExtra,
      motivoDescuento,
      subtotalConDescuento,
      granTotal
    } = datos;

    // Estilos CSS optimizados para PDF
    const estilosResponsive = `
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
          font-family: Arial, sans-serif; 
          font-size: 11px; 
          line-height: 1.3; 
          color: #333; 
          margin: 10px;
        }
        .pdf-header { 
          text-align: center; 
          margin-bottom: 20px; 
          padding-bottom: 10px; 
          border-bottom: 2px solid #333; 
          page-break-after: avoid;
        }
        .pdf-header h1 { 
          font-size: 18px; 
          margin-bottom: 5px; 
          color: #000; 
        }
        .pdf-header .info { 
          font-size: 10px; 
          color: #666; 
        }
        .registro { 
          margin-bottom: 15px; 
          border: 1px solid #ddd; 
          page-break-inside: avoid; 
        }
        .registro-header { 
          background: #f5f5f5; 
          padding: 5px 8px; 
          border-bottom: 1px solid #ddd; 
          font-weight: bold; 
        }
        .tabla-proc { 
          width: 100%; 
          border-collapse: collapse; 
          font-size: 9px; 
        }
        .tabla-proc th, .tabla-proc td { 
          border: 1px solid #ddd; 
          padding: 3px 5px; 
          text-align: left; 
        }
        .tabla-proc th { 
          background: #FE7743; 
          color: white;
          font-weight: bold; 
          font-size: 8px; 
        }
        .tabla-proc td.num { text-align: right; }
        .tabla-proc .total-row { 
          background: #f9f9f9; 
          font-weight: bold; 
        }
        .resumen { 
          margin-top: 20px; 
          padding: 10px; 
          background: #f9f9f9; 
          border: 1px solid #ddd; 
          page-break-inside: avoid; 
        }
        .resumen h3 { 
          font-size: 12px; 
          margin-bottom: 8px; 
          color: #000; 
        }
        .resumen table { 
          width: 100%; 
          border-collapse: collapse; 
        }
        .resumen td { 
          padding: 4px 8px; 
          border-bottom: 1px solid #ddd; 
        }
        .resumen .gran-total { 
          font-weight: bold; 
          background: #e9e9e9; 
          border-top: 2px solid #333; 
        }
        @media print {
          body { margin: 0; }
          .registro { page-break-inside: avoid; }
        }
      </style>
    `;

    // Generar contenido del cuerpo
    let contenidoRegistros = '';

    // Funci√≥n auxiliar para formatear moneda en PDF
    const formatearMonedaPDF = (valor) => {
      if (!valor || valor === '0.00' || valor === 0) {
        return '0,00';
      }
      const num = typeof valor === 'string' ? parseFloat(valor) : valor;
      if (isNaN(num)) return '0,00';

      // Formatear con separadores de miles (.) y decimales (,)
      return num.toLocaleString('es-ES', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    };

    registros.forEach(registro => {
      contenidoRegistros += `
        <div class="registro">
          <div class="registro-header">
            Registro #${registro.numero} - ${registro.fecha} - ${registro.tipo}
          </div>
          <table class="tabla-proc">
            <thead>
              <tr>
                <th style="width: 35%;">Procedimiento</th>
                <th style="width: 8%;">Cant.</th>
                <th style="width: 15%;">Costo Unit.</th>
                <th style="width: 15%;">Sin IVA</th>
                <th style="width: 12%;">IVA (4%)</th>
                <th style="width: 15%;">Total</th>
              </tr>
            </thead>
            <tbody>
      `;

      // Agregar procedimientos
      registro.procedimientos.forEach(proc => {
        contenidoRegistros += `
          <tr>
            <td>${proc.nombre}</td>
            <td class="num">${proc.cantidad}</td>
            <td class="num">${proc.costoUnit}</td>
            <td class="num">${proc.sinIVA}</td>
            <td class="num">${proc.iva}</td>
            <td class="num">${proc.total}</td>
          </tr>
        `;
      });

      // Agregar total del registro
      contenidoRegistros += `
              <tr class="total-row">
                <td colspan="3"><strong>Total del registro:</strong></td>
                <td class="num"><strong>‚Ç°${formatearMonedaPDF(registro.totalRegistro.sinIVA)}</strong></td>
                <td class="num"><strong>‚Ç°${formatearMonedaPDF(registro.totalRegistro.iva)}</strong></td>
                <td class="num"><strong>‚Ç°${formatearMonedaPDF(registro.totalRegistro.total)}</strong></td>
              </tr>
            </tbody>
          </table>
        </div>
      `;
    });

    // Generar secci√≥n de resumen
    const fechaGeneracion = new Date().toLocaleDateString('es-ES', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });

    // Funci√≥n auxiliar para formatear valores de resumen
    const formatearResumen = (valor) => {
      console.log('formatearResumen recibi√≥:', valor, 'tipo:', typeof valor);
      if (!valor) return '0,00';

      // Si es un n√∫mero, formatearlo directamente
      if (typeof valor === 'number') {
        const resultado = valor.toLocaleString('es-ES', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
        console.log('formatearResumen resultado (n√∫mero):', resultado);
        return resultado;
      }

      // Si es string, extraer el n√∫mero correctamente
      const num = parseFloat(valor.toString().replace(/[^\d.-]/g, ''));
      if (isNaN(num)) return '0,00';
      const resultado = num.toLocaleString('es-ES', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
      console.log('formatearResumen resultado (string):', resultado);
      return resultado;
    };

    const resumen = `
      <div class="resumen">
        <h3>Resumen de Totales</h3>
        <table>
          <tr>
            <td><strong>Subtotal original:</strong></td>
            <td style="text-align: right;"><strong>‚Ç°${formatearResumen(subtotalOriginal)}</strong></td>
          </tr>
          ${montoDescontar > 0 ? `
          <tr>
            <td>Descuento aplicado:</td>
            <td style="text-align: right;">-‚Ç°${formatearResumen(montoDescontar)}</td>
          </tr>
          ` : ''}
          ${montoExtra > 0 ? `
          <tr>
            <td>Extra aplicado:</td>
            <td style="text-align: right;">+‚Ç°${formatearResumen(montoExtra)}</td>
          </tr>
          ` : ''}
          ${(montoDescontar > 0 || montoExtra > 0) && motivoDescuento ? `
          <tr>
            <td><strong>Motivo:</strong></td>
            <td style="text-align: right; font-style: italic;">${motivoDescuento}</td>
          </tr>
          ` : ''}
          ${(montoDescontar > 0 || montoExtra > 0) ? `
          <tr>
            <td><strong>Subtotal con ajustes:</strong></td>
            <td style="text-align: right;"><strong>‚Ç°${formatearResumen(subtotalConDescuento)}</strong></td>
          </tr>
          ` : ''}
          <tr class="gran-total">
            <td><strong>GRAN TOTAL:</strong></td>
            <td style="text-align: right;"><strong>‚Ç°${formatearResumen(granTotal)}</strong></td>
          </tr>
        </table>
      </div>
    `;

    // HTML final optimizado
    const htmlFinal = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <title>Reporte ${doctor} - ${selectedMonthName} ${anio}</title>
        ${estilosResponsive}
      </head>
      <body>
        <div class="pdf-header">
          <h1>Reporte de Procedimientos y Consultas</h1>
          <div class="info">
            <p><strong>${doctor}</strong> - ${selectedMonthName} ${anio} (${quincenaText})</p>
            <p>Generado el: ${fechaGeneracion}</p>
            <p>Total de registros: ${registros.length}</p>
          </div>
        </div>
        
        ${contenidoRegistros}
        
        ${resumen}
      </body>
      </html>
    `;

    return htmlFinal;
  } function b64toBlob(b64Data, contentType = '', sliceSize = 512) {
    const byteCharacters = atob(b64Data);
    const byteArrays = [];

    for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
      const slice = byteCharacters.slice(offset, offset + sliceSize);
      const byteNumbers = new Array(slice.length);
      for (let i = 0; i < slice.length; i++) {
        byteNumbers[i] = slice.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      byteArrays.push(byteArray);
    }

    const blob = new Blob(byteArrays, { type: contentType });
    return blob;
  }

  // ================== MENSAJES ==================
  function mostrarEmailMensaje(mensaje, tipo) {
    let mensajeDiv = document.getElementById('emailMessage');
    if (!mensajeDiv) {
      mensajeDiv = document.createElement('div');
      mensajeDiv.id = 'emailMessage';
      document.getElementById('action-section').appendChild(mensajeDiv);
    }
    mensajeDiv.className = '';
    mensajeDiv.textContent = mensaje;
    if (tipo === 'success') {
      mensajeDiv.classList.add('alert-success');
    } else if (tipo === 'error') {
      mensajeDiv.classList.add('alert-error');
    } else if (tipo === 'info') {
      mensajeDiv.classList.add('alert-info');
    }
    if (tipo !== 'error') {
      setTimeout(() => {
        mensajeDiv.textContent = '';
        mensajeDiv.className = '';
      }, 5000);
    }
  }

  function mostrarMensaje(mensaje, tipo) {
    let mensajeDiv = document.getElementById('formMessage') || document.getElementById('emailMessage');
    if (!mensajeDiv) {
      mensajeDiv = document.createElement('div');
      mensajeDiv.id = 'formMessage';
      const controlsDiv = document.getElementById('reportControls');
      if (controlsDiv) {
        controlsDiv.prepend(mensajeDiv);
      } else {
        document.body.prepend(mensajeDiv);
      }
    }
    mensajeDiv.className = '';
    mensajeDiv.textContent = mensaje;
    if (tipo === 'success') {
      mensajeDiv.classList.add('alert-success');
    } else if (tipo === 'error') {
      mensajeDiv.classList.add('alert-error');
    } else if (tipo === 'info') {
      mensajeDiv.classList.add('alert-info');
    } else if (tipo === 'warning') {
      mensajeDiv.classList.add('alert-warning');
    }

    // Limpiar mensaje autom√°ticamente despu√©s de un tiempo (excepto errores)
    if (tipo !== 'error') {
      setTimeout(() => {
        mensajeDiv.textContent = '';
        mensajeDiv.className = '';
      }, tipo === 'success' ? 3000 : 5000);
    }
  }

  // ================== FUNCIONES DE UTILIDAD PARA PDF ==================
  function prepararParaPDF() {
    // Ocultar elementos no necesarios para el PDF
    const elementsToHide = document.querySelectorAll('.no-print, .btn, .form-group, #reportControls');
    elementsToHide.forEach(el => {
      if (el) {
        el.style.display = 'none';
        el.setAttribute('data-was-visible', 'true');
      }
    });

    // Agregar clase para estilos de impresi√≥n
    document.body.classList.add('pdf-mode');
  }

  function restaurarInputsPDF() {
    // Restaurar elementos ocultos
    const elementsToShow = document.querySelectorAll('[data-was-visible="true"]');
    elementsToShow.forEach(el => {
      el.style.display = '';
      el.removeAttribute('data-was-visible');
    });

    // Remover clase de modo PDF
    document.body.classList.remove('pdf-mode');
  }

  // ================== CACHE DE ELEMENTOS DOM ==================
  let cachedElements = {};

  function getElement(id) {
    if (!cachedElements[id]) {
      cachedElements[id] = document.getElementById(id);
    }
    return cachedElements[id];
  }

  function formatearMoneda(cantidad) {
    return cantidad.toLocaleString('es-CR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  // ================== FUNCIONES DE DEBUGGING ==================

  function diagnosticarCalculo() {
    const doctor = document.getElementById('doctor').value;
    const mes = document.getElementById('mes').value;
    const anio = document.getElementById('anio').value;
    const quincena = document.getElementById('quincena').value;

    if (!doctor) {
      mostrarMensaje("Por favor, seleccione un doctor primero.", "error");
      return;
    }

    mostrarMensaje("üîç Diagnosticando problema de c√°lculo...", "info");

    google.script.run
      .withSuccessHandler(function (resultado) {
        console.log('=== DIAGN√ìSTICO COMPLETO ===');
        console.log('Resultado:', resultado);

        let mensaje = `DIAGN√ìSTICO PARA "${resultado.nombreBuscado}":\n\n`;
        mensaje += `Total registros encontrados: ${resultado.totalRegistros}\n`;
        if (resultado.registrosValidosFecha !== undefined) {
          mensaje += `Registros con fecha v√°lida: ${resultado.registrosValidosFecha}\n`;
          mensaje += `Registros con fecha inv√°lida: ${resultado.registrosInvalidosFecha}\n`;
        }
        if (resultado.primerRegistro) {
          mensaje += `Primer registro: ${resultado.primerRegistro}\n`;
          mensaje += `√öltimo registro: ${resultado.ultimoRegistro}\n`;
        }

        alert(mensaje);
        mostrarMensaje("‚úÖ Diagn√≥stico completado. Revise la consola para detalles.", "success");
      })
      .withFailureHandler(function (error) {
        console.error('Error en diagn√≥stico:', error);
        mostrarMensaje("‚ùå Error al diagnosticar: " + error.message, "error");
      })
      .diagnosticarFechasPersonal(doctor);
  }

  function buscarPersonalPorNombre() {
    const nombreBuscar = prompt("Ingrese el nombre (o parte del nombre) a buscar:");
    if (!nombreBuscar || nombreBuscar.trim() === '') {
      mostrarMensaje("B√∫squeda cancelada.", "info");
      return;
    }

    mostrarMensaje("üîç Buscando personal que contenga '" + nombreBuscar + "'...", "info");

    google.script.run
      .withSuccessHandler(function (resultados) {
        console.log('Resultados de b√∫squeda:', resultados);

        let mensaje = `RESULTADOS DE B√öSQUEDA PARA "${nombreBuscar}":\n\n`;
        if (resultados.coincidenciasExactas.length > 0) {
          mensaje += "COINCIDENCIAS EXACTAS:\n";
          resultados.coincidenciasExactas.forEach((nombre, index) => {
            mensaje += `${index + 1}. ${nombre}\n`;
          });
          mensaje += "\n";
        }

        if (resultados.coincidenciasParciales.length > 0) {
          mensaje += "COINCIDENCIAS PARCIALES:\n";
          resultados.coincidenciasParciales.forEach((nombre, index) => {
            mensaje += `${index + 1}. ${nombre}\n`;
          });
        }

        if (resultados.coincidenciasExactas.length === 0 && resultados.coincidenciasParciales.length === 0) {
          mensaje += "No se encontraron coincidencias.";
        }

        alert(mensaje);
        mostrarMensaje("‚úÖ B√∫squeda completada.", "success");
      })
      .withFailureHandler(function (error) {
        console.error('Error en b√∫squeda:', error);
        mostrarMensaje("‚ùå Error al buscar: " + error.message, "error");
      })
      .buscarPersonalPorNombre(nombreBuscar);
  }

  function verificarDatosPersonal() {
    const doctor = document.getElementById('doctor').value;

    if (!doctor) {
      mostrarMensaje("Por favor, seleccione un personal primero.", "error");
      return;
    }

    mostrarMensaje("üîç Verificando datos para " + doctor + "...", "info");

    google.script.run
      .withSuccessHandler(function (resultado) {
        console.log('Verificaci√≥n de datos:', resultado);
        let mensaje = `Datos encontrados para ${doctor}:\n`;
        mensaje += `- Total de registros: ${resultado.totalRegistros || 0}\n`;
        mensaje += `- Rango de fechas: ${resultado.fechaInicio || 'N/A'} - ${resultado.fechaFin || 'N/A'}\n`;
        mensaje += `- Procedimientos √∫nicos: ${resultado.tiposProcedimientos || 0}`;

        alert(mensaje);
        mostrarMensaje("‚úÖ Verificaci√≥n completada. Revise la consola para m√°s detalles.", "success");
      })
      .withFailureHandler(function (error) {
        console.error('Error en verificaci√≥n:', error);
        mostrarMensaje("‚ùå Error al verificar datos: " + error.message, "error");
      })
      .verificarDatosPersonal(doctor);
  }

  function listarPersonalDisponible() {
    mostrarMensaje("üîç Obteniendo lista completa de personal...", "info");

    google.script.run
      .withSuccessHandler(function (personalCompleto) {
        console.log('Personal completo:', personalCompleto);
        let mensaje = "Personal disponible en RegistrosProcedimientos:\n";
        personalCompleto.forEach((nombre, index) => {
          mensaje += `${index + 1}. ${nombre}\n`;
        });

        alert(mensaje);
        mostrarMensaje("‚úÖ Lista obtenida. Revise la consola para m√°s detalles.", "success");
      })
      .withFailureHandler(function (error) {
        console.error('Error al obtener personal:', error);
        mostrarMensaje("‚ùå Error al obtener personal: " + error.message, "error");
      })
      .obtenerPersonalCompleto();
  }

  // ================== NUEVA FUNCI√ìN DE DIAGN√ìSTICO DE FILTRADO ==================
  function diagnosticarFiltroPersonal() {
    const doctor = document.getElementById('doctor').value;

    if (!doctor) {
      mostrarMensaje("‚ö†Ô∏è Por favor seleccione un nombre primero.", "warning");
      return;
    }

    mostrarMensaje("üîç Diagnosticando filtrado para: " + doctor, "info");

    google.script.run
      .withSuccessHandler(function (resultado) {
        console.log('=== DIAGN√ìSTICO DE FILTRADO ===');
        console.log('Resultado completo:', resultado);

        let mensaje = `DIAGN√ìSTICO DE FILTRADO PARA: ${doctor}\n\n`;
        mensaje += `‚úÖ Registros encontrados: ${resultado.totalCoincidencias}\n`;
        mensaje += `‚ö†Ô∏è Posibles falsos positivos: ${resultado.falsosPositivos}\n\n`;

        if (resultado.detallesFalsosPositivos && resultado.detallesFalsosPositivos.length > 0) {
          mensaje += "FALSOS POSITIVOS DETECTADOS:\n";
          resultado.detallesFalsosPositivos.forEach(fp => {
            mensaje += `- Fila ${fp.fila}: "${fp.nombre}" (${fp.fecha})\n`;
          });
        } else {
          mensaje += "‚úÖ No se detectaron falsos positivos.\n";
        }

        mensaje += "\nRevise la consola del navegador para m√°s detalles.";

        alert(mensaje);

        if (resultado.falsosPositivos > 0) {
          mostrarMensaje("‚ö†Ô∏è Se detectaron posibles falsos positivos. Revise el diagn√≥stico.", "warning");
        } else {
          mostrarMensaje("‚úÖ Filtrado correcto. No hay falsos positivos detectados.", "success");
        }
      })
      .withFailureHandler(function (error) {
        console.error('Error en diagn√≥stico de filtrado:', error);
        mostrarMensaje("‚ùå Error al diagnosticar filtrado: " + error.message, "error");
      })
      .diagnosticarFiltradoPersonal(doctor);
  }

  // ================== NUEVA FUNCI√ìN DE PRUEBA DE COMUNICACI√ìN ==================
  function probarComunicacionServidor() {
    mostrarMensaje("üß™ Probando comunicaci√≥n con el servidor...", "info");

    google.script.run
      .withSuccessHandler(function (resultado) {
        console.log('=== PRUEBA DE COMUNICACI√ìN ===');
        console.log('Resultado:', resultado);
        console.log('Tipo:', typeof resultado);

        if (resultado && resultado.mensaje === "Conexi√≥n exitosa") {
          mostrarMensaje("‚úÖ Comunicaci√≥n exitosa con el servidor", "success");
          alert(`‚úÖ COMUNICACI√ìN EXITOSA\nMensaje: ${resultado.mensaje}\nTimestamp: ${resultado.timestamp}\ndetalleRegistros: ${resultado.detalleRegistros ? 'Presente' : 'Ausente'}`);
        } else {
          mostrarMensaje("‚ö†Ô∏è Respuesta inesperada del servidor", "warning");
          alert(`‚ö†Ô∏è RESPUESTA INESPERADA\n${JSON.stringify(resultado, null, 2)}`);
        }
      })
      .withFailureHandler(function (error) {
        console.error('Error en comunicaci√≥n:', error);
        mostrarMensaje("‚ùå Error de comunicaci√≥n: " + error.message, "error");
        alert(`‚ùå ERROR DE COMUNICACI√ìN\n${error.message}`);
      })
      .probarConexion();
  }

  function probarCalcularCostosReales() {
    const doctor = document.getElementById('doctor').value;

    if (!doctor) {
      mostrarMensaje("‚ö†Ô∏è Por favor seleccione un nombre primero.", "warning");
      return;
    }

    mostrarMensaje("üß™ Probando calcularCostos con datos reales...", "info");

    google.script.run
      .withSuccessHandler(function (resultado) {
        console.log('=== PRUEBA calcularCostos REAL ===');
        console.log('Resultado completo:', resultado);
        console.log('Tipo:', typeof resultado);

        if (resultado === null) {
          mostrarMensaje("‚ùå calcularCostos retorn√≥ NULL", "error");
          alert("‚ùå ERROR: calcularCostos retorn√≥ NULL\nRevisa los logs de Google Apps Script para m√°s detalles.");
        } else {
          mostrarMensaje("‚úÖ calcularCostos ejecutado correctamente", "success");
          const mensaje = `‚úÖ RESULTADO calcularCostos:\n` +
            `Registros: ${resultado.detalleRegistros ? resultado.detalleRegistros.length : 0}\n` +
            `Total: $${resultado.totales ? resultado.totales.total_con_iva : 0}\n` +
            `Estructura: ${JSON.stringify(resultado, null, 2).substring(0, 200)}...`;
          alert(mensaje);
        }
      })
      .withFailureHandler(function (error) {
        console.error('Error en calcularCostos:', error);
        mostrarMensaje("‚ùå Error en calcularCostos: " + error.message, "error");
        alert(`‚ùå ERROR EN calcularCostos\n${error.message}`);
      })
      .calcularCostos(doctor, 7, 2025, "completo");
  }

  // ================== NUEVAS FUNCIONES DE PRUEBA PARA DIVISI√ìN DE DATOS ==================

  function probarCalcularCostosSimple() {
    const doctor = document.getElementById('doctor').value;

    if (!doctor) {
      mostrarMensaje("‚ö†Ô∏è Por favor seleccione un nombre primero.", "warning");
      return;
    }

    mostrarMensaje("üß™ Probando calcularCostosSimple...", "info");

    google.script.run
      .withSuccessHandler(function (resultado) {
        console.log('=== PRUEBA calcularCostosSimple ===');
        console.log('Resultado:', resultado);

        if (resultado === null) {
          mostrarMensaje("‚ùå calcularCostosSimple retorn√≥ NULL", "error");
        } else {
          mostrarMensaje("‚úÖ calcularCostosSimple ejecutado correctamente", "success");
          const mensaje = `‚úÖ RESULTADO calcularCostosSimple:\n` +
            `Metadatos: ${resultado.metadatos ? resultado.metadatos.numeroRegistros : 0} registros\n` +
            `Total: $${resultado.totales ? resultado.totales.total_con_iva : 0}\n` +
            `Tama√±o JSON: ${JSON.stringify(resultado).length} caracteres`;
          alert(mensaje);
        }
      })
      .withFailureHandler(function (error) {
        console.error('Error en calcularCostosSimple:', error);
        mostrarMensaje("‚ùå Error en calcularCostosSimple: " + error.message, "error");
      })
      .calcularCostosSimple(doctor, 7, 2025, "completo");
  }

  function probarObtenerDetalleRegistros() {
    const doctor = document.getElementById('doctor').value;

    if (!doctor) {
      mostrarMensaje("‚ö†Ô∏è Por favor seleccione un nombre primero.", "warning");
      return;
    }

    mostrarMensaje("üß™ Probando obtenerDetalleRegistros...", "info");

    google.script.run
      .withSuccessHandler(function (resultado) {
        console.log('=== PRUEBA obtenerDetalleRegistros ===');
        console.log('Resultado:', resultado);

        if (resultado === null) {
          mostrarMensaje("‚ùå obtenerDetalleRegistros retorn√≥ NULL", "error");
        } else {
          mostrarMensaje("‚úÖ obtenerDetalleRegistros ejecutado correctamente", "success");
          const mensaje = `‚úÖ RESULTADO obtenerDetalleRegistros:\n` +
            `Registros encontrados: ${resultado.detalleRegistros ? resultado.detalleRegistros.length : 0}\n` +
            `Tama√±o JSON: ${JSON.stringify(resultado).length} caracteres\n` +
            `Metadatos: ${JSON.stringify(resultado.metadatos, null, 2)}`;
          alert(mensaje);
        }
      })
      .withFailureHandler(function (error) {
        console.error('Error en obtenerDetalleRegistros:', error);
        mostrarMensaje("‚ùå Error en obtenerDetalleRegistros: " + error.message, "error");
      })
      .obtenerDetalleRegistros(doctor, 7, 2025, "completo");
  }

  function probarDetallesMinimo() {
    const doctor = document.getElementById('doctor').value;

    if (!doctor) {
      mostrarMensaje("‚ö†Ô∏è Por favor seleccione un nombre primero.", "warning");
      return;
    }

    mostrarMensaje("üß™ Probando obtenerDetalleRegistrosMinimo...", "info");

    google.script.run
      .withSuccessHandler(function (resultado) {
        console.log('=== PRUEBA obtenerDetalleRegistrosMinimo ===');
        console.log('Resultado:', resultado);

        if (resultado === null) {
          mostrarMensaje("‚ùå obtenerDetalleRegistrosMinimo retorn√≥ NULL", "error");
        } else {
          mostrarMensaje("‚úÖ obtenerDetalleRegistrosMinimo ejecutado correctamente", "success");
          const mensaje = `‚úÖ RESULTADO obtenerDetalleRegistrosMinimo:\n` +
            `Registros encontrados: ${resultado.detalleRegistros ? resultado.detalleRegistros.length : 0}\n` +
            `Tama√±o JSON: ${JSON.stringify(resultado).length} caracteres\n` +
            `Mensaje: ${resultado.metadatos ? resultado.metadatos.mensaje : 'N/A'}`;
          alert(mensaje);
        }
      })
      .withFailureHandler(function (error) {
        console.error('Error en obtenerDetalleRegistrosMinimo:', error);
        mostrarMensaje("‚ùå Error en obtenerDetalleRegistrosMinimo: " + error.message, "error");
      })
      .obtenerDetalleRegistrosMinimo(doctor, 7, 2025, "completo");
  }

  function probarDetallesHibrido() {
    const doctor = document.getElementById('doctor').value;

    if (!doctor) {
      mostrarMensaje("‚ö†Ô∏è Por favor seleccione un nombre primero.", "warning");
      return;
    }

    mostrarMensaje("üß™ Probando obtenerDetalleRegistrosHibrido...", "info");

    google.script.run
      .withSuccessHandler(function (resultado) {
        console.log('=== PRUEBA obtenerDetalleRegistrosHibrido ===');
        console.log('Resultado:', resultado);

        if (resultado === null) {
          mostrarMensaje("‚ùå obtenerDetalleRegistrosHibrido retorn√≥ NULL", "error");
        } else {
          mostrarMensaje("‚úÖ obtenerDetalleRegistrosHibrido ejecutado correctamente", "success");
          const mensaje = `‚úÖ RESULTADO obtenerDetalleRegistrosHibrido:\n` +
            `Registros encontrados: ${resultado.detalleRegistros ? resultado.detalleRegistros.length : 0}\n` +
            `Tama√±o JSON: ${JSON.stringify(resultado).length} caracteres\n` +
            `Mensaje: ${resultado.metadatos ? resultado.metadatos.mensaje : 'N/A'}`;
          alert(mensaje);
        }
      })
      .withFailureHandler(function (error) {
        console.error('Error en obtenerDetalleRegistrosHibrido:', error);
        mostrarMensaje("‚ùå Error en obtenerDetalleRegistrosHibrido: " + error.message, "error");
      })
      .obtenerDetalleRegistrosHibrido(doctor, 7, 2025, "completo");
  }

  function diagnosticarDetallesCompleto() {
    const doctor = document.getElementById('doctor').value;

    if (!doctor) {
      mostrarMensaje("‚ö†Ô∏è Por favor seleccione un nombre primero.", "warning");
      return;
    }

    mostrarMensaje("üîç Ejecutando diagn√≥stico completo...", "info");

    google.script.run
      .withSuccessHandler(function (resultado) {
        console.log('=== DIAGN√ìSTICO COMPLETO ===');
        console.log('Resultado:', resultado);
        mostrarMensaje("‚úÖ Diagn√≥stico completado - revisa los logs del Apps Script", "success");
        alert(`üîç DIAGN√ìSTICO COMPLETADO\n\n${resultado}\n\nRevisa los logs del Apps Script para ver el an√°lisis detallado.`);
      })
      .withFailureHandler(function (error) {
        console.error('Error en diagn√≥stico:', error);
        mostrarMensaje("‚ùå Error en diagn√≥stico: " + error.message, "error");
      })
      .diagnosticarDetalleRegistros(doctor, 7, 2025, "completo");
  }

  function probarDetallesSimplificado() {
    const doctor = document.getElementById('doctor').value;

    if (!doctor) {
      mostrarMensaje("‚ö†Ô∏è Por favor seleccione un nombre primero.", "warning");
      return;
    }

    mostrarMensaje("üß™ Probando obtenerDetalleRegistrosSimplificado...", "info");

    google.script.run
      .withSuccessHandler(function (resultado) {
        console.log('=== PRUEBA obtenerDetalleRegistrosSimplificado ===');
        console.log('Resultado:', resultado);

        if (resultado === null) {
          mostrarMensaje("‚ùå obtenerDetalleRegistrosSimplificado retorn√≥ NULL", "error");
        } else {
          mostrarMensaje("‚úÖ obtenerDetalleRegistrosSimplificado ejecutado correctamente", "success");
          const mensaje = `‚úÖ RESULTADO obtenerDetalleRegistrosSimplificado:\n` +
            `Registros encontrados: ${resultado.detalleRegistros ? resultado.detalleRegistros.length : 0}\n` +
            `Tama√±o JSON: ${JSON.stringify(resultado).length} caracteres\n` +
            `Mensaje: ${resultado.metadatos ? resultado.metadatos.mensaje : 'N/A'}`;
          alert(mensaje);
        }
      })
      .withFailureHandler(function (error) {
        console.error('Error en obtenerDetalleRegistrosSimplificado:', error);
        mostrarMensaje("‚ùå Error en obtenerDetalleRegistrosSimplificado: " + error.message, "error");
      })
      .obtenerDetalleRegistrosSimplificado(doctor, 7, 2025, "completo");
  }

  // üß™ Funci√≥n de prueba para verificar el paso de par√°metros
  function probarParametrosScopeFixed() {
    // üîß CAPTURAR PAR√ÅMETROS igual que en calcular()
    const parametros = {
      doctor: document.getElementById('doctor').value,
      mes: parseInt(document.getElementById('mes').value),
      anio: parseInt(document.getElementById('anio').value),
      quincena: document.getElementById('quincena').value
    };

    console.log('üß™ PRUEBA DE PAR√ÅMETROS - SCOPE FIJO');
    console.log('Par√°metros capturados:', parametros);

    if (!parametros.doctor) {
      mostrarMensaje("Por favor, seleccione un doctor primero.", "error");
      return;
    }

    mostrarMensaje("üß™ Probando paso de par√°metros con scope corregido...", "info");

    google.script.run
      .withSuccessHandler(function (resultado) {
        console.log('‚úÖ RESULTADO RECIBIDO:', resultado);
        mostrarMensaje("‚úÖ Par√°metros llegaron correctamente: " + JSON.stringify(resultado, null, 2), "success");
      })
      .withFailureHandler(function (error) {
        console.error('‚ùå ERROR:', error);
        mostrarMensaje("‚ùå Error: " + error.message, "error");
      })
      .verificarParametros(parametros.doctor, parametros.mes, parametros.anio, parametros.quincena);
  }

  function compararLogicasDetalle() {
    const doctor = document.getElementById('doctor').value;

    if (!doctor) {
      mostrarMensaje("‚ö†Ô∏è Por favor seleccione un nombre primero.", "warning");
      return;
    }

    mostrarMensaje("üîç Comparando l√≥gicas calcularCostos vs b√∫squeda directa...", "info");

    google.script.run
      .withSuccessHandler(function (resultado) {
        console.log('=== COMPARACI√ìN DE L√ìGICAS ===');
        console.log('Resultado:', resultado);

        const mensaje = `üîç COMPARACI√ìN DE L√ìGICAS:\n\n` +
          `üìä calcularCostos encontr√≥: ${resultado.calcularCostos} registros\n` +
          `üîç B√∫squeda directa encontr√≥: ${resultado.busquedaDirecta} registros\n` +
          `üìã Coincidencias de nombre: ${resultado.coincidenciasNombre}\n\n` +
          `Revisa los logs del Apps Script para ver los detalles completos.`;

        mostrarMensaje("‚úÖ Comparaci√≥n completada - revisa los logs", "success");
        alert(mensaje);
      })
      .withFailureHandler(function (error) {
        console.error('Error en comparaci√≥n:', error);
        mostrarMensaje("‚ùå Error en comparaci√≥n: " + error.message, "error");
      })
      .compararLogicas(doctor, 7, 2025, "completo");
  }

  function verificarParametrosExactos() {
    const doctor = document.getElementById('doctor').value;

    if (!doctor) {
      mostrarMensaje("‚ö†Ô∏è Por favor seleccione un nombre primero.", "warning");
      return;
    }

    mostrarMensaje("üîç Verificando par√°metros exactos...", "info");

    google.script.run
      .withSuccessHandler(function (resultado) {
        console.log('=== VERIFICACI√ìN DE PAR√ÅMETROS ===');
        console.log('Resultado:', resultado);

        const mensaje = `üîç VERIFICACI√ìN DE PAR√ÅMETROS:\n\n` +
          `üìù Nombre: "${resultado.parametros.nombre}" (${resultado.tipos.nombre})\n` +
          `üìÖ Mes: "${resultado.parametros.mes}" ‚Üí ${resultado.parametros.mesInt} (${resultado.tipos.mes})\n` +
          `üìÖ A√±o: "${resultado.parametros.anio}" ‚Üí ${resultado.parametros.anioInt} (${resultado.tipos.anio})\n` +
          `üìã Quincena: "${resultado.parametros.quincena}" (${resultado.tipos.quincena})\n\n` +
          `Revisa los logs para ver si calcularCostos funciona con estos par√°metros.`;

        mostrarMensaje("‚úÖ Verificaci√≥n completada - revisa los logs", "success");
        alert(mensaje);
      })
      .withFailureHandler(function (error) {
        console.error('Error en verificaci√≥n:', error);
        mostrarMensaje("‚ùå Error en verificaci√≥n: " + error.message, "error");
      })
      .verificarParametros(doctor, 7, 2025, "completo");
  }


  // ================== FUNCIONES DE UTILIDAD ADICIONALES ==================

  function limpiarCacheBrowser() {
    // Limpiar localStorage si existe
    if (typeof (Storage) !== "undefined") {
      localStorage.clear();
    }

    // Forzar recarga de datos
    location.reload(true);
  }

  function exportarLogsConsola() {
    const logs = {
      timestamp: new Date().toISOString(),
      doctor: document.getElementById('doctor').value,
      mes: document.getElementById('mes').value,
      anio: document.getElementById('anio').value,
      quincena: document.getElementById('quincena').value,
      userAgent: navigator.userAgent,
      url: window.location.href
    };

    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(logs, null, 2));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "debug-logs-" + new Date().getTime() + ".json");
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();

    mostrarMensaje("üìÅ Logs exportados correctamente.", "success");
  }

  // üîç Funci√≥n para diagnosticar el problema con detalles
  function diagnosticarProblemaDetalles() {
    // Capturar par√°metros
    const parametros = {
      doctor: document.getElementById('doctor').value,
      mes: parseInt(document.getElementById('mes').value),
      anio: parseInt(document.getElementById('anio').value),
      quincena: document.getElementById('quincena').value
    };

    if (!parametros.doctor) {
      mostrarMensaje("Por favor, seleccione un doctor primero.", "error");
      return;
    }

    mostrarMensaje("üîç Diagnosticando problema con detalles...", "info");

    google.script.run
      .withSuccessHandler(function (resultado) {
        console.log('üîç DIAGN√ìSTICO RECIBIDO:', resultado);

        let mensaje = `
          <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h4 style="color: #273F4F; margin-bottom: 15px;">üìã Diagn√≥stico Detallado de Registros</h4>
            <div style="display: grid; grid-template-columns: auto auto; gap: 10px; margin-bottom: 20px;">
              <strong>Doctor buscado:</strong> <span>${resultado.nombreBuscado}</span>
              <strong>Nombre normalizado:</strong> <span style="color: #FE7743;">${resultado.nombreNormalizado}</span>
              <strong>Per√≠odo:</strong> <span>${resultado.periodo}</span>
              <strong>Quincena:</strong> <span>${resultado.quincena}</span>
              <strong>Total de filas:</strong> <span>${resultado.totalFilas}</span>
              <strong>Registros con nombre coincidente:</strong> <span style="color: ${resultado.registrosConNombreCoincidente > 0 ? '#28a745' : '#dc3545'};">${resultado.registrosConNombreCoincidente}</span>
              <strong>Registros con fecha correcta:</strong> <span style="color: ${resultado.registrosConFechaCorrecta > 0 ? '#28a745' : '#dc3545'};">${resultado.registrosConFechaCorrecta}</span>
              <strong>Registros con quincena correcta:</strong> <span style="color: ${resultado.registrosConQuincenaCorrecta > 0 ? '#28a745' : '#dc3545'};">${resultado.registrosConQuincenaCorrecta}</span>
              <strong>Registros finales encontrados:</strong> <span style="color: ${resultado.registrosEncontrados > 0 ? '#28a745' : '#dc3545'}; font-weight: bold;">${resultado.registrosEncontrados}</span>
            </div>
            
            <div style="margin-top: 20px;">
              <h5 style="color: #273F4F;">üîç Ejemplos de nombres en la hoja:</h5>
              <ul style="max-height: 200px; overflow-y: auto; background-color: white; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px;">
                ${resultado.ejemplosNombres.map(n => `<li>${n}</li>`).join('')}
              </ul>
            </div>

            <div style="margin-top: 20px; padding: 15px; background-color: ${resultado.registrosEncontrados > 0 ? '#d4edda' : '#f8d7da'}; border-radius: 4px;">
              <strong>Mensaje:</strong> ${resultado.mensaje}
            </div>
          </div>
        `;

        document.getElementById('resultado').innerHTML = mensaje;

        // An√°lisis autom√°tico del problema
        if (resultado.registrosConNombreCoincidente === 0) {
          mostrarMensaje("‚ùå PROBLEMA: No se encontraron registros con nombre coincidente. Revisa los ejemplos de nombres en la hoja.", "error");
        } else if (resultado.registrosConFechaCorrecta === 0) {
          mostrarMensaje("‚ùå PROBLEMA: Se encontraron registros con el nombre, pero ninguno tiene la fecha correcta.", "error");
        } else if (resultado.registrosConQuincenaCorrecta === 0) {
          mostrarMensaje("‚ùå PROBLEMA: Se encontraron registros con nombre y fecha, pero ninguno est√° en la quincena correcta.", "error");
        } else {
          mostrarMensaje("‚úÖ Diagn√≥stico completado - se encontraron registros v√°lidos", "success");
        }
      })
      .withFailureHandler(function (error) {
        console.error('‚ùå Error en diagn√≥stico:', error);
        mostrarMensaje("‚ùå Error en diagn√≥stico: " + error.message, "error");
      })
      .diagnosticarDetalleRegistros(parametros.doctor, parametros.mes, parametros.anio, parametros.quincena);
  }

</script>