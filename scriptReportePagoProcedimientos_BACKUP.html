<script>
  // ================== INICIALIZACI√ìN Y CARGA INICIAL ==================
  document.addEventListener('DOMContentLoaded', function () {
    // Inicializar selectores de fecha
    inicializarSelectoresFecha();
    
    // Event listeners para actualizaci√≥n de descripci√≥n
    ['mes', 'anio', 'quincena'].forEach(function(id) {
      const elemento = document.getElementById(id);
      if (elemento) {
        elemento.addEventListener('change', function() {
          actualizarDescripcionSeleccion();
        });
      }
    });

    // Cargar personal
    google.script.run
      .withSuccessHandler(function (personalList) {
        console.log('=== CARGA DE PERSONAL ===');
        console.log('Lista de personal recibida:', personalList);
        console.log('Cantidad de personal:', personalList.length);
        
        const selectDoctor = document.getElementById('doctor');
        selectDoctor.innerHTML = '<option disabled selected value="">Seleccione un nombre</option>';
        
        if (personalList.length === 0) {
          selectDoctor.innerHTML += '<option disabled>No hay personal disponible</option>';
          mostrarMensaje("‚ö†Ô∏è No se pudo cargar la lista de personal", "warning");
        } else {
          personalList.forEach(function (nombre) {
            console.log('Agregando al select:', nombre);
            const option = document.createElement('option');
            option.value = nombre;
            option.textContent = nombre;
            selectDoctor.appendChild(option);
          });
          mostrarMensaje("‚úÖ Personal cargado correctamente (" + personalList.length + " personas)", "success");
        }
      })
      .withFailureHandler(function (error) {
        console.error('=== ERROR CARGA PERSONAL ===');
        console.error('Error completo:', error);
        mostrarMensaje("‚ùå Error al cargar el personal: " + error.message, "error");
      })
      .obtenerPersonalFiltrado([0, 1, 2]);

    // Event listeners para descuentos y extras
    ['montoDescontar', 'motivoDescuento', 'montoExtra'].forEach(function (id) {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', actualizarDescuentoYExtra);
    });
  });

  // ================== FUNCIONES DE INICIALIZACI√ìN DE SELECTORES ==================
  function inicializarSelectoresFecha() {
    inicializarSelectorMes();
    inicializarSelectorAnio();
    inicializarSelectorQuincena();
    seleccionarPeriodoActual();
  }

  function inicializarSelectorMes() {
    const mesInput = document.getElementById('mes');
    if (!mesInput) return;

    const meses = [
      { valor: 1, nombre: "Enero" },
      { valor: 2, nombre: "Febrero" },
      { valor: 3, nombre: "Marzo" },
      { valor: 4, nombre: "Abril" },
      { valor: 5, nombre: "Mayo" },
      { valor: 6, nombre: "Junio" },
      { valor: 7, nombre: "Julio" },
      { valor: 8, nombre: "Agosto" },
      { valor: 9, nombre: "Septiembre" },
      { valor: 10, nombre: "Octubre" },
      { valor: 11, nombre: "Noviembre" },
      { valor: 12, nombre: "Diciembre" }
    ];

    mesInput.innerHTML = '<option disabled value="">Seleccione un mes</option>';
    meses.forEach(mes => {
      const option = document.createElement('option');
      option.value = mes.valor;
      option.textContent = mes.nombre;
      mesInput.appendChild(option);
    });
  }

  function inicializarSelectorAnio() {
    const anioInput = document.getElementById('anio');
    if (!anioInput) return;

    const anioActual = new Date().getFullYear();
    const anioInicio = 2020;
    const anioFin = anioActual + 1;

    anioInput.innerHTML = '<option disabled value="">Seleccione un a√±o</option>';
    
    for (let anio = anioFin; anio >= anioInicio; anio--) {
      const option = document.createElement('option');
      option.value = anio;
      option.textContent = anio;
      anioInput.appendChild(option);
    }
  }

  function inicializarSelectorQuincena() {
    const quincenaInput = document.getElementById('quincena');
    if (!quincenaInput) return;

    const opciones = [
      { valor: "1-15", nombre: "Primera Quincena (1-15)", descripcion: "Del d√≠a 1 al 15 del mes" },
      { valor: "16-31", nombre: "Segunda Quincena (16-31)", descripcion: "Del d√≠a 16 al √∫ltimo d√≠a del mes" },
      { valor: "completo", nombre: "Mes Completo", descripcion: "Todo el mes seleccionado" }
    ];

    quincenaInput.innerHTML = '<option disabled value="">Seleccione una quincena</option>';
    opciones.forEach(opcion => {
      const option = document.createElement('option');
      option.value = opcion.valor;
      option.textContent = opcion.nombre;
      option.title = opcion.descripcion;
      quincenaInput.appendChild(option);
    });
  }

  function seleccionarPeriodoActual() {
    const fechaActual = new Date();
    const mesActual = fechaActual.getMonth() + 1;
    const anioActual = fechaActual.getFullYear();
    const diaActual = fechaActual.getDate();

    // Seleccionar mes actual
    const mesInput = document.getElementById('mes');
    if (mesInput) mesInput.value = mesActual.toString();

    // Seleccionar a√±o actual
    const anioInput = document.getElementById('anio');
    if (anioInput) anioInput.value = anioActual.toString();

    // Seleccionar quincena actual basada en el d√≠a
    const quincenaInput = document.getElementById('quincena');
    if (quincenaInput) {
      const quincenaActual = diaActual <= 15 ? '1-15' : '16-31';
      quincenaInput.value = quincenaActual;
    }

    // Actualizar descripci√≥n
    actualizarDescripcionSeleccion();
  }

  function actualizarSelectoresFecha() {
    inicializarSelectoresFecha();
    mostrarMensaje("‚úÖ Selectores de fecha actualizados.", "success");
  }

  function mostrarAyudaFechas() {
    const ayuda = `AYUDA PARA SELECCI√ìN DE FECHAS:

üìÖ MES: Seleccione el mes del cual desea generar el reporte.

üìÜ A√ëO: A√±os disponibles desde 2020 hasta ${new Date().getFullYear() + 1}.

üóìÔ∏è QUINCENA:
‚Ä¢ Primera Quincena (1-15): Incluye del d√≠a 1 al 15 del mes
‚Ä¢ Segunda Quincena (16-31): Incluye del d√≠a 16 al √∫ltimo d√≠a del mes  
‚Ä¢ Mes Completo: Incluye todos los d√≠as del mes seleccionado

üí° CONSEJO: 
- El sistema selecciona autom√°ticamente el per√≠odo actual
- Use "üîÑ Actualizar Fechas" si los selectores no cargan correctamente`;

    alert(ayuda);
  }

  // ================== FUNCIONES DE UI Y DESCRIPCI√ìN ==================
  function actualizarDescripcionSeleccion() {
    const descripcionElement = document.getElementById('descripcionSeleccion');
    if (descripcionElement) {
      const descripcion = obtenerDescripcionSeleccionActual();
      descripcionElement.textContent = descripcion;
    }
  }

  function obtenerDescripcionSeleccionActual() {
    const mes = document.getElementById('mes').value;
    const anio = document.getElementById('anio').value;
    const quincena = document.getElementById('quincena').value;

    if (!mes || !anio || !quincena) {
      return "Ninguna - Complete todos los campos";
    }

    const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", 
                   "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    const nombreMes = meses[parseInt(mes) - 1];
    
    let descripcionQuincena;
    switch(quincena) {
      case "1-15":
        descripcionQuincena = "Primera quincena (1-15)";
        break;
      case "16-31":
        descripcionQuincena = "Segunda quincena (16-31)";
        break;
      case "completo":
        descripcionQuincena = "Mes completo";
        break;
      default:
        descripcionQuincena = quincena;
    }

    return `${nombreMes} ${anio} - ${descripcionQuincena}`;
  }

  function validarSeleccionFecha() {
    const mes = document.getElementById('mes').value;
    const anio = document.getElementById('anio').value;
    const quincena = document.getElementById('quincena').value;

    let mensaje = "VALIDACI√ìN DE SELECCI√ìN DE FECHA:\n\n";
    mensaje += `Mes: ${mes ? '‚úÖ ' + mes : '‚ùå No seleccionado'}\n`;
    mensaje += `A√±o: ${anio ? '‚úÖ ' + anio : '‚ùå No seleccionado'}\n`;
    mensaje += `Quincena: ${quincena ? '‚úÖ ' + quincena : '‚ùå No seleccionado'}\n\n`;
    
    if (mes && anio && quincena) {
      mensaje += `‚úÖ Selecci√≥n v√°lida: ${obtenerDescripcionSeleccionActual()}`;
      mostrarMensaje("‚úÖ Selecci√≥n de fecha v√°lida.", "success");
    } else {
      mensaje += "‚ùå Selecci√≥n incompleta. Complete todos los campos.";
      mostrarMensaje("‚ö†Ô∏è Complete todos los campos de fecha.", "warning");
    }

    alert(mensaje);
  }

  function mostrarLogConsola() {
    console.log('=== LOGS DEL SISTEMA ===');
    console.log('Estado actual de selectores:');
    console.log('- Doctor:', document.getElementById('doctor').value);
    console.log('- Mes:', document.getElementById('mes').value);
    console.log('- A√±o:', document.getElementById('anio').value);
    console.log('- Quincena:', document.getElementById('quincena').value);
    console.log('- Descripci√≥n:', obtenerDescripcionSeleccionActual());
    mostrarMensaje("üìã Logs mostrados en la consola del navegador (F12).", "info");
  }

  function mostrarIndicadorCarga(mostrar) {
    const indicador = document.getElementById('loadingIndicator');
    if (indicador) {
      indicador.style.display = mostrar ? 'flex' : 'none';
    }
  }

  // ================== CARGA DE EMAIL PERSONAL ==================
  function cargarEmailPersonal() {
    const selectedPersonal = document.getElementById('doctor').value;
    
    if (!selectedPersonal) {
      mostrarMensaje("Por favor, seleccione un personal primero.", "error");
      return;
    }
    
    google.script.run
      .withSuccessHandler(function (email) {
        document.getElementById('emailRecipient').value = email;
      })
      .withFailureHandler(function (error) {
        mostrarMensaje("‚ùå Error al cargar el email: " + error.message, "error");
      })
      .obtenerEmailParaPersonal(selectedPersonal);
  }

  // ================== GENERACI√ìN DE TABLAS Y REPORTE ==================
  function generarTablaHtml(titulo, data, totalSubtotalDia, totalIVADia, totalConIVADia) {
    let html = `
      <h3>${titulo}</h3>
      <table>
        <tr>
          <th>Tipo de procedimiento</th>
          <th>Cantidad</th>
          <th>Costo por procedimiento individual</th>
          <th>Ganancia sin IVA</th>
          <th>IVA (4%)</th>
          <th>Ganancia con IVA</th>
        </tr>
    `;

    let hasData = false;
    for (const key in data) {
      const r = data[key];
      if (r.cantidad > 0) {
        hasData = true;
        html += `
          <tr>
            <td class="text-left">${r.nombre}</td>
            <td>${r.cantidad}</td>
            <td>‚Ç°${formatearMoneda(r.costo_unitario)}</td>
            <td>‚Ç°${formatearMoneda(r.subtotal)}</td>
            <td>‚Ç°${formatearMoneda(r.iva)}</td>
            <td>‚Ç°${formatearMoneda(r.total_con_iva)}</td>
          </tr>
        `;
      }
    }

    if (!hasData) {
      html += `<tr><td colspan="6">No hay registros para este per√≠odo.</td></tr>`;
    } else {
      html += `
        <tr class="subtotal-row">
          <td class="text-left">Subtotal ${titulo}</td>
          <td>-</td>
          <td>-</td>
          <td>‚Ç°${formatearMoneda(totalSubtotalDia)}</td>
          <td>‚Ç°${formatearMoneda(totalIVADia)}</td>
          <td>‚Ç°${formatearMoneda(totalConIVADia)}</td>
        </tr>
      `;
    }
    html += '</table>';
    return html;
  }

  function calcular() {
    const doctor = document.getElementById('doctor').value;
    const mes = document.getElementById('mes').value;
    const anio = document.getElementById('anio').value;
    const quincena = document.getElementById('quincena').value;

    // Log de debugging
    console.log('=== DEBUGGING CALCULAR ===');
    console.log('Doctor seleccionado:', doctor);
    console.log('Mes:', mes);
    console.log('A√±o:', anio);
    console.log('Quincena:', quincena);

    // Usar la funci√≥n de validaci√≥n mejorada
    if (!validarEntradas(doctor, mes, anio, quincena)) {
      return;
    }

    // Mostrar mensaje de carga
    mostrarMensaje("üîç Buscando registros para " + doctor + "...", "info");
    
    // Limpiar resultados anteriores
    const divResultado = document.getElementById('resultado');
    if (divResultado) {
      divResultado.innerHTML = '<p>Cargando datos...</p>';
    }

    // ‚úÖ TIMEOUT PARA EVITAR CARGA INFINITA
    const timeoutId = setTimeout(() => {
      mostrarMensaje("‚è∞ El c√°lculo est√° tomando demasiado tiempo. Verificando datos...", "warning");
      console.log('TIMEOUT: El c√°lculo excedi√≥ 30 segundos');
    }, 30000);

    google.script.run
      .withSuccessHandler(function (resumen) {
        clearTimeout(timeoutId); // ‚úÖ Limpiar timeout
        
        console.log('=== RESPUESTA DEL SERVIDOR ===');
        console.log('Datos recibidos:', resumen);
        console.log('Tiene datos LV?:', !!resumen.lv);
        console.log('Tiene datos Sab?:', !!resumen.sab);
        console.log('Totales:', resumen.totales);
        
        // ‚úÖ VERIFICACI√ìN MEJORADA DE DATOS
        if (!resumen) {
          mostrarMensaje("‚ùå No se recibieron datos del servidor.", "error");
          document.getElementById('resultado').innerHTML = '<p class="no-data">Error: No se recibieron datos.</p>';
          return;
        }

        if (!resumen.totales) {
          mostrarMensaje("‚ùå Los datos recibidos no tienen la estructura esperada.", "error");
          document.getElementById('resultado').innerHTML = '<p class="no-data">Error: Estructura de datos inv√°lida.</p>';
          return;
        }

        // Verificar si los totales son cero
        if (resumen.totales.subtotal === 0) {
          mostrarMensaje("‚ö†Ô∏è No se encontraron procedimientos registrados para " + doctor + " en el per√≠odo seleccionado.", "warning");
          document.getElementById('resultado').innerHTML = '<p class="no-data">No hay procedimientos registrados en este per√≠odo.</p>';
          return;
        }

        // ‚úÖ PROCESAMIENTO DE DATOS MEJORADO
        const divResultado = document.getElementById('resultado');
        let htmlResultado = '';

        // Asegura que ambos objetos existan aunque est√©n vac√≠os
        const resumenLV = resumen.lv || {};
        const resumenSab = resumen.sab || {};

        let totalSubtotalLV = 0;
        let totalIVALV = 0;
        let totalConIVALV = 0;
        for (const key in resumenLV) {
          if (resumenLV[key]) {
            totalSubtotalLV += resumenLV[key].subtotal || 0;
            totalIVALV += resumenLV[key].iva || 0;
            totalConIVALV += resumenLV[key].total_con_iva || 0;
          }
        }

        let totalSubtotalSab = 0;
        let totalIVASab = 0;
        let totalConIVASab = 0;
        for (const key in resumenSab) {
          if (resumenSab[key]) {
            totalSubtotalSab += resumenSab[key].subtotal || 0;
            totalIVASab += resumenSab[key].iva || 0;
            totalConIVASab += resumenSab[key].total_con_iva || 0;
          }
        }

        htmlResultado += generarTablaHtml("Reporte de Lunes a Viernes", resumenLV, totalSubtotalLV, totalIVALV, totalConIVALV);
        htmlResultado += generarTablaHtml("Reporte de S√°bados", resumenSab, totalSubtotalSab, totalIVASab, totalConIVASab);

        divResultado.innerHTML = htmlResultado;

        // ACTUALIZA LOS TOTALES PARA EL DESCUENTO
        mostrarTotalesReporte(resumen.totales.subtotal, resumen.totales.total_con_iva);

        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const selectedMonthName = monthNames[parseInt(mes) - 1];
        const quincenaText = quincena === 'completo' ? 'Mes Completo' : `Quincena ${quincena}`;

        document.getElementById('reportTitle').textContent = `Reporte de Procedimientos y Consultas - ${doctor} - ${selectedMonthName} ${anio} (${quincenaText})`;

        document.getElementById('action-section').style.display = 'block';
        document.getElementById('emailMessage').textContent = '';
        
        // Mensaje de √©xito
        mostrarMensaje("‚úÖ Reporte generado exitosamente.", "success");
      })
      .withFailureHandler(function (error) {
        clearTimeout(timeoutId); // ‚úÖ Limpiar timeout
        
        console.error('=== ERROR DEL SERVIDOR ===');
        console.error('Error completo:', error);
        console.error('Mensaje de error:', error.message);
        console.error('Stack trace:', error.stack);
        
        // ‚úÖ MANEJO DE ERRORES MEJORADO
        let mensajeError = "‚ùå Error al calcular costos: ";
        if (error.message) {
          mensajeError += error.message;
        } else {
          mensajeError += "Error desconocido del servidor";
        }
        
        mostrarMensaje(mensajeError, "error");
        
        // Limpiar resultados en caso de error
        const divResultado = document.getElementById('resultado');
        if (divResultado) {
          divResultado.innerHTML = '<p class="error-message">Error al cargar los datos. Por favor, intente nuevamente.</p>';
        }
      })
      .calcularCostos(doctor, parseInt(mes), parseInt(anio), quincena); // ‚úÖ ORDEN CORREGIDO: nombre, mes, a√±o, quincena
  }

  // ================== DESCUENTO, EXTRA Y MOTIVO ==================
  let subtotalGlobal = 0;
  let totalConIVAGlobal = 0;

  function mostrarTotalesReporte(sub, total) {
    subtotalGlobal = sub || 0;  // ‚úÖ Valor por defecto
    totalConIVAGlobal = total || 0;  // ‚úÖ Valor por defecto
    
    const subtotalOriginal = getElement('subtotalOriginal');
    const granTotal = getElement('granTotal');
    
    if (subtotalOriginal) subtotalOriginal.textContent = formatearMoneda(subtotalGlobal);
    if (granTotal) granTotal.textContent = formatearMoneda(totalConIVAGlobal);
    
    actualizarDescuentoYExtra();
  }

  function actualizarDescuentoYExtra() {
    const montoDescontarInput = getElement('montoDescontar');
    const motivoDescuentoInput = getElement('motivoDescuento');
    const montoExtraInput = getElement('montoExtra');
    
    if (!montoDescontarInput || !motivoDescuentoInput || !montoExtraInput) return;

    const montoDescontar = Number(montoDescontarInput.value) || 0;
    const montoExtra = Number(montoExtraInput.value) || 0;
    const motivo = motivoDescuentoInput.value.trim();

    // Validar que los montos sean v√°lidos
    if (!validarMontos(montoDescontar) || !validarMontos(montoExtra)) {
      mostrarMensaje("Los montos deben ser n√∫meros v√°lidos y positivos.", "error");
      return;
    }

    // Validar que el descuento no sea mayor que el subtotal
    if (montoDescontar > subtotalGlobal) {
      mostrarMensaje("El descuento no puede ser mayor que el subtotal.", "error");
      return;
    }

    // Subtotal con descuento y extra
    const subtotalConDescuento = subtotalGlobal - montoDescontar + montoExtra;
    const subtotalConDescuentoEl = getElement('subtotalConDescuento');
    if (subtotalConDescuentoEl) {
      subtotalConDescuentoEl.textContent = formatearMoneda(subtotalConDescuento);
    }

    // Comentario
    let comentario = '';
    if (montoDescontar > 0 && motivo) {
      comentario += `Descuento aplicado: ‚Ç°${formatearMoneda(montoDescontar)} (${motivo})`;
    } else if (montoDescontar > 0) {
      comentario += `Descuento aplicado: ‚Ç°${formatearMoneda(montoDescontar)}`;
    }
    if (montoExtra > 0 && motivo) {
      comentario += (comentario ? ' | ' : '') + `Extra aplicado: ‚Ç°${formatearMoneda(montoExtra)} (${motivo})`;
    } else if (montoExtra > 0) {
      comentario += (comentario ? ' | ' : '') + `Extra aplicado: ‚Ç°${formatearMoneda(montoExtra)}`;
    }
    
    const comentarioEl = getElement('comentarioDescuento');
    if (comentarioEl) comentarioEl.textContent = comentario;

    // El gran total tambi√©n refleja el descuento y el extra
    const granTotalEl = getElement('granTotal');
    if (granTotalEl) {
      granTotalEl.textContent = formatearMoneda(totalConIVAGlobal - montoDescontar + montoExtra);
    }

    // Actualiza los spans para PDF
    const montoDescontarTextoEl = getElement('montoDescontarTexto');
    const montoExtraTextoEl = getElement('montoExtraTexto');
    const motivoDescuentoTextoEl = getElement('motivoDescuentoTexto');
    
    if (montoDescontarTextoEl) {
      montoDescontarTextoEl.textContent = montoDescontar > 0 ? `Descuento aplicado: ‚Ç°${formatearMoneda(montoDescontar)}` : '';
    }
    if (montoExtraTextoEl) {
      montoExtraTextoEl.textContent = montoExtra > 0 ? `Extra aplicado: ‚Ç°${formatearMoneda(montoExtra)}` : '';
    }
    if (motivoDescuentoTextoEl) {
      motivoDescuentoTextoEl.textContent = motivo ? `Motivo: ${motivo}` : '';
    }
  }

  // ================== VALIDACIONES ==================
  function validarEntradas(doctor, mes, anio, quincena) {
    console.log('=== VALIDANDO ENTRADAS ===');
    console.log('Doctor:', doctor, 'Tipo:', typeof doctor);
    console.log('Mes:', mes, 'Tipo:', typeof mes);
    console.log('A√±o:', anio, 'Tipo:', typeof anio);
    console.log('Quincena:', quincena, 'Tipo:', typeof quincena);

    // Validar doctor seleccionado
    if (!doctor || doctor.trim() === '') {
      mostrarMensaje("Por favor, seleccione un personal.", "error");
      return false;
    }

    // Validar a√±o
    const anioNum = parseInt(anio);
    const currentYear = new Date().getFullYear();
    if (isNaN(anioNum) || anioNum < 2020 || anioNum > currentYear + 1) {
      mostrarMensaje("Por favor, ingrese un a√±o v√°lido (2020 - " + (currentYear + 1) + ").", "error");
      return false;
    }

    // Validar mes
    const mesNum = parseInt(mes);
    if (isNaN(mesNum) || mesNum < 1 || mesNum > 12) {
      mostrarMensaje("Por favor, seleccione un mes v√°lido.", "error");
      return false;
    }

    // Validar quincena
    if (!quincena || !['1-15', '16-31', 'completo'].includes(quincena)) {
      mostrarMensaje("Por favor, seleccione una quincena v√°lida.", "error");
      console.log('Quincena inv√°lida. Valores permitidos: 1-15, 16-31, completo');
      return false;
    }

    console.log('‚úÖ Todas las validaciones pasaron');
    return true;
  }

  function validarEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }

  function validarMontos(monto) {
    const montoNum = Number(monto);
    return !isNaN(montoNum) && montoNum >= 0;
  }

  // ================== ENV√çO Y DESCARGA DE PDF ==================
  function enviarReporteCostos() {
    prepararParaPDF();
    const emailRecipient = document.getElementById('emailRecipient').value;
    const doctor = document.getElementById('doctor').value;
    const mes = document.getElementById('mes').value;
    const anio = parseInt(document.getElementById('anio').value);
    const quincena = document.getElementById('quincena').value;

    if (!validarEmail(emailRecipient)) {
      mostrarEmailMensaje("Por favor, ingrese un email v√°lido.", "error");
      restaurarInputsPDF();
      return;
    }

    const reportContent = document.getElementById('printableReportContent').innerHTML;
    const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    const selectedMonthName = monthNames[parseInt(mes) - 1];
    const quincenaText = quincena === 'completo' ? 'Mes Completo' : `Quincena ${quincena}`;
    const subject = `Reporte de Procedimientos y Consultas - ${doctor} - ${selectedMonthName} ${anio} (${quincenaText})`;
    const fileName = `Reporte_Procedimientos_y_Consultas_${doctor.replace(/\s+/g, '_')}_${selectedMonthName}_${anio}_${quincena.replace('-', '_')}.pdf`;

    mostrarEmailMensaje("Enviando reporte...", "info");

    google.script.run
      .withSuccessHandler(response => {
        restaurarInputsPDF();
        if (response.success) {
          mostrarEmailMensaje(response.message, "success");
        } else {
          mostrarEmailMensaje(response.message, "error");
        }
      })
      .withFailureHandler(error => {
        restaurarInputsPDF();
        mostrarMensaje("‚ùå Error al enviar el reporte: " + error.message, "error");
      })
      .enviarReporteCostos(reportContent, emailRecipient, subject, fileName);
  }

  function descargarReporteCostosPDF() {
    prepararParaPDF();
    const reportContent = document.getElementById('printableReportContent').innerHTML;

    const doctor = document.getElementById('doctor').value;
    const mes = document.getElementById('mes').value;
    const anio = parseInt(document.getElementById('anio').value);
    const quincena = document.getElementById('quincena').value;
    const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    const selectedMonthName = monthNames[parseInt(mes) - 1];
    const fileName = `Reporte_Procedimientos_y_Consultas_${doctor.replace(/\s+/g, '_')}_${selectedMonthName}_${anio}_${quincena.replace('-', '_')}.pdf`;
    const pageTitle = `Reporte de Procedimientos y Consultas - ${doctor} - ${selectedMonthName} ${anio}`;

    mostrarEmailMensaje("Generando PDF para descarga...", "info");

    google.script.run
      .withSuccessHandler(function (base64Pdf) {
        restaurarInputsPDF();
        if (base64Pdf) {
          const blob = b64toBlob(base64Pdf, 'application/pdf');
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          mostrarEmailMensaje("‚úÖ Reporte descargado con √©xito.", "success");
        } else {
          mostrarMensaje("‚ùå No se pudo generar el PDF para descarga.", "error");
        }
      })
      .withFailureHandler(function (error) {
        restaurarInputsPDF();
        mostrarMensaje("‚ùå Error al descargar el PDF: " + error.message, "error");
      })
      .generarPdfParaDescarga(reportContent, fileName, 'stylesReportePagoProcedimientos', pageTitle);
  }

  function b64toBlob(b64Data, contentType = '', sliceSize = 512) {
    const byteCharacters = atob(b64Data);
    const byteArrays = [];

    for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
      const slice = byteCharacters.slice(offset, offset + sliceSize);
      const byteNumbers = new Array(slice.length);
      for (let i = 0; i < slice.length; i++) {
        byteNumbers[i] = slice.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      byteArrays.push(byteArray);
    }

    const blob = new Blob(byteArrays, { type: contentType });
    return blob;
  }

  // ================== MENSAJES ==================
  function mostrarEmailMensaje(mensaje, tipo) {
    let mensajeDiv = document.getElementById('emailMessage');
    if (!mensajeDiv) {
      mensajeDiv = document.createElement('div');
      mensajeDiv.id = 'emailMessage';
      document.getElementById('action-section').appendChild(mensajeDiv);
    }
    mensajeDiv.className = '';
    mensajeDiv.textContent = mensaje;
    if (tipo === 'success') {
      mensajeDiv.classList.add('alert-success');
    } else if (tipo === 'error') {
      mensajeDiv.classList.add('alert-error');
    } else if (tipo === 'info') {
      mensajeDiv.classList.add('alert-info');
    }
    if (tipo !== 'error') {
      setTimeout(() => {
        mensajeDiv.textContent = '';
        mensajeDiv.className = '';
      }, 5000);
    }
  }

  function mostrarMensaje(mensaje, tipo) {
    let mensajeDiv = document.getElementById('formMessage') || document.getElementById('emailMessage');
    if (!mensajeDiv) {
      mensajeDiv = document.createElement('div');
      mensajeDiv.id = 'formMessage';
      const controlsDiv = document.getElementById('reportControls');
      if (controlsDiv) {
        controlsDiv.prepend(mensajeDiv);
      } else {
        document.body.prepend(mensajeDiv);
      }
    }
    mensajeDiv.className = '';
    mensajeDiv.textContent = mensaje;
    if (tipo === 'success') {
      mensajeDiv.classList.add('alert-success');
    } else if (tipo === 'error') {
      mensajeDiv.classList.add('alert-error');
    } else if (tipo === 'info') {
      mensajeDiv.classList.add('alert-info');
    } else if (tipo === 'warning') {
      mensajeDiv.classList.add('alert-warning');
    }
    
    // Limpiar mensaje autom√°ticamente despu√©s de un tiempo (excepto errores)
    if (tipo !== 'error') {
      setTimeout(() => {
        mensajeDiv.textContent = '';
        mensajeDiv.className = '';
      }, tipo === 'success' ? 3000 : 5000);
    }
  }

  // ================== FUNCIONES DE UTILIDAD PARA PDF ==================
  function prepararParaPDF() {
    // Ocultar elementos no necesarios para el PDF
    const elementsToHide = document.querySelectorAll('.no-print, .btn, .form-group, #reportControls');
    elementsToHide.forEach(el => {
      if (el) {
        el.style.display = 'none';
        el.setAttribute('data-was-visible', 'true');
      }
    });
    
    // Agregar clase para estilos de impresi√≥n
    document.body.classList.add('pdf-mode');
  }
  
  function restaurarInputsPDF() {
    // Restaurar elementos ocultos
    const elementsToShow = document.querySelectorAll('[data-was-visible="true"]');
    elementsToShow.forEach(el => {
      el.style.display = '';
      el.removeAttribute('data-was-visible');
    });
    
    // Remover clase de modo PDF
    document.body.classList.remove('pdf-mode');
  }

  // ================== CACHE DE ELEMENTOS DOM ==================
  let cachedElements = {};
  
  function getElement(id) {
    if (!cachedElements[id]) {
      cachedElements[id] = document.getElementById(id);
    }
    return cachedElements[id];
  }
  
  function formatearMoneda(cantidad) {
    return cantidad.toLocaleString('es-CR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  // ================== FUNCIONES DE DEBUGGING ==================
  
  function diagnosticarCalculo() {
    const doctor = document.getElementById('doctor').value;
    const mes = document.getElementById('mes').value;
    const anio = document.getElementById('anio').value;
    const quincena = document.getElementById('quincena').value;
    
    if (!doctor) {
      mostrarMensaje("Por favor, seleccione un doctor primero.", "error");
      return;
    }
    
    mostrarMensaje("üîç Diagnosticando problema de c√°lculo...", "info");
    
    google.script.run
      .withSuccessHandler(function (resultado) {
        console.log('=== DIAGN√ìSTICO COMPLETO ===');
        console.log('Resultado:', resultado);
        
        let mensaje = `DIAGN√ìSTICO PARA "${resultado.nombreBuscado}":\n\n`;
        mensaje += `Total registros encontrados: ${resultado.totalRegistros}\n`;
        if (resultado.registrosValidosFecha !== undefined) {
          mensaje += `Registros con fecha v√°lida: ${resultado.registrosValidosFecha}\n`;
          mensaje += `Registros con fecha inv√°lida: ${resultado.registrosInvalidosFecha}\n`;
        }
        if (resultado.primerRegistro) {
          mensaje += `Primer registro: ${resultado.primerRegistro}\n`;
          mensaje += `√öltimo registro: ${resultado.ultimoRegistro}\n`;
        }
        
        alert(mensaje);
        mostrarMensaje("‚úÖ Diagn√≥stico completado. Revise la consola para detalles.", "success");
      })
      .withFailureHandler(function (error) {
        console.error('Error en diagn√≥stico:', error);
        mostrarMensaje("‚ùå Error al diagnosticar: " + error.message, "error");
      })
      .diagnosticarFechasPersonal(doctor);
  }

  function buscarPersonalPorNombre() {
    const nombreBuscar = prompt("Ingrese el nombre (o parte del nombre) a buscar:");
    if (!nombreBuscar || nombreBuscar.trim() === '') {
      mostrarMensaje("B√∫squeda cancelada.", "info");
      return;
    }
    
    mostrarMensaje("üîç Buscando personal que contenga '" + nombreBuscar + "'...", "info");
    
    google.script.run
      .withSuccessHandler(function (resultados) {
        console.log('Resultados de b√∫squeda:', resultados);
        
        let mensaje = `RESULTADOS DE B√öSQUEDA PARA "${nombreBuscar}":\n\n`;
        if (resultados.coincidenciasExactas.length > 0) {
          mensaje += "COINCIDENCIAS EXACTAS:\n";
          resultados.coincidenciasExactas.forEach((nombre, index) => {
            mensaje += `${index + 1}. ${nombre}\n`;
          });
          mensaje += "\n";
        }
        
        if (resultados.coincidenciasParciales.length > 0) {
          mensaje += "COINCIDENCIAS PARCIALES:\n";
          resultados.coincidenciasParciales.forEach((nombre, index) => {
            mensaje += `${index + 1}. ${nombre}\n`;
          });
        }
        
        if (resultados.coincidenciasExactas.length === 0 && resultados.coincidenciasParciales.length === 0) {
          mensaje += "No se encontraron coincidencias.";
        }
        
        alert(mensaje);
        mostrarMensaje("‚úÖ B√∫squeda completada.", "success");
      })
      .withFailureHandler(function (error) {
        console.error('Error en b√∫squeda:', error);
        mostrarMensaje("‚ùå Error al buscar: " + error.message, "error");
      })
      .buscarPersonalPorNombre(nombreBuscar);
  }
  
  function verificarDatosPersonal() {
    const doctor = document.getElementById('doctor').value;
    
    if (!doctor) {
      mostrarMensaje("Por favor, seleccione un personal primero.", "error");
      return;
    }
    
    mostrarMensaje("üîç Verificando datos para " + doctor + "...", "info");
    
    google.script.run
      .withSuccessHandler(function (resultado) {
        console.log('Verificaci√≥n de datos:', resultado);
        let mensaje = `Datos encontrados para ${doctor}:\n`;
        mensaje += `- Total de registros: ${resultado.totalRegistros || 0}\n`;
        mensaje += `- Rango de fechas: ${resultado.fechaInicio || 'N/A'} - ${resultado.fechaFin || 'N/A'}\n`;
        mensaje += `- Procedimientos √∫nicos: ${resultado.tiposProcedimientos || 0}`;
        
        alert(mensaje);
        mostrarMensaje("‚úÖ Verificaci√≥n completada. Revise la consola para m√°s detalles.", "success");
      })
      .withFailureHandler(function (error) {
        console.error('Error en verificaci√≥n:', error);
        mostrarMensaje("‚ùå Error al verificar datos: " + error.message, "error");
      })
      .verificarDatosPersonal(doctor);
  }
  
  function listarPersonalDisponible() {
    mostrarMensaje("üîç Obteniendo lista completa de personal...", "info");
    
    google.script.run
      .withSuccessHandler(function (personalCompleto) {
        console.log('Personal completo:', personalCompleto);
        let mensaje = "Personal disponible en RegistrosProcedimientos:\n";
        personalCompleto.forEach((nombre, index) => {
          mensaje += `${index + 1}. ${nombre}\n`;
        });
        
        alert(mensaje);
        mostrarMensaje("‚úÖ Lista obtenida. Revise la consola para m√°s detalles.", "success");
      })
      .withFailureHandler(function (error) {
        console.error('Error al obtener personal:', error);
        mostrarMensaje("‚ùå Error al obtener personal: " + error.message, "error");
      })
      .obtenerPersonalCompleto();
  }

  
  // ================== FUNCIONES DE UTILIDAD ADICIONALES ==================
  
  function limpiarCacheBrowser() {
    // Limpiar localStorage si existe
    if (typeof(Storage) !== "undefined") {
      localStorage.clear();
    }
    
    // Forzar recarga de datos
    location.reload(true);
  }

  function exportarLogsConsola() {
    const logs = {
      timestamp: new Date().toISOString(),
      doctor: document.getElementById('doctor').value,
      mes: document.getElementById('mes').value,
      anio: document.getElementById('anio').value,
      quincena: document.getElementById('quincena').value,
      userAgent: navigator.userAgent,
      url: window.location.href
    };
    
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(logs, null, 2));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "debug-logs-" + new Date().getTime() + ".json");
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
    
    mostrarMensaje("üìÅ Logs exportados correctamente.", "success");
  }

</script>