<script>
  // ================== SCRIPT MEJORADO PARA REPORTE DE PROCEDIMIENTOS ==================
  // Versi√≥n consolidada que elimina funciones duplicadas y mejora la eficiencia

  // ================== CONFIGURACI√ìN Y VARIABLES GLOBALES ==================
  let subtotalGlobal = 0;
  let totalConIVAGlobal = 0;
  let cachedElements = {};

  // ================== INICIALIZACI√ìN Y CARGA INICIAL ==================
  document.addEventListener('DOMContentLoaded', function () {
    console.log('üöÄ Iniciando aplicaci√≥n de reporte de procedimientos');

    // Inicializar todos los componentes
    inicializarAplicacion();
  });

  function inicializarAplicacion() {
    try {
      // 1. Inicializar selectores de fecha
      inicializarSelectoresFecha();

      // 2. Configurar event listeners
      configurarEventListeners();

      // 3. Cargar personal desde el servidor
      cargarPersonalInicial();

      // 4. Mostrar mensaje de bienvenida
      mostrarMensaje("üîÑ Inicializando aplicaci√≥n...", "info");

    } catch (error) {
      console.error('‚ùå Error en inicializaci√≥n:', error);
      mostrarMensaje("‚ùå Error al inicializar la aplicaci√≥n", "error");
    }
  }

  function configurarEventListeners() {
    // Event listeners para selectores de fecha
    ['mes', 'anio', 'quincena'].forEach(function (id) {
      const elemento = getElement(id);
      if (elemento) {
        elemento.addEventListener('change', function () {
          actualizarDescripcionSeleccion();
        });
      }
    });

    // Event listeners para descuentos y extras
    ['montoDescontar', 'motivoDescuento', 'montoExtra'].forEach(function (id) {
      const el = getElement(id);
      if (el) {
        el.addEventListener('input', actualizarDescuentoYExtra);
      }
    });
  }

  function cargarPersonalInicial() {
    console.log('üìã Cargando lista de personal...');

    google.script.run
      .withSuccessHandler(function (personalList) {
        procesarListaPersonal(personalList);
      })
      .withFailureHandler(function (error) {
        manejarErrorCargaPersonal(error);
      })
      .obtenerPersonalFiltrado([0, 1, 2]); // Doctor, Anestesi√≥logo, T√©cnico
  }

  function procesarListaPersonal(personalList) {
    console.log('=== PROCESANDO LISTA DE PERSONAL ===');
    console.log('Lista recibida:', personalList);
    console.log('Cantidad:', personalList.length);

    const selectDoctor = getElement('doctor');
    if (!selectDoctor) {
      console.error('‚ùå No se encontr√≥ el elemento select de doctor');
      return;
    }

    // Limpiar opciones existentes
    selectDoctor.innerHTML = '<option disabled selected value="">Seleccione un nombre</option>';

    if (!personalList || personalList.length === 0) {
      selectDoctor.innerHTML += '<option disabled>No hay personal disponible</option>';
      mostrarMensaje("‚ö†Ô∏è No se pudo cargar la lista de personal", "warning");
      return;
    }

    // Agregar cada persona al selector
    personalList.forEach(function (nombre) {
      console.log('Agregando:', nombre);
      const option = document.createElement('option');
      option.value = nombre;
      option.textContent = nombre;
      selectDoctor.appendChild(option);
    });

    mostrarMensaje(`‚úÖ Personal cargado: ${personalList.length} personas`, "success");
  }

  function manejarErrorCargaPersonal(error) {
    console.error('=== ERROR CARGA PERSONAL ===');
    console.error('Error completo:', error);
    mostrarMensaje(`‚ùå Error al cargar personal: ${error.message || 'Error desconocido'}`, "error");

    // Agregar opci√≥n de reintento
    const selectDoctor = getElement('doctor');
    if (selectDoctor) {
      selectDoctor.innerHTML = `
        <option disabled selected value="">Error al cargar</option>
        <option value="RECARGAR">üîÑ Hacer clic para recargar</option>
      `;

      selectDoctor.addEventListener('change', function () {
        if (this.value === 'RECARGAR') {
          cargarPersonalInicial();
        }
      });
    }
  }

  // ================== FUNCIONES DE SELECTORES DE FECHA ==================
  function inicializarSelectoresFecha() {
    console.log('üìÖ Inicializando selectores de fecha');

    inicializarSelectorMes();
    inicializarSelectorAnio();
    inicializarSelectorQuincena();
    seleccionarPeriodoActual();
  }

  function inicializarSelectorMes() {
    const mesInput = getElement('mes');
    if (!mesInput) return;

    const meses = [
      { valor: 1, nombre: "Enero" },
      { valor: 2, nombre: "Febrero" },
      { valor: 3, nombre: "Marzo" },
      { valor: 4, nombre: "Abril" },
      { valor: 5, nombre: "Mayo" },
      { valor: 6, nombre: "Junio" },
      { valor: 7, nombre: "Julio" },
      { valor: 8, nombre: "Agosto" },
      { valor: 9, nombre: "Septiembre" },
      { valor: 10, nombre: "Octubre" },
      { valor: 11, nombre: "Noviembre" },
      { valor: 12, nombre: "Diciembre" }
    ];

    mesInput.innerHTML = '<option disabled value="">Seleccione un mes</option>';
    meses.forEach(mes => {
      const option = document.createElement('option');
      option.value = mes.valor;
      option.textContent = mes.nombre;
      mesInput.appendChild(option);
    });
  }

  function inicializarSelectorAnio() {
    const anioInput = getElement('anio');
    if (!anioInput) return;

    const anioActual = new Date().getFullYear();
    const anioInicio = 2020;
    const anioFin = anioActual + 1;

    anioInput.innerHTML = '<option disabled value="">Seleccione un a√±o</option>';

    for (let anio = anioFin; anio >= anioInicio; anio--) {
      const option = document.createElement('option');
      option.value = anio;
      option.textContent = anio;
      anioInput.appendChild(option);
    }
  }

  function inicializarSelectorQuincena() {
    const quincenaInput = getElement('quincena');
    if (!quincenaInput) return;

    const opciones = [
      { valor: "1-15", nombre: "Primera Quincena (1-15)", descripcion: "Del d√≠a 1 al 15 del mes" },
      { valor: "16-31", nombre: "Segunda Quincena (16-31)", descripcion: "Del d√≠a 16 al √∫ltimo d√≠a del mes" },
      { valor: "completo", nombre: "Mes Completo", descripcion: "Todo el mes seleccionado" }
    ];

    quincenaInput.innerHTML = '<option disabled value="">Seleccione una quincena</option>';
    opciones.forEach(opcion => {
      const option = document.createElement('option');
      option.value = opcion.valor;
      option.textContent = opcion.nombre;
      option.title = opcion.descripcion;
      quincenaInput.appendChild(option);
    });
  }

  function seleccionarPeriodoActual() {
    const fechaActual = new Date();
    const mesActual = fechaActual.getMonth() + 1;
    const anioActual = fechaActual.getFullYear();
    const diaActual = fechaActual.getDate();

    // Seleccionar valores actuales
    const mesInput = getElement('mes');
    const anioInput = getElement('anio');
    const quincenaInput = getElement('quincena');

    if (mesInput) mesInput.value = mesActual.toString();
    if (anioInput) anioInput.value = anioActual.toString();

    if (quincenaInput) {
      const quincenaActual = diaActual <= 15 ? '1-15' : '16-31';
      quincenaInput.value = quincenaActual;
    }

    // Actualizar descripci√≥n
    actualizarDescripcionSeleccion();
  }

  // ================== FUNCIONES DE UI Y DESCRIPCI√ìN ==================
  function actualizarDescripcionSeleccion() {
    const descripcionElement = getElement('descripcionSeleccion');
    if (descripcionElement) {
      const descripcion = obtenerDescripcionSeleccionActual();
      descripcionElement.textContent = descripcion;
    }
  }

  function obtenerDescripcionSeleccionActual() {
    const mes = getElement('mes')?.value;
    const anio = getElement('anio')?.value;
    const quincena = getElement('quincena')?.value;

    if (!mes || !anio || !quincena) {
      return "Ninguna - Complete todos los campos";
    }

    const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
      "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    const nombreMes = meses[parseInt(mes) - 1];

    let descripcionQuincena;
    switch (quincena) {
      case "1-15":
        descripcionQuincena = "Primera quincena (1-15)";
        break;
      case "16-31":
        descripcionQuincena = "Segunda quincena (16-31)";
        break;
      case "completo":
        descripcionQuincena = "Mes completo";
        break;
      default:
        descripcionQuincena = quincena;
    }

    return `${nombreMes} ${anio} - ${descripcionQuincena}`;
  }

  // ================== CARGA DE EMAIL PERSONAL ==================
  function cargarEmailPersonal() {
    const selectedPersonal = getElement('doctor')?.value;

    if (!selectedPersonal) {
      mostrarMensaje("Por favor, seleccione un personal primero.", "error");
      return;
    }

    console.log('üìß Cargando email para:', selectedPersonal);

    google.script.run
      .withSuccessHandler(function (email) {
        const emailInput = getElement('emailRecipient');
        if (emailInput) {
          emailInput.value = email || '';
        }
        console.log('‚úÖ Email cargado:', email);
      })
      .withFailureHandler(function (error) {
        console.error('‚ùå Error al cargar email:', error);
        mostrarMensaje(`‚ùå Error al cargar email: ${error.message}`, "error");
      })
      .obtenerEmailParaPersonal(selectedPersonal);
  }

  // ================== GENERACI√ìN DE TABLAS Y REPORTE ==================
  function generarTablaHtml(titulo, data, totalSubtotalDia, totalIVADia, totalConIVADia) {
    let html = `
      <h3>${titulo}</h3>
      <table>
        <tr>
          <th>Tipo de procedimiento</th>
          <th>Cantidad</th>
          <th>Costo por procedimiento individual</th>
          <th>Ganancia sin IVA</th>
          <th>IVA (4%)</th>
          <th>Ganancia con IVA</th>
        </tr>
    `;

    let hasData = false;
    for (const key in data) {
      const r = data[key];
      if (r.cantidad > 0) {
        hasData = true;
        html += `
          <tr>
            <td class="text-left">${r.nombre}</td>
            <td>${r.cantidad}</td>
            <td>‚Ç°${formatearMoneda(r.costo_unitario)}</td>
            <td>‚Ç°${formatearMoneda(r.subtotal)}</td>
            <td>‚Ç°${formatearMoneda(r.iva)}</td>
            <td>‚Ç°${formatearMoneda(r.total_con_iva)}</td>
          </tr>
        `;
      }
    }

    if (!hasData) {
      html += `<tr><td colspan="6">No hay registros para este per√≠odo.</td></tr>`;
    } else {
      html += `
        <tr class="subtotal-row">
          <td class="text-left">Subtotal ${titulo}</td>
          <td>-</td>
          <td>-</td>
          <td>‚Ç°${formatearMoneda(totalSubtotalDia)}</td>
          <td>‚Ç°${formatearMoneda(totalIVADia)}</td>
          <td>‚Ç°${formatearMoneda(totalConIVADia)}</td>
        </tr>
      `;
    }
    html += '</table>';
    return html;
  }

  function calcular() {
    console.log('üîÑ Iniciando c√°lculo de costos...');

    // Obtener valores de los campos
    const doctor = getElement('doctor')?.value;
    const mes = getElement('mes')?.value;
    const anio = getElement('anio')?.value;
    const quincena = getElement('quincena')?.value;

    console.log('üìä Par√°metros de c√°lculo:', { doctor, mes, anio, quincena });

    // Validar entradas
    if (!validarEntradas(doctor, mes, anio, quincena)) {
      return;
    }

    // Mostrar indicadores de carga
    mostrarIndicadorCarga(true);
    mostrarMensaje(`üîç Calculando costos para ${doctor}...`, "info");

    // Limpiar resultados anteriores
    const divResultado = getElement('resultado');
    if (divResultado) {
      divResultado.innerHTML = '<p>üîÑ Procesando datos...</p>';
    }

    // Timeout de seguridad
    const timeoutId = setTimeout(() => {
      mostrarMensaje("‚è∞ El c√°lculo est√° tomando m√°s tiempo del esperado...", "warning");
    }, 15000);

    // Llamada al servidor
    google.script.run
      .withSuccessHandler(function (resumen) {
        clearTimeout(timeoutId);
        mostrarIndicadorCarga(false);
        procesarResultadoCalculo(resumen, doctor, mes, anio, quincena);
      })
      .withFailureHandler(function (error) {
        clearTimeout(timeoutId);
        mostrarIndicadorCarga(false);
        manejarErrorCalculo(error, doctor);
      })
      .calcularCostos(doctor, parseInt(mes), parseInt(anio), quincena);
  }

  function procesarResultadoCalculo(resumen, doctor, mes, anio, quincena) {
    console.log('‚úÖ Resultado de c√°lculo recibido:', resumen);

    // Validar estructura de respuesta
    if (!resumen || !resumen.totales) {
      mostrarMensaje("‚ùå Datos recibidos inv√°lidos del servidor.", "error");
      return;
    }

    // Verificar si hay datos
    if (resumen.totales.subtotal === 0) {
      mostrarResultadoVacio(doctor);
      return;
    }

    // Generar HTML del reporte
    const htmlResultado = generarHTMLReporte(resumen);

    // Mostrar resultado
    const divResultado = getElement('resultado');
    if (divResultado) {
      divResultado.innerHTML = htmlResultado;
    }

    // Actualizar totales y configurar la secci√≥n de acciones
    mostrarTotalesReporte(resumen.totales.subtotal, resumen.totales.total_con_iva);
    configurarSeccionAcciones(doctor, mes, anio, quincena);

    mostrarMensaje("‚úÖ Reporte generado exitosamente.", "success");
  }

  function generarHTMLReporte(resumen) {
    const resumenLV = resumen.lv || {};
    const resumenSab = resumen.sab || {};

    // Calcular totales por categor√≠a
    let totalSubtotalLV = 0, totalIVALV = 0, totalConIVALV = 0;
    let totalSubtotalSab = 0, totalIVASab = 0, totalConIVASab = 0;

    Object.values(resumenLV).forEach(item => {
      if (item) {
        totalSubtotalLV += item.subtotal || 0;
        totalIVALV += item.iva || 0;
        totalConIVALV += item.total_con_iva || 0;
      }
    });

    Object.values(resumenSab).forEach(item => {
      if (item) {
        totalSubtotalSab += item.subtotal || 0;
        totalIVASab += item.iva || 0;
        totalConIVASab += item.total_con_iva || 0;
      }
    });

    // Generar HTML de las tablas
    let html = '';
    html += generarTablaHtml("Reporte de Lunes a Viernes", resumenLV, totalSubtotalLV, totalIVALV, totalConIVALV);
    html += generarTablaHtml("Reporte de S√°bados", resumenSab, totalSubtotalSab, totalIVASab, totalConIVASab);

    return html;
  }

  function mostrarResultadoVacio(doctor) {
    const divResultado = getElement('resultado');
    if (divResultado) {
      divResultado.innerHTML = `
        <div class="no-data">
          <p>üìã No se encontraron procedimientos registrados para <strong>${doctor}</strong> en el per√≠odo seleccionado.</p>
          <p>üí° Sugerencias:</p>
          <ul>
            <li>Verificar que el personal est√© correctamente registrado</li>
            <li>Revisar las fechas seleccionadas</li>
            <li>Confirmar que existan registros para este per√≠odo</li>
          </ul>
        </div>
      `;
    }
    mostrarMensaje(`‚ö†Ô∏è No hay procedimientos registrados para ${doctor} en este per√≠odo.`, "warning");
  }

  function configurarSeccionAcciones(doctor, mes, anio, quincena) {
    // Configurar t√≠tulo del reporte
    const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
      "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    const selectedMonthName = monthNames[parseInt(mes) - 1];
    const quincenaText = quincena === 'completo' ? 'Mes Completo' : `Quincena ${quincena}`;

    const reportTitle = getElement('reportTitle');
    if (reportTitle) {
      reportTitle.textContent = `Reporte de Procedimientos y Consultas - ${doctor} - ${selectedMonthName} ${anio} (${quincenaText})`;
    }

    // Mostrar secci√≥n de acciones
    const actionSection = getElement('action-section');
    if (actionSection) {
      actionSection.style.display = 'block';
    }

    // Limpiar mensajes de email
    const emailMessage = getElement('emailMessage');
    if (emailMessage) {
      emailMessage.textContent = '';
    }
  }

  function manejarErrorCalculo(error, doctor) {
    console.error('=== ERROR EN C√ÅLCULO ===');
    console.error('Error completo:', error);

    let mensajeError = `‚ùå Error al calcular costos para ${doctor}: `;
    mensajeError += error.message || "Error desconocido";

    mostrarMensaje(mensajeError, "error");

    const divResultado = getElement('resultado');
    if (divResultado) {
      divResultado.innerHTML = `
        <div class="error-message">
          <p>‚ùå Error al procesar los datos</p>
          <p>Por favor, intente nuevamente o contacte al administrador.</p>
          <details>
            <summary>Detalles del error</summary>
            <pre>${error.message || 'Error desconocido'}</pre>
          </details>
        </div>
      `;
    }
  }

  // ================== DESCUENTO, EXTRA Y MOTIVO ==================
  function mostrarTotalesReporte(subtotal, totalConIVA) {
    subtotalGlobal = subtotal || 0;
    totalConIVAGlobal = totalConIVA || 0;

    console.log('üí∞ Totales actualizados:', { subtotalGlobal, totalConIVAGlobal });

    const subtotalOriginal = getElement('subtotalOriginal');
    const granTotal = getElement('granTotal');

    if (subtotalOriginal) subtotalOriginal.textContent = formatearMoneda(subtotalGlobal);
    if (granTotal) granTotal.textContent = formatearMoneda(totalConIVAGlobal);

    actualizarDescuentoYExtra();
  }

  function actualizarDescuentoYExtra() {
    const montoDescontarInput = getElement('montoDescontar');
    const motivoDescuentoInput = getElement('motivoDescuento');
    const montoExtraInput = getElement('montoExtra');

    if (!montoDescontarInput || !motivoDescuentoInput || !montoExtraInput) return;

    const montoDescontar = Number(montoDescontarInput.value) || 0;
    const montoExtra = Number(montoExtraInput.value) || 0;
    const motivo = motivoDescuentoInput.value.trim();

    // Validaciones
    if (montoDescontar < 0 || montoExtra < 0) {
      mostrarMensaje("Los montos no pueden ser negativos.", "error");
      return;
    }

    if (montoDescontar > subtotalGlobal) {
      mostrarMensaje("El descuento no puede ser mayor que el subtotal.", "error");
      return;
    }

    // Calcular nuevos totales
    const subtotalConDescuento = subtotalGlobal - montoDescontar + montoExtra;
    const granTotalFinal = totalConIVAGlobal - montoDescontar + montoExtra;

    // Actualizar UI
    const subtotalConDescuentoEl = getElement('subtotalConDescuento');
    const granTotalEl = getElement('granTotal');

    if (subtotalConDescuentoEl) {
      subtotalConDescuentoEl.textContent = formatearMoneda(subtotalConDescuento);
    }
    if (granTotalEl) {
      granTotalEl.textContent = formatearMoneda(granTotalFinal);
    }

    // Actualizar comentario
    actualizarComentarioDescuento(montoDescontar, montoExtra, motivo);
  }

  function actualizarComentarioDescuento(montoDescontar, montoExtra, motivo) {
    let comentario = '';

    if (montoDescontar > 0) {
      comentario += `Descuento: ‚Ç°${formatearMoneda(montoDescontar)}`;
      if (motivo) comentario += ` (${motivo})`;
    }

    if (montoExtra > 0) {
      if (comentario) comentario += ' | ';
      comentario += `Extra: ‚Ç°${formatearMoneda(montoExtra)}`;
      if (motivo) comentario += ` (${motivo})`;
    }

    const comentarioEl = getElement('comentarioDescuento');
    if (comentarioEl) {
      comentarioEl.textContent = comentario;
    }

    // Actualizar elementos para PDF
    actualizarElementosPDF(montoDescontar, montoExtra, motivo);
  }

  function actualizarElementosPDF(montoDescontar, montoExtra, motivo) {
    const elementos = {
      'montoDescontarTexto': montoDescontar > 0 ? `Descuento: ‚Ç°${formatearMoneda(montoDescontar)}` : '',
      'montoExtraTexto': montoExtra > 0 ? `Extra: ‚Ç°${formatearMoneda(montoExtra)}` : '',
      'motivoDescuentoTexto': motivo ? `Motivo: ${motivo}` : ''
    };

    Object.entries(elementos).forEach(([id, texto]) => {
      const elemento = getElement(id);
      if (elemento) {
        elemento.textContent = texto;
      }
    });
  }

  // ================== VALIDACIONES ==================
  function validarEntradas(doctor, mes, anio, quincena) {
    console.log('üîç Validando entradas:', { doctor, mes, anio, quincena });

    if (!doctor || doctor.trim() === '') {
      mostrarMensaje("Por favor, seleccione un personal.", "error");
      return false;
    }

    const anioNum = parseInt(anio);
    const currentYear = new Date().getFullYear();
    if (isNaN(anioNum) || anioNum < 2020 || anioNum > currentYear + 1) {
      mostrarMensaje(`Por favor, seleccione un a√±o v√°lido (2020 - ${currentYear + 1}).`, "error");
      return false;
    }

    const mesNum = parseInt(mes);
    if (isNaN(mesNum) || mesNum < 1 || mesNum > 12) {
      mostrarMensaje("Por favor, seleccione un mes v√°lido.", "error");
      return false;
    }

    if (!quincena || !['1-15', '16-31', 'completo'].includes(quincena)) {
      mostrarMensaje("Por favor, seleccione una quincena v√°lida.", "error");
      return false;
    }

    console.log('‚úÖ Validaci√≥n exitosa');
    return true;
  }

  function validarEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }

  // ================== ENV√çO Y DESCARGA DE PDF ==================
  function enviarReporteCostos() {
    const emailRecipient = getElement('emailRecipient')?.value;
    const doctor = getElement('doctor')?.value;
    const mes = getElement('mes')?.value;
    const anio = getElement('anio')?.value;
    const quincena = getElement('quincena')?.value;

    if (!validarEmail(emailRecipient)) {
      mostrarEmailMensaje("Por favor, ingrese un email v√°lido.", "error");
      return;
    }

    mostrarEmailMensaje("üìß Enviando reporte...", "info");
    prepararParaPDF();

    const reportContent = getElement('printableReportContent')?.innerHTML;
    const subject = generarAsuntoEmail(doctor, mes, anio, quincena);
    const fileName = generarNombreArchivo(doctor, mes, anio, quincena);

    google.script.run
      .withSuccessHandler(response => {
        restaurarInputsPDF();
        mostrarEmailMensaje(
          response.message,
          response.success ? "success" : "error"
        );
      })
      .withFailureHandler(error => {
        restaurarInputsPDF();
        mostrarEmailMensaje(`‚ùå Error al enviar: ${error.message}`, "error");
      })
      .enviarReporteCostos(reportContent, emailRecipient, subject, fileName);
  }

  function descargarReporteCostosPDF() {
    const doctor = getElement('doctor')?.value;
    const mes = getElement('mes')?.value;
    const anio = getElement('anio')?.value;
    const quincena = getElement('quincena')?.value;

    mostrarEmailMensaje("üìÑ Generando PDF...", "info");
    prepararParaPDF();

    const reportContent = getElement('printableReportContent')?.innerHTML;
    const fileName = generarNombreArchivo(doctor, mes, anio, quincena);
    const pageTitle = generarTituloReporte(doctor, mes, anio);

    google.script.run
      .withSuccessHandler(function (base64Pdf) {
        restaurarInputsPDF();
        if (base64Pdf) {
          descargarArchivoPDF(base64Pdf, fileName);
          mostrarEmailMensaje("‚úÖ PDF descargado exitosamente.", "success");
        } else {
          mostrarEmailMensaje("‚ùå Error al generar el PDF.", "error");
        }
      })
      .withFailureHandler(function (error) {
        restaurarInputsPDF();
        mostrarEmailMensaje(`‚ùå Error al generar PDF: ${error.message}`, "error");
      })
      .generarPdfParaDescarga(reportContent, fileName, 'stylesReportePagoProcedimientos', pageTitle);
  }

  function generarAsuntoEmail(doctor, mes, anio, quincena) {
    const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
      "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    const selectedMonthName = monthNames[parseInt(mes) - 1];
    const quincenaText = quincena === 'completo' ? 'Mes Completo' : `Quincena ${quincena}`;

    return `Reporte de Procedimientos - ${doctor} - ${selectedMonthName} ${anio} (${quincenaText})`;
  }

  function generarNombreArchivo(doctor, mes, anio, quincena) {
    const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
      "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    const selectedMonthName = monthNames[parseInt(mes) - 1];
    const doctorLimpio = doctor.replace(/\s+/g, '_');
    const quincenaLimpia = quincena.replace('-', '_');

    return `Reporte_Procedimientos_${doctorLimpio}_${selectedMonthName}_${anio}_${quincenaLimpia}.pdf`;
  }

  function generarTituloReporte(doctor, mes, anio) {
    const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
      "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    const selectedMonthName = monthNames[parseInt(mes) - 1];

    return `Reporte de Procedimientos - ${doctor} - ${selectedMonthName} ${anio}`;
  }

  function descargarArchivoPDF(base64Data, fileName) {
    try {
      const blob = b64toBlob(base64Data, 'application/pdf');
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    } catch (error) {
      console.error('‚ùå Error al descargar PDF:', error);
      mostrarEmailMensaje("‚ùå Error al descargar el archivo.", "error");
    }
  }

  function b64toBlob(b64Data, contentType = '', sliceSize = 512) {
    const byteCharacters = atob(b64Data);
    const byteArrays = [];

    for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
      const slice = byteCharacters.slice(offset, offset + sliceSize);
      const byteNumbers = new Array(slice.length);
      for (let i = 0; i < slice.length; i++) {
        byteNumbers[i] = slice.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      byteArrays.push(byteArray);
    }

    return new Blob(byteArrays, { type: contentType });
  }

  // ================== FUNCIONES DE UTILIDAD PARA PDF ==================
  function prepararParaPDF() {
    const elementsToHide = document.querySelectorAll('.no-print, .btn, .form-group, #reportControls');
    elementsToHide.forEach(el => {
      if (el) {
        el.style.display = 'none';
        el.setAttribute('data-was-visible', 'true');
      }
    });

    document.body.classList.add('pdf-mode');
  }

  function restaurarInputsPDF() {
    const elementsToShow = document.querySelectorAll('[data-was-visible="true"]');
    elementsToShow.forEach(el => {
      el.style.display = '';
      el.removeAttribute('data-was-visible');
    });

    document.body.classList.remove('pdf-mode');
  }

  // ================== MENSAJES Y UI ==================
  function mostrarEmailMensaje(mensaje, tipo) {
    mostrarMensajeEnElemento('emailMessage', mensaje, tipo, 'action-section');
  }

  function mostrarMensaje(mensaje, tipo) {
    mostrarMensajeEnElemento('formMessage', mensaje, tipo, 'reportControls');
  }

  function mostrarMensajeEnElemento(elementId, mensaje, tipo, contenedorId) {
    let mensajeDiv = getElement(elementId);

    if (!mensajeDiv) {
      mensajeDiv = document.createElement('div');
      mensajeDiv.id = elementId;

      const contenedor = getElement(contenedorId);
      if (contenedor) {
        contenedor.prepend(mensajeDiv);
      } else {
        document.body.prepend(mensajeDiv);
      }
    }

    // Limpiar clases anteriores
    mensajeDiv.className = '';
    mensajeDiv.textContent = mensaje;

    // Aplicar clase seg√∫n tipo
    const clases = {
      'success': 'alert-success',
      'error': 'alert-error',
      'info': 'alert-info',
      'warning': 'alert-warning'
    };

    if (clases[tipo]) {
      mensajeDiv.classList.add(clases[tipo]);
    }

    // Auto-limpiar (excepto errores)
    if (tipo !== 'error') {
      const tiempo = tipo === 'success' ? 3000 : 5000;
      setTimeout(() => {
        mensajeDiv.textContent = '';
        mensajeDiv.className = '';
      }, tiempo);
    }
  }

  function mostrarIndicadorCarga(mostrar) {
    const indicador = getElement('loadingIndicator');
    if (indicador) {
      indicador.style.display = mostrar ? 'flex' : 'none';
    }
  }

  // ================== CACHE DE ELEMENTOS DOM ==================
  function getElement(id) {
    if (!cachedElements[id]) {
      cachedElements[id] = document.getElementById(id);
    }
    return cachedElements[id];
  }

  function formatearMoneda(cantidad) {
    if (typeof cantidad !== 'number' || isNaN(cantidad)) {
      return '0.00';
    }
    return cantidad.toLocaleString('es-CR', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  }

  // ================== FUNCIONES DE UTILIDAD ADICIONALES ==================

  function actualizarSelectoresFecha() {
    inicializarSelectoresFecha();
    mostrarMensaje("‚úÖ Selectores de fecha actualizados.", "success");
  }

  function validarSeleccionFecha() {
    const mes = getElement('mes')?.value;
    const anio = getElement('anio')?.value;
    const quincena = getElement('quincena')?.value;

    let mensaje = "VALIDACI√ìN DE SELECCI√ìN DE FECHA:\n\n";
    mensaje += `Mes: ${mes ? '‚úÖ ' + mes : '‚ùå No seleccionado'}\n`;
    mensaje += `A√±o: ${anio ? '‚úÖ ' + anio : '‚ùå No seleccionado'}\n`;
    mensaje += `Quincena: ${quincena ? '‚úÖ ' + quincena : '‚ùå No seleccionado'}\n\n`;

    if (mes && anio && quincena) {
      mensaje += `‚úÖ Selecci√≥n v√°lida: ${obtenerDescripcionSeleccionActual()}`;
      mostrarMensaje("‚úÖ Selecci√≥n de fecha v√°lida.", "success");
    } else {
      mensaje += "‚ùå Selecci√≥n incompleta. Complete todos los campos.";
      mostrarMensaje("‚ö†Ô∏è Complete todos los campos de fecha.", "warning");
    }

    alert(mensaje);
  }

  function mostrarLogConsola() {
    const estado = {
      doctor: getElement('doctor')?.value,
      mes: getElement('mes')?.value,
      anio: getElement('anio')?.value,
      quincena: getElement('quincena')?.value,
      descripcion: obtenerDescripcionSeleccionActual(),
      totales: { subtotalGlobal, totalConIVAGlobal }
    };

    console.log('=== ESTADO ACTUAL DEL SISTEMA ===');
    console.log(estado);
    mostrarMensaje("üìã Estado mostrado en la consola del navegador (F12).", "info");
  }

  function mostrarAyudaFechas() {
    const ayuda = `AYUDA PARA SELECCI√ìN DE FECHAS:

üìÖ MES: Seleccione el mes del cual desea generar el reporte.

üìÜ A√ëO: A√±os disponibles desde 2020 hasta ${new Date().getFullYear() + 1}.

üóìÔ∏è QUINCENA:
‚Ä¢ Primera Quincena (1-15): Incluye del d√≠a 1 al 15 del mes
‚Ä¢ Segunda Quincena (16-31): Incluye del d√≠a 16 al √∫ltimo d√≠a del mes  
‚Ä¢ Mes Completo: Incluye todos los d√≠as del mes seleccionado

üí° CONSEJO: 
- El sistema selecciona autom√°ticamente el per√≠odo actual
- Use "üîÑ Actualizar Fechas" si los selectores no cargan correctamente`;

    alert(ayuda);
  }

  // ================== FUNCIONES DE DIAGN√ìSTICO ==================

  function diagnosticarCalculo() {
    const doctor = getElement('doctor')?.value;

    if (!doctor) {
      mostrarMensaje("Por favor, seleccione un doctor primero.", "error");
      return;
    }

    mostrarMensaje("üîç Ejecutando diagn√≥stico...", "info");

    google.script.run
      .withSuccessHandler(function (resultado) {
        console.log('=== DIAGN√ìSTICO COMPLETO ===', resultado);

        let mensaje = `DIAGN√ìSTICO PARA "${resultado.nombreBuscado}":\n\n`;
        mensaje += `Total registros: ${resultado.totalRegistros}\n`;
        if (resultado.registrosValidosFecha !== undefined) {
          mensaje += `Registros v√°lidos: ${resultado.registrosValidosFecha}\n`;
          mensaje += `Registros inv√°lidos: ${resultado.registrosInvalidosFecha}\n`;
        }
        if (resultado.primerRegistro) {
          mensaje += `Primer registro: ${resultado.primerRegistro}\n`;
          mensaje += `√öltimo registro: ${resultado.ultimoRegistro}\n`;
        }

        alert(mensaje);
        mostrarMensaje("‚úÖ Diagn√≥stico completado.", "success");
      })
      .withFailureHandler(function (error) {
        console.error('Error en diagn√≥stico:', error);
        mostrarMensaje(`‚ùå Error en diagn√≥stico: ${error.message}`, "error");
      })
      .diagnosticarFechasPersonal(doctor);
  }

  function buscarPersonalPorNombre() {
    const nombreBuscar = prompt("Ingrese el nombre (o parte del nombre) a buscar:");
    if (!nombreBuscar || nombreBuscar.trim() === '') {
      mostrarMensaje("B√∫squeda cancelada.", "info");
      return;
    }

    mostrarMensaje(`üîç Buscando '${nombreBuscar}'...`, "info");

    google.script.run
      .withSuccessHandler(function (resultados) {
        console.log('Resultados de b√∫squeda:', resultados);

        let mensaje = `RESULTADOS PARA "${nombreBuscar}":\n\n`;
        if (resultados.coincidenciasExactas.length > 0) {
          mensaje += "COINCIDENCIAS EXACTAS:\n";
          resultados.coincidenciasExactas.forEach((nombre, index) => {
            mensaje += `${index + 1}. ${nombre}\n`;
          });
          mensaje += "\n";
        }

        if (resultados.coincidenciasParciales.length > 0) {
          mensaje += "COINCIDENCIAS PARCIALES:\n";
          resultados.coincidenciasParciales.forEach((nombre, index) => {
            mensaje += `${index + 1}. ${nombre}\n`;
          });
        }

        if (resultados.coincidenciasExactas.length === 0 && resultados.coincidenciasParciales.length === 0) {
          mensaje += "No se encontraron coincidencias.";
        }

        alert(mensaje);
        mostrarMensaje("‚úÖ B√∫squeda completada.", "success");
      })
      .withFailureHandler(function (error) {
        console.error('Error en b√∫squeda:', error);
        mostrarMensaje(`‚ùå Error en b√∫squeda: ${error.message}`, "error");
      })
      .buscarPersonalPorNombre(nombreBuscar);
  }

  function verificarDatosPersonal() {
    const doctor = getElement('doctor')?.value;

    if (!doctor) {
      mostrarMensaje("Por favor, seleccione un personal primero.", "error");
      return;
    }

    mostrarMensaje(`üîç Verificando datos para ${doctor}...`, "info");

    google.script.run
      .withSuccessHandler(function (resultado) {
        console.log('Verificaci√≥n de datos:', resultado);
        let mensaje = `Datos para ${doctor}:\n`;
        mensaje += `- Total registros: ${resultado.totalRegistros || 0}\n`;
        mensaje += `- Rango fechas: ${resultado.fechaInicio || 'N/A'} - ${resultado.fechaFin || 'N/A'}\n`;
        mensaje += `- Tipos procedimientos: ${resultado.tiposProcedimientos || 0}`;

        alert(mensaje);
        mostrarMensaje("‚úÖ Verificaci√≥n completada.", "success");
      })
      .withFailureHandler(function (error) {
        console.error('Error en verificaci√≥n:', error);
        mostrarMensaje(`‚ùå Error: ${error.message}`, "error");
      })
      .verificarDatosPersonal(doctor);
  }

  function listarPersonalDisponible() {
    mostrarMensaje("üîç Obteniendo lista completa...", "info");

    google.script.run
      .withSuccessHandler(function (personalCompleto) {
        console.log('Personal completo:', personalCompleto);
        let mensaje = "PERSONAL DISPONIBLE:\n";
        personalCompleto.forEach((nombre, index) => {
          mensaje += `${index + 1}. ${nombre}\n`;
        });

        alert(mensaje);
        mostrarMensaje("‚úÖ Lista obtenida.", "success");
      })
      .withFailureHandler(function (error) {
        console.error('Error al obtener personal:', error);
        mostrarMensaje(`‚ùå Error: ${error.message}`, "error");
      })
      .obtenerPersonalCompleto();
  }

</script>