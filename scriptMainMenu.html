<script>
  // Función para navegar a diferentes "páginas" de la aplicación web
  function navigateTo(pageName) {
    try {
      const isDevEnvironment = window.location.href.includes('userCodeAppPanel');

      if (isDevEnvironment) {
        // Mostrar mensaje de carga usando clases CSS
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'loading-overlay';
        loadingDiv.innerHTML = '<div class="loading-message">Cargando página...</div>';
        document.body.appendChild(loadingDiv);

        // Si la página solicitada es el comprobante y estamos dentro de Sheets
        if (pageName === 'comprobante') {
          // Intentar abrir como modal en Sheets; si el servidor devuelve HTML
          // (porque no está en un contexto de Spreadsheet), lo escribimos.
          google.script.run
            .withSuccessHandler(function (result) {
              try {
                if (result && typeof result === 'string') {
                  // El servidor devolvió HTML (fallback) -> reemplazar la página
                  document.open();
                  document.write(result);
                  document.close();
                }
              } finally {
                if (loadingDiv && loadingDiv.parentNode) document.body.removeChild(loadingDiv);
              }
            })
            .withFailureHandler(function (error) {
              console.error('ERROR (Client): Error al abrir comprobante en modal:', error);
              alert('Error al abrir el comprobante: ' + (error && error.message ? error.message : error));
              if (loadingDiv && loadingDiv.parentNode) document.body.removeChild(loadingDiv);
            })
            .mostrarComprobante();
        } else {
          google.script.run
            .withSuccessHandler(function (html) {
              document.open();
              document.write(html);
              document.close();
            })
            .withFailureHandler(function (error) {
              console.error('ERROR (Client): Error al cargar la página:', error);
              alert('Error al cargar la página: ' + (error && error.message ? error.message : error));
              document.body.removeChild(loadingDiv);
            })
            .getPageHtml(pageName);
        }
      } else {
        const baseUrl = window.location.origin + window.location.pathname;
        const newUrl = `${baseUrl}?page=${pageName}`;
        console.log('DEBUG (Client): Intentando navegar a:', newUrl);
        window.top.location.href = newUrl;
      }
    } catch (error) {
      console.error('ERROR (Client): Se produjo un error al intentar navegar:', error);
      alert('Se produjo un error al intentar navegar: ' + error.message + '. Revise la consola del navegador.');
    }
  }
</script>