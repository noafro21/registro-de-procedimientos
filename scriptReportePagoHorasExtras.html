<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Establecer la fecha actual por defecto
    const today = new Date();
    document.getElementById('mes').value = today.getMonth() + 1;
    document.getElementById('anio').value = today.getFullYear();
    document.getElementById('quincena').value = 'completo';

    // Cargar solo personal de horas extras (Enfermero y Secretaria)
    google.script.run
      .withSuccessHandler(function (personalList) {
        const select = document.getElementById('trabajador');
        select.innerHTML = '<option disabled selected value="">Seleccione trabajador...</option>';
        personalList.forEach(nombre => {
          const option = document.createElement('option');
          option.value = nombre;
          option.textContent = nombre;
          select.appendChild(option);
        });
        // Añadir el listener para precargar el email
        select.addEventListener('change', cargarEmailPersonal);
      })
      .obtenerPersonalFiltrado([4, 5]);
  });

  function cargarEmailPersonal() {
    const selectedPersonal = document.getElementById('trabajador').value;
    google.script.run
      .withSuccessHandler(function (email) {
        document.getElementById('emailRecipient').value = email;
      })
      .obtenerEmailParaPersonal(selectedPersonal);
  }

  function calcularHorasExtras() {
    const trabajador = document.getElementById('trabajador').value;
    const mes = parseInt(document.getElementById('mes').value);
    const anio = parseInt(document.getElementById('anio').value);
    const quincena = document.getElementById('quincena').value;

    if (!trabajador) {
      mostrarMensaje("Por favor, seleccione un trabajador.", "error");
      return;
    }

    google.script.run.withSuccessHandler(function (response) {
      const resumen = response.resumen;
      const totalHoras = response.totalHoras;
      const divResultado = document.getElementById('resultado');
      let html = `
        <h3>Horas Extras Registradas</h3>
        <table>
          <tr>
            <th>Fecha</th>
            <th>Trabajador</th>
            <th>Cantidad de Horas</th>
          </tr>
      `;

      let hasData = false;
      if (resumen.length > 0) {
        hasData = true;
        resumen.forEach(registro => {
          html += `
            <tr>
              <td>${registro.fecha}</td>
              <td style="text-align: left;">${registro.trabajador}</td>
              <td>${registro.cantidad_horas.toLocaleString('es-CR', { minimumFractionDigits: 1, maximumFractionDigits: 1 })}</td>
            </tr>
          `;
        });
      }

      if (!hasData) {
        html += `<tr><td colspan="3">No hay registros de horas extras para este período.</td></tr>`;
      } else {
        html += `
              <tr class="grand-total-row">
                <td style="text-align: left;" colspan="2">TOTAL DE HORAS</td>
                <td>${totalHoras.toLocaleString('es-CR', { minimumFractionDigits: 1, maximumFractionDigits: 1 })}</td>
              </tr>
          `;
      }

      html += '</table>';
      divResultado.innerHTML = html;

      const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
      const selectedMonthName = monthNames[parseInt(mes) - 1];
      const quincenaText = quincena === 'completo' ? 'Mes Completo' : `Quincena ${quincena}`;

      document.getElementById('reportTitle').textContent = `Reporte de Horas Extras - ${trabajador} - ${selectedMonthName} ${anio} (${quincenaText})`;

      document.getElementById('action-section').style.display = 'block';
      document.getElementById('emailMessage').textContent = '';
    }).calcularReporteHorasExtras(trabajador, mes, anio, quincena);
  }

  function enviarReporteHorasExtras() {
    const emailRecipient = document.getElementById('emailRecipient').value;
    const trabajador = document.getElementById('trabajador').value;
    const mes = document.getElementById('mes').value;
    const anio = parseInt(document.getElementById('anio').value);
    const quincena = document.getElementById('quincena').value;

    if (!emailRecipient || !emailRecipient.includes('@')) {
      mostrarEmailMensaje("Por favor, ingrese un email válido.", "error");
      return;
    }

    const reportContent = document.getElementById('printableReportContent').innerHTML;
    const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    const selectedMonthName = monthNames[parseInt(mes) - 1];
    const quincenaText = quincena === 'completo' ? 'Mes Completo' : `Quincena ${quincena}`;
    const subject = `Reporte de Horas Extras - ${trabajador} - ${selectedMonthName} ${anio} (${quincenaText})`;
    const fileName = `Reporte_Horas_Extras_${trabajador.replace(/\s+/g, '_')}_${selectedMonthName}_${anio}_${quincena.replace('-', '_')}.pdf`;

    mostrarEmailMensaje("Enviando reporte...", "info");

    google.script.run
      .withSuccessHandler(response => {
        if (response.success) {
          mostrarEmailMensaje(response.message, "success");
        } else {
          mostrarEmailMensaje(response.message, "error");
        }
      })
      .withFailureHandler(error => {
        mostrarMensaje("❌ Error al enviar el reporte: " + error.message, "error");
      })
      .enviarReportePDF(reportContent, emailRecipient, subject, fileName);
  }

  function descargarReporteHorasExtrasPDF() {
    const trabajador = document.getElementById('trabajador').value;
    const mes = document.getElementById('mes').value;
    const anio = parseInt(document.getElementById('anio').value);
    const quincena = document.getElementById('quincena').value;

    if (!trabajador) {
      mostrarMensaje("Por favor, genere el reporte primero seleccionando un trabajador.", "error");
      return;
    }

    const reportContent = document.getElementById('printableReportContent').innerHTML;
    const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    const selectedMonthName = monthNames[parseInt(mes) - 1];
    const quincenaText = quincena === 'completo' ? 'Mes Completo' : `Quincena ${quincena}`;
    const fileName = `Reporte_Horas_Extras_${trabajador.replace(/\s+/g, '_')}_${selectedMonthName}_${anio}_${quincena.replace('-', '_')}.pdf`;

    mostrarEmailMensaje("Generando PDF para descarga...", "info");

    google.script.run
      .withSuccessHandler(function (base64Pdf) {
        if (base64Pdf) {
          const blob = b64toBlob(base64Pdf, 'application/pdf');
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          mostrarEmailMensaje("✅ Reporte descargado con éxito.", "success");
        } else {
          mostrarMensaje("❌ No se pudo generar el PDF para descarga.", "error");
        }
      })
      .withFailureHandler(function (error) {
        mostrarMensaje("❌ Error al descargar el PDF: " + error.message, "error");
      })
      .generarPdfParaDescarga(reportContent, fileName, 'stylesReportePagoHorasExtras');
  }

  function b64toBlob(b64Data, contentType = '', sliceSize = 512) {
    const byteCharacters = atob(b64Data);
    const byteArrays = [];
    for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
      const slice = byteCharacters.slice(offset, offset + sliceSize);
      const byteNumbers = new Array(slice.length);
      for (let i = 0; i < slice.length; i++) {
        byteNumbers[i] = slice.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      byteArrays.push(byteArray);
    }
    return new Blob(byteArrays, { type: contentType });
  }

  function mostrarEmailMensaje(mensaje, tipo) {
    let mensajeDiv = document.getElementById('emailMessage');
    if (!mensajeDiv) {
      mensajeDiv = document.createElement('div');
      mensajeDiv.id = 'emailMessage';
      document.getElementById('action-section').appendChild(mensajeDiv);
    }
    mensajeDiv.className = '';
    mensajeDiv.textContent = mensaje;
    if (tipo === 'success') {
      mensajeDiv.classList.add('alert-success');
    } else if (tipo === 'error') {
      mensajeDiv.classList.add('alert-error');
    } else if (tipo === 'info') {
      mensajeDiv.classList.add('alert-info');
    }
    if (tipo !== 'error') {
      setTimeout(() => {
        mensajeDiv.textContent = '';
        mensajeDiv.className = '';
      }, 5000);
    }
  }

  function mostrarMensaje(mensaje, tipo) {
    let mensajeDiv = document.getElementById('formMessage') || document.getElementById('emailMessage');
    if (!mensajeDiv) {
      mensajeDiv = document.createElement('div');
      mensajeDiv.id = 'formMessage';
      const controlsDiv = document.getElementById('reportControls');
      if (controlsDiv) {
        controlsDiv.prepend(mensajeDiv);
      } else {
        document.body.prepend(mensajeDiv);
      }
    }
    mensajeDiv.className = '';
    mensajeDiv.textContent = mensaje;
    if (tipo === 'success') {
      mensajeDiv.classList.add('alert-success');
    } else if (tipo === 'error') {
      mensajeDiv.classList.add('alert-error');
    } else if (tipo === 'info') {
      mensajeDiv.classList.add('alert-info');
    }
    if (tipo !== 'error') {
      setTimeout(() => {
        mensajeDiv.textContent = '';
        mensajeDiv.className = '';
      }, 3000);
    }
  }
</script>